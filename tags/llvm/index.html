<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Tag: llvm - SHAOJIE&#039;S BOOK</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="SHAOJIE&#039;S BOOK"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="SHAOJIE&#039;S BOOK"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="SHAOJIE&#039;S BOOK"><meta property="og:url" content="http://icarus.shaojiemike.top/"><meta property="og:site_name" content="SHAOJIE&#039;S BOOK"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://icarus.shaojiemike.top/img/og_image.png"><meta property="article:author" content="Shaojie Tan"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://icarus.shaojiemike.top/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://icarus.shaojiemike.top"},"headline":"SHAOJIE'S BOOK","image":["http://icarus.shaojiemike.top/img/og_image.png"],"author":{"@type":"Person","name":"Shaojie Tan"},"publisher":{"@type":"Organization","name":"SHAOJIE'S BOOK","logo":{"@type":"ImageObject","url":"http://icarus.shaojiemike.top/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="SHAOJIE&#039;S BOOK" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Kirrito-k423/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">llvm</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-07-25T16:00:00.000Z" title="7/25/2023, 4:00:00 PM">2023-07-25</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-01-28T14:04:36.264Z" title="1/28/2024, 2:04:36 PM">2024-01-28</time></span><span class="level-item"><a class="link-muted" href="/categories/Architecture/">Architecture</a></span><span class="level-item">15 minutes read (About 2206 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/07/25/Work/Programming/4-compile/llvm/">llvm</a></p><div class="content"><h2 id="llvm"><a href="#llvm" class="headerlink" title="llvm"></a>llvm</h2><p>LLVM项目开始于一种比Java字节码更低层级的IR，因此，初始的首字母缩略词是Low Level Virtual Machine。它的想法是发掘低层优化的机会，采用链接时优化。</p>
<p><img src="https://pic.shaojiemike.top/img/20230523164536.png"></p>
<h3 id="插一嘴：链接时优化"><a href="#插一嘴：链接时优化" class="headerlink" title="插一嘴：链接时优化"></a>插一嘴：链接时优化</h3><ul>
<li>GCC也支持链接时优化，称为LTO（Link Time Optimization），通过把多个编译单元中分别生成的目标文件在链接时进行全局的优化，可以提高程序的执行效率。</li>
<li>具体内容：大幅度减少可执行文件的体积<ul>
<li>冗余代码和变量&#x2F;函数的消除：对于在多个模块中出现的相同代码&#x2F;变量&#x2F;函数，链接时优化可以将它们合并，从而减少可执行文件的体积，提高程序的执行效率。</li>
<li>内联函数：将函数调用直接替换为函数本身的代码，从而减少函数调用的开销，提高程序的执行效率。</li>
<li>循环展开和向量化：内联函数后，或许能进一步将循环展开和向量化，从而减少循环体内的分支判断，优化程序的执行效率。</li>
</ul>
</li>
</ul>
<h3 id="IR：gcc与llvm的区别"><a href="#IR：gcc与llvm的区别" class="headerlink" title="IR：gcc与llvm的区别"></a>IR：gcc与llvm的区别</h3><p>学过编译原理的人都知道，编译过程主要可以划分为前端与后端：</p>
<ul>
<li>前端把源代码翻译成中间表示 (IR)。</li>
<li>后端把IR编译成目标平台的机器码。当然，IR也可以给解释器解释执行。</li>
</ul>
<p>经典的编译器如gcc：在设计上前端到后端编写是强耦合的，你不需要知道，无法知道，也没有API来操作它的IR。</p>
<ul>
<li><p>好处是：因为不需要暴露中间过程的接口，编译器可以在内部做任何想做的平台相关的优化。</p>
</li>
<li><p>坏处是，每当一个新的平台出现，这些编译器都要各自为政实现一个从自己的IR到新平台的后端。</p>
<ul>
<li>甚至如果当一种新语言出现，且需要实现一个新的编译器，那么可能需要设计一个新的IR，以及针对大部分平台实现这个IR的后端。</li>
<li>如果有M种语言、N种目标平台，那么最坏情况下要实现 M*N 个前后端。这是很低效的。</li>
</ul>
</li>
<li><p>LLVM的核心设计了一个叫 LLVM IR 的通用中间表示， 并以库(Library) 的方式提供一系列接口， 为你提供诸如操作IR、生成目标平台代码等等后端的功能。</p>
</li>
<li><p>在使用通用IR的情况下，如果有M种语言、N种目标平台，那么最优情况下我们只要实现 M+N 个前后端。</p>
</li>
</ul>
<h2 id="llvm-IR"><a href="#llvm-IR" class="headerlink" title="llvm IR"></a>llvm IR</h2><ul>
<li>LLVM IR 中间表示是适用于多种编程语言的通用中间表示，支持C、C++、Objective-C、Swift、Java、Python等多种编程语言。</li>
<li>它是一种低级别的语言，类似于汇编语言，但比汇编语言更高级，包含了类型、变量、函数、控制流等高级语言的特性。</li>
<li>LLVM编译器可以将多种编程语言编译成LLVM IR，从而可以在LLVM IR层面进行各种优化处理，再将LLVM IR转换为目标平台的机器码。<ul>
<li>比如要将Python脚本编译成LLVM IR中间表示，可以使用Python LLVM编译器llvmlite和numba。</li>
</ul>
</li>
</ul>
<h3 id="LLVM-IR表示与转换"><a href="#LLVM-IR表示与转换" class="headerlink" title="LLVM IR表示与转换"></a>LLVM IR表示与转换</h3><p>LVM IR实际上有三种表示：</p>
<ul>
<li>.ll 格式：人类可以阅读的文本。</li>
<li>.bc 格式：适合机器存储的二进制文件。</li>
<li>内存表示</li>
</ul>
<p>各种格式是如何生成并相互转换：</p>
<table>
<thead>
<tr>
<th>格式</th>
<th>转换命令</th>
</tr>
</thead>
<tbody><tr>
<td>.c -&gt; .ll</td>
<td>clang -emit-llvm -S a.c -o a.ll</td>
</tr>
<tr>
<td>.c -&gt; .bc</td>
<td>clang -emit-llvm -c a.c -o a.bc</td>
</tr>
<tr>
<td>.ll -&gt; .bc</td>
<td>llvm-as a.ll -o a.bc</td>
</tr>
<tr>
<td>.bc -&gt; .ll</td>
<td>llvm-dis a.bc -o a.ll</td>
</tr>
<tr>
<td>.bc -&gt; .s</td>
<td>llc a.bc -o a.s</td>
</tr>
</tbody></table>
<p>对于LLVM IR来说，<code>.ll</code>文件就相当于汇编，<code>.bc</code>文件就相当于机器码。 这也是llvm-as和llvm-dis指令为什么叫as和dis的缘故。</p>
<h2 id="llvm-前端"><a href="#llvm-前端" class="headerlink" title="llvm 前端"></a>llvm 前端</h2><p><img src="https://pic.shaojiemike.top/img/20230523162028.png" alt="前端"></p>
<p>clang实现的前端包括</p>
<ul>
<li>词法分析(识别标记)<ul>
<li>处理源代码的文本输入，将语言结构分解为一组单词和标记，去除注释、空白、制表符等。每个单词或者标记必须属于语言子集，语言的保留字被变换为编译器内部表示。</li>
<li>词法分析报错的例子包括：拼写错误、注释没有正确结束、字符串没有正确结束等。</li>
</ul>
</li>
<li>语法分析(标记结构完整)<ul>
<li>语法分析器会根据语法规则验证程序的正确性，如缺少右括号、是否缺少关键字、变量未定义、函数应该有返回值等。</li>
</ul>
</li>
<li>语义分析(有无语义矛盾)<ul>
<li>借助符号表检验代码没有违背语言类型系统。这个表存储标识符（符号）和它们各自的类型之间的映射，以及其它内容。</li>
<li>类型检查的一种直觉的方法是，在解析之后，遍历AST的同时从符号表收集关于类型的信息。</li>
<li>例子：定义了两个变量 a 冲突。</li>
</ul>
</li>
</ul>
<h2 id="llvm-后端"><a href="#llvm-后端" class="headerlink" title="llvm 后端"></a>llvm 后端</h2><p>见 llvm Backend 一文</p>
<h2 id="clang"><a href="#clang" class="headerlink" title="clang"></a>clang</h2><h3 id="clang-与-llvm的关系"><a href="#clang-与-llvm的关系" class="headerlink" title="clang 与 llvm的关系"></a>clang 与 llvm的关系</h3><p>Clang 是 LLVM 项目中的一个 C&#x2F;C++&#x2F;Objective-C 编译器，它使用 LLVM 的前端和后端进行代码生成和优化。它可以将 C&#x2F;C++&#x2F;Objective-C 代码编译为 LLVM 的中间表示（LLVM IR），然后进一步将其转换为目标平台的机器码。Clang 拥有很好的错误信息展示和提示，支持多平台使用，是许多开发者的首选编译器之一。同时，Clang 也作为 LLVM 项目的一个前端，为 LLVM 的生态系统提供了广泛的支持和应用。</p>
<h3 id="clang-的开发与苹果公司的关系"><a href="#clang-的开发与苹果公司的关系" class="headerlink" title="clang 的开发与苹果公司的关系"></a>clang 的开发与苹果公司的关系</h3><p>Clang 的开发起源于苹果公司的一个项目，即 LLVM&#x2F;Clang 项目。在 2005 年，苹果公司希望能够使用一种更加灵活、可扩展、优化的编译器来替代 GCC 作为其操作系统 macOS (Mac OS X) 开发环境的默认编译器。由于当时的 GCC 开发被其维护者们认为变得缓慢和难以维护，苹果公司决定开发一款新的编译器，这就是 Clang 诞生的原因。Clang 的开发团队由该项目的创立者 Chris Lattner 领导，他带领团队将 Clang 发展为一款可扩展、模块化、高效的编译器，并成功地将其嵌入到苹果公司的开发工具链 Xcode 中，成为了 macOS 开发环境中默认的编译器之一。</p>
<p>Clang 是一个开源项目，在苹果公司的支持下，Clang 的开发得到了全球各地的开发者们的广泛参与和贡献。现在，Clang 成为了 LLVM 生态中的一个重要组成部分，被广泛地应用于多平台的编译器开发中。</p>
<h3 id="clang-cannot-find-iostream"><a href="#clang-cannot-find-iostream" class="headerlink" title="clang-cannot-find-iostream"></a>clang-cannot-find-iostream</h3><p><code>Clang</code> and <code>Clang++</code> “borrow” the header files from <code>GCC</code> &amp; <code>G++</code>. It looks for the directories these usually live in and picks the latest one. If you’ve installed a later GCC without the corresponding G++, Clang++ gets confused and can’t find header files. In your instance, for example, if you’ve installed gcc 11 or 12.</p>
<p>You can use <code>clang-10 -v -E</code> or <code>clang++-10 -v -E</code> to get details on what versions of header files it’s trying to use.</p>
<p>安装g++-12解决</p>
<h2 id="常用工具"><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h2><p><code>github/tools</code>目录下有许多实用工具</p>
<ul>
<li><code>llvm-as</code>：把LLVM IR从人类能看懂的文本格式汇编成二进制格式。注意：此处得到的不是目标平台的机器码。</li>
<li><code>llvm-dis</code>：llvm-as的逆过程，即反汇编。 不过这里的反汇编的对象是LLVM IR的二进制格式，而不是机器码。</li>
<li><code>opt</code>：优化LLVM IR。输出新的LLVM IR。</li>
<li><code>llc</code>：把LLVM IR编译成汇编码。需要用as进一步得到机器码。</li>
<li><code>lli</code>：解释执行LLVM IR。</li>
</ul>
<h2 id="需要进一步的研究学习"><a href="#需要进一步的研究学习" class="headerlink" title="需要进一步的研究学习"></a>需要进一步的研究学习</h2><p>暂无</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>暂无</p>
<h2 id="开题缘由、总结、反思、吐槽"><a href="#开题缘由、总结、反思、吐槽" class="headerlink" title="开题缘由、总结、反思、吐槽~~"></a>开题缘由、总结、反思、吐槽~~</h2><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p>文章部分内容<strong>来自ChatGPT-3.5</strong>，暂时没有校验其可靠性(看上去貌似说得通)。</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/122522485">https://zhuanlan.zhihu.com/p/122522485</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-05-30T16:00:00.000Z" title="5/30/2023, 4:00:00 PM">2023-05-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-01-28T14:04:36.260Z" title="1/28/2024, 2:04:36 PM">2024-01-28</time></span><span class="level-item"><a class="link-muted" href="/categories/Tutorials/">Tutorials</a></span><span class="level-item">24 minutes read (About 3665 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/30/Work/HPC/llvm-mca/LLVM-mca/">LLVM-MCA: docs</a></p><div class="content"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>LLVM Machine Code Analyzer 是一种性能分析工具，它使用llvm中可用的信息（如调度模型）静态测量特定CPU中机器代码的性能。</p>
<p>性能是根据<strong>吞吐量</strong>和<strong>处理器资源消耗</strong>来衡量的。该工具目前适用于在后端中使用LLVM调度模型的处理器。</p>
<p>该工具的主要目标不仅是预测代码在目标上运行时的性能，还帮助诊断潜在的性能问题。</p>
<p>给定汇编代码，llvm-mca可以估计每个周期的指令数（IPC）以及硬件资源压力。分析和报告风格的灵感来自英特尔的IACA工具。</p>
<h3 id="github"><a href="#github" class="headerlink" title="github"></a>github</h3><p><a target="_blank" rel="noopener" href="https://github.com/llvm/llvm-project/tree/main/llvm/tools/llvm-mca">https://github.com/llvm/llvm-project/tree/main/llvm/tools/llvm-mca</a></p>
<h3 id="docs"><a href="#docs" class="headerlink" title="docs"></a>docs</h3><p><a target="_blank" rel="noopener" href="https://llvm.org/docs/CommandGuide/llvm-mca.html">https://llvm.org/docs/CommandGuide/llvm-mca.html</a></p>
<h2 id="options"><a href="#options" class="headerlink" title="options"></a>options</h2><h3 id="architecture"><a href="#architecture" class="headerlink" title="architecture"></a>architecture</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-mtriple=&lt;target triple&gt;</span><br><span class="line">    eg. -mtriple=x86_64-unknown-unknown</span><br><span class="line">-march=&lt;arch&gt;</span><br><span class="line">    Specify the architecture for which to analyze the code. It defaults to the host default target.</span><br><span class="line">-march=&lt;arch&gt;</span><br><span class="line">    Specify the architecture for which to analyze the code. It defaults to the host default target.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看支持的arch</span></span><br><span class="line">llc --version</span><br><span class="line"><span class="comment"># 查看具体支持的CPU Architecture</span></span><br><span class="line">llc -march=x86 -mattr=<span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<h3 id="output-report"><a href="#output-report" class="headerlink" title="output-report"></a>output-report</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-output-asm-variant=&lt;variant id&gt;</span><br><span class="line">    为工具生成的报告指定输出程序集变量。???</span><br><span class="line">-print-imm-hex</span><br><span class="line">    优先16进制输出。</span><br><span class="line">-json</span><br><span class="line">    除了瓶颈分析，基本都支持json格式输出视图</span><br><span class="line">-timeline</span><br><span class="line">    打印指令流水线情况</span><br></pre></td></tr></table></figure>

<h3 id="runtime-options"><a href="#runtime-options" class="headerlink" title="runtime options"></a>runtime options</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-dispatch=&lt;width&gt;</span><br><span class="line">    为处理器指定不同的调度宽度。调度宽度默认为处理器调度模型中的“IssueWidth”字段。</span><br><span class="line">-register-file-size=&lt;size&gt;</span><br><span class="line">    指定寄存器文件的大小。指定时，该项会限制可用于寄存器重命名的物理寄存器的数量。此标志的值为零意味着“无限数量的物理寄存器”。</span><br><span class="line">-iterations=&lt;number of iterations&gt;</span><br><span class="line">    指定要运行的迭代次数。如果此标志设置为 0，则该工具会将迭代次数设置为默认值（即 100）。</span><br><span class="line">-noalias=&lt;bool&gt;</span><br><span class="line">    loads and stores don’t alias</span><br><span class="line">-lqueue=&lt;load queue size&gt;</span><br><span class="line">-squeue=&lt;store queue size&gt;</span><br><span class="line">    在工具模拟的加载/存储单元中指定加载队列的大小。默认情况下，该工具假定加载队列中的条目数量不受限制。此标志的零值将被忽略，而是使用默认加载队列大小。</span><br><span class="line">-disable-cb</span><br><span class="line">    强制使用通用的 CustomBehaviour 和 InstrPostProcess 类，而不是使用目标特定的实现。通用类从不检测任何自定义危险或对指令进行任何后处理修改。</span><br></pre></td></tr></table></figure>

<h3 id="more-values-Info"><a href="#more-values-Info" class="headerlink" title="more values&#x2F;Info"></a>more values&#x2F;Info</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">-resource-pressure</span><br><span class="line">    Enable the resource pressure view. This is enabled by default.</span><br><span class="line">-register-file-stats</span><br><span class="line">    启用注册文件使用统计。</span><br><span class="line">-dispatch-stats</span><br><span class="line">-scheduler-stats</span><br><span class="line">-retire-stats</span><br><span class="line">-instruction-info</span><br><span class="line">    启用额外的调度/发出/retire control unit统计。该视图收集和分析指令分派事件，以及静态/动态分派停顿事件。默认情况下禁用此视图。</span><br><span class="line">-show-encoding</span><br><span class="line">    打印指令16进制</span><br><span class="line">-all-stats</span><br><span class="line">-all-views</span><br><span class="line">-instruction-tables</span><br><span class="line">    这与资源压力视图不同，因为它不需要模拟代码。相反，它按顺序打印每个指令的资源压力的理论均匀分布。</span><br><span class="line">-bottleneck-analysis</span><br><span class="line">    打印有关影响吞吐量的瓶颈的信息。这种分析可能很昂贵，并且默认情况下是禁用的。瓶颈在摘要视图中突出显示。具有有序后端的处理器目前不支持瓶颈分析。???</span><br></pre></td></tr></table></figure>

<h2 id="实现逻辑"><a href="#实现逻辑" class="headerlink" title="实现逻辑"></a>实现逻辑</h2><p><img src="https://pic.shaojiemike.top/img/38FD1039D93F746E0A45477E84CF74A0.png"></p>
<h2 id="样例分析"><a href="#样例分析" class="headerlink" title="样例分析"></a>样例分析</h2><h3 id="quick-overview-of-the-performance-throughput"><a href="#quick-overview-of-the-performance-throughput" class="headerlink" title="quick overview of the performance throughput"></a>quick overview of the performance throughput</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Iterations:        300</span><br><span class="line">Instructions:      900</span><br><span class="line">Total Cycles:      610</span><br><span class="line">Total uOps:        900</span><br><span class="line"></span><br><span class="line">Dispatch Width:    2</span><br><span class="line">uOps Per Cycle:    1.48</span><br><span class="line">IPC:               1.48</span><br><span class="line">Block RThroughput: 2.0</span><br></pre></td></tr></table></figure>

<ol>
<li>IPC<ol>
<li>理论最大值是$$\frac{OneLoopInstructions}{Block_RThroughput}&#x3D;(OneLoopInstructions)*(Block_Throughput)$$</li>
</ol>
</li>
<li>uOps Per Cycle<ol>
<li>simulated micro opcodes (uOps)</li>
<li><strong>每个周期的simulated micro opcodes数</strong></li>
<li>在不考虑循环依赖的情况下，理论上最大值是$$\frac{OneLoopUOps}{Block_RThroughput}&#x3D;(OneLoopUOps)*(Block_Throughput)$$</li>
<li>A delta between Dispatch Width and this field is an indicator of a performance issue.</li>
<li>The delta between the Dispatch Width (2.00), and the theoretical maximum uOp throughput (1.50) is an indicator of a performance bottleneck caused by the lack of hardware resources, and the Resource pressure view can help to identify the problematic resource usage.</li>
</ol>
</li>
<li>Dispatch Width<ol>
<li>发射到乱序后端的最大微指令操作数(the maximum number of micro opcodes&#x2F;uOps)？</li>
</ol>
</li>
<li>Block RThroughput (Block Reciprocal Throughput)<ol>
<li>在不考虑循环依赖的情况下，理论上的<strong>每次循环的最大block或者iterations数</strong></li>
<li>受限于dispatch rate和the availability of hardware resources.</li>
</ol>
</li>
</ol>
<h3 id="Instruction-info-view"><a href="#Instruction-info-view" class="headerlink" title="Instruction info view"></a>Instruction info view</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Instruction Info:</span><br><span class="line">[1]: #uOps</span><br><span class="line">[2]: Latency</span><br><span class="line">[3]: RThroughput</span><br><span class="line">[4]: MayLoad</span><br><span class="line">[5]: MayStore</span><br><span class="line">[6]: HasSideEffects (U)</span><br><span class="line"></span><br><span class="line">[1]    [2]    [3]    [4]    [5]    [6]    Instructions:</span><br><span class="line"> 1      2     1.00                        vmulps      %xmm0, %xmm1, %xmm2</span><br><span class="line"> 1      3     1.00                        vhaddps     %xmm2, %xmm2, %xmm3</span><br><span class="line"> 1      3     1.00                        vhaddps     %xmm3, %xmm3, %xmm4</span><br></pre></td></tr></table></figure>

<p>显示了指令里队列每条指令的<strong>延迟</strong>和<strong>吞吐量的倒数</strong>。</p>
<p>RThroughput是指令吞吐量的倒数。在不考虑循环依赖的情况下，吞吐量是<strong>单周期能执行的同类型指令的最大数量</strong>。</p>
<h3 id="Resource-pressure-view"><a href="#Resource-pressure-view" class="headerlink" title="Resource pressure view"></a>Resource pressure view</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Resources:</span><br><span class="line">[0]   - JALU0</span><br><span class="line">[1]   - JALU1</span><br><span class="line">[2]   - JDiv</span><br><span class="line">[3]   - JFPA</span><br><span class="line">[4]   - JFPM</span><br><span class="line">[5]   - JFPU0</span><br><span class="line">[6]   - JFPU1</span><br><span class="line">[7]   - JLAGU</span><br><span class="line">[8]   - JMul</span><br><span class="line">[9]   - JSAGU</span><br><span class="line">[10]  - JSTC</span><br><span class="line">[11]  - JVALU0</span><br><span class="line">[12]  - JVALU1</span><br><span class="line">[13]  - JVIMUL</span><br><span class="line"></span><br><span class="line">Resource pressure per iteration:</span><br><span class="line">[0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12]   [13]</span><br><span class="line"> -      -      -     2.00   1.00   2.00   1.00    -      -      -      -      -      -      -</span><br><span class="line"></span><br><span class="line">Resource pressure by instruction:</span><br><span class="line">[0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12]   [13]   Instructions:</span><br><span class="line"> -      -      -      -     1.00    -     1.00    -      -      -      -      -      -      -     vmulps      %xmm0, %xmm1, %xmm2</span><br><span class="line"> -      -      -     1.00    -     1.00    -      -      -      -      -      -      -      -     vhaddps     %xmm2, %xmm2, %xmm3</span><br><span class="line"> -      -      -     1.00    -     1.00    -      -      -      -      -      -      -      -     vhaddps     %xmm3, %xmm3, %xmm4</span><br></pre></td></tr></table></figure>

<p>每次循环或者每条指令执行，消耗的资源周期数。从而找到高资源占用的部分。</p>
<h3 id="Timeline-View"><a href="#Timeline-View" class="headerlink" title="Timeline View"></a>Timeline View</h3><p>可打印流水线情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Timeline view:</span><br><span class="line">                    012345</span><br><span class="line">Index     0123456789</span><br><span class="line"></span><br><span class="line">[0,0]     DeeER.    .    .   vmulps   %xmm0, %xmm1, %xmm2</span><br><span class="line">[0,1]     D==eeeER  .    .   vhaddps  %xmm2, %xmm2, %xmm3</span><br><span class="line">[0,2]     .D====eeeER    .   vhaddps  %xmm3, %xmm3, %xmm4</span><br><span class="line">[1,0]     .DeeE-----R    .   vmulps   %xmm0, %xmm1, %xmm2</span><br><span class="line">[1,1]     . D=eeeE---R   .   vhaddps  %xmm2, %xmm2, %xmm3</span><br><span class="line">[1,2]     . D====eeeER   .   vhaddps  %xmm3, %xmm3, %xmm4</span><br><span class="line">[2,0]     .  DeeE-----R  .   vmulps   %xmm0, %xmm1, %xmm2</span><br><span class="line">[2,1]     .  D====eeeER  .   vhaddps  %xmm2, %xmm2, %xmm3</span><br><span class="line">[2,2]     .   D======eeeER   vhaddps  %xmm3, %xmm3, %xmm4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Average Wait times (based on the timeline view):</span><br><span class="line">[0]: Executions</span><br><span class="line">[1]: Average time spent waiting in a scheduler&#x27;s queue</span><br><span class="line">[2]: Average time spent waiting in a scheduler&#x27;s queue while ready</span><br><span class="line">[3]: Average time elapsed from WB until retire stage</span><br><span class="line"></span><br><span class="line">      [0]    [1]    [2]    [3]</span><br><span class="line">0.     3     1.0    1.0    3.3       vmulps   %xmm0, %xmm1, %xmm2</span><br><span class="line">1.     3     3.3    0.7    1.0       vhaddps  %xmm2, %xmm2, %xmm3</span><br><span class="line">2.     3     5.7    0.0    0.0       vhaddps  %xmm3, %xmm3, %xmm4</span><br><span class="line">       3     3.3    0.5    1.4       &lt;total&gt;</span><br></pre></td></tr></table></figure>

<p>影响因素包括：</p>
<ol>
<li>数据冲突&#x2F;依赖：读后写，写后读依赖 。无法指令级并行，也可以通过寄存器重命名解决</li>
<li>结构冲突：占用发射位 或者 同一硬件</li>
<li>控制冲突：分支？</li>
<li>instructions must retire in program order, so [1,0] has to wait for [0,2] to be retired first</li>
</ol>
<h3 id="Bottleneck-Analysis"><a href="#Bottleneck-Analysis" class="headerlink" title="Bottleneck Analysis"></a>Bottleneck Analysis</h3><ul>
<li>可以分析出数据冲突&#x2F;依赖和结构冲突的影响大小</li>
<li>准确性取决于模拟和是否有对应CPU模型。</li>
<li>暂时不支持有序后端。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Cycles with backend pressure increase [ 91.52% ]</span><br><span class="line">Throughput Bottlenecks:</span><br><span class="line">  Resource Pressure       [ 0.01% ]</span><br><span class="line">  - SBPort0  [ 0.01% ]</span><br><span class="line">  - SBPort1  [ 0.01% ]</span><br><span class="line">  - SBPort5  [ 0.01% ]</span><br><span class="line">  Data Dependencies:      [ 91.51% ]</span><br><span class="line">  - Register Dependencies [ 91.51% ]</span><br><span class="line">  - Memory Dependencies   [ 10.76% ]</span><br></pre></td></tr></table></figure>

<ul>
<li>端口信息来自TableGen <code>llvm/lib/Target/X86/X86SchedSandyBridge.td</code></li>
<li>鲲鹏920的来自 <code>llvm/lib/Target/AArch64/AArch64SchedTSV110.td</code></li>
</ul>
<h3 id="额外信息"><a href="#额外信息" class="headerlink" title="额外信息"></a>额外信息</h3><ol>
<li>Dynamic Dispatch Stall Cycles</li>
<li>Dispatch Logic<ol>
<li>可以看出流水线发射满带宽或几条指令的时间占比</li>
</ol>
</li>
<li>Schedulers<ol>
<li>每个周期微指令发射数占比</li>
</ol>
</li>
<li>Scheduler’s queue usage<ol>
<li><p>执行时使用的平均或最大buffer entries (i.e., scheduler queue entries)</p>
</li>
<li><p>AMD Jaguar</p>
</li>
<li><pre><code>  JALU01 - A scheduler for ALU instructions.
  JFPU01 - A scheduler floating point operations.
  JLSAGU - A scheduler for address generation.
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">5. Retire Control Unit</span><br><span class="line">   1. 在一个周期里有多少指令retired的占比(好吧，感觉有语病)</span><br><span class="line">6. A re-order buffer (ROB) 的使用情况</span><br><span class="line">7. Register File statistics</span><br><span class="line">   1. physical register file (PRF)</span><br><span class="line">   2. floating-point registers (JFpuPRF)</span><br><span class="line">   3. integer registers (JIntegerPRF)</span><br><span class="line"></span><br><span class="line">## Instruction Flow</span><br><span class="line"></span><br><span class="line">llvm-mca 假设指令在模拟开始之前已经全部解码并放入队列中。因此，指令提取和解码阶段没有被计算。未考虑前端的性能瓶颈。此外，llvm-mca 不模拟分支预测。</span><br><span class="line"></span><br><span class="line">### Instruction Dispatch</span><br><span class="line"></span><br><span class="line">处理器的默认 dispatch width值等于LLVM’s scheduling model里的IssueWidth值。</span><br><span class="line"></span><br><span class="line">An instruction can be dispatched if:</span><br><span class="line"></span><br><span class="line">* The size of the **dispatch group** is smaller than processor’s dispatch width.</span><br><span class="line">* There are enough entries in the **reorder buffer**.</span><br><span class="line">* There are enough **physical registers** to do register renaming.</span><br><span class="line">* The schedulers are **not full**.</span><br><span class="line"></span><br><span class="line">reorder buffer负责跟踪命令，使之按照程序顺序retired结束。其默认值为 MicroOpBufferSize 。</span><br><span class="line"></span><br><span class="line">各种Buffered resources 被视作scheduler resources.</span><br><span class="line"></span><br><span class="line">### Instruction Issue</span><br><span class="line"></span><br><span class="line">每个处理器调度器实现一个指令缓冲区。指令必须在调度程序的缓冲区中等待，直到输入寄存器操作数可用。只有在那个时候，指令才符合执行的条件，并且可能会被发出（可能是乱序的）以供执行。 llvm-mca 在调度模型的帮助下计算指令延迟。</span><br><span class="line"></span><br><span class="line">llvm-mca 的调度器旨在模拟多处理器调度器。调度器负责跟踪数据依赖关系，并动态选择指令消耗哪些处理器资源。它将处理器资源单元和资源组的管理委托给资源管​​理器。资源管理器负责选择指令消耗的资源单元。例如，如果一条指令消耗了一个资源组的1cy，则资源管理器从该组中选择一个可用单元；默认情况下，资源管理器使用循环选择器来保证资源使用在组的所有单元之间均匀分配。</span><br><span class="line"></span><br><span class="line">llvm-mca’s scheduler internally groups instructions into three sets:</span><br><span class="line"></span><br><span class="line">* WaitSet: a set of instructions whose operands are not ready.</span><br><span class="line">* ReadySet: a set of instructions ready to execute.</span><br><span class="line">* IssuedSet: a set of instructions executing.</span><br><span class="line"></span><br><span class="line">### Write-Back and Retire Stage</span><br><span class="line"></span><br><span class="line"> retire control unit</span><br><span class="line"></span><br><span class="line">1. When instructions are executed,the flags the instruction as “ready to retire.”</span><br><span class="line">2. Instructions are retired in program order</span><br><span class="line">3. free the physical registers</span><br><span class="line"></span><br><span class="line">### Load/Store Unit and Memory Consistency Model</span><br><span class="line"></span><br><span class="line">load/store unit (LSUnit)用来模拟乱序memory操作</span><br><span class="line"></span><br><span class="line">The rules are:</span><br><span class="line"></span><br><span class="line">1. A younger load is allowed to pass an older load only if there are no intervening stores or barriers between the two loads.</span><br><span class="line">2. A younger load is allowed to pass an older store provided that the load does not alias with the store.</span><br><span class="line">3. A younger store is not allowed to pass an older store.不能交换顺序的意思</span><br><span class="line">4. A younger store is not allowed to pass an older load.</span><br><span class="line"></span><br><span class="line">假设 loads do not alias (-noalias=true) store operations.Under this assumption, younger loads are always allowed to pass older stores. ???</span><br><span class="line"></span><br><span class="line">LSUnit不打算跑alias analysis来预测何时load与store不相互alias???</span><br><span class="line"></span><br><span class="line">in the case of write-combining memory, rule 3 could be relaxed to allow reordering of non-aliasing store operations.???</span><br><span class="line"></span><br><span class="line">LSUnit不管的其余三点：</span><br><span class="line"></span><br><span class="line">1. The LSUnit does not know when store-to-load forwarding may occur.</span><br><span class="line">2. The LSUnit does not know anything about cache hierarchy and memory types.</span><br><span class="line">3. The LSUnit does not know how to identify serializing operations and memory fences.</span><br><span class="line">4. The LSUnit does not attempt to predict if a load or store hits or misses the L1 cache(不考虑cache命中，默认是命中L1,产生the load-to-use latency的最乐观开销)</span><br><span class="line"></span><br><span class="line">llvm-mca 不知道序列化操作或内存屏障之类的指令。 LSUnit 保守地假设同时具有“MayLoad”和未建模副作用的指令的行为类似于“软”load-barrier。这意味着，它在不强制刷新load队列的情况下序列化加载。类似地，“MayStore”和具有未建模副作用的指令被视为store障碍。完整的memory-barrier是具有未建模副作用的“MayLoad”和“MayStore”指令。LLVM的实现是不准确的，但这是我们目前使用 LLVM 中可用的当前信息所能做的最好的事情。</span><br><span class="line"></span><br><span class="line">load/store barrier会占用在load/store 队列里占用一项。</span><br><span class="line">当load/store barrier是其队列里oldest项时，其会被执行</span><br><span class="line"></span><br><span class="line">![](https://pic.shaojiemike.top/img/440472FD7AB14BC3C1F29BD2D565ACDF.png)</span><br><span class="line"></span><br><span class="line">### In-order Issue and Execute</span><br><span class="line"></span><br><span class="line">有序处理器被建模为单个 InOrderIssueStage 阶段。它绕过 Dispatch、Scheduler 和 Load/Store 单元。一旦它们的操作数寄存器可用并且满足资源要求，就会发出指令。根据LLVM的调度模型中IssueWidth参数的值，可以在一个周期内发出多条指令。一旦发出，指令就会被移到 IssuedInst 集，直到它准备好retire。 llvm-mca 确保按顺序提交写入。但是，如果 RetireOOO 属性for at least one of its writes为真，则允许指令提交写入并无序retire???</span><br><span class="line"></span><br><span class="line">## Custom Behaviour 自定义行为</span><br><span class="line"></span><br><span class="line">某些指令在该模型中并不能被准确的模拟。为了几条指令而修改模型不是个好的选择，一般通过**CustomBehaviour**类对某些指令进行特殊建模：自定义数据依赖，以及规避、单独处理特殊情况。</span><br><span class="line"></span><br><span class="line">为此，llvm-mca设置了一个通用的以及多个特殊的**CustomBehaviour**类。下面两种情况下会使用通用类：</span><br><span class="line"></span><br><span class="line">1. 开启了`-disable-cb`选项</span><br><span class="line">2. 不存在针对某目标的特殊类(通用类也做不了什么，我什么也做不到😥)</span><br><span class="line"></span><br><span class="line">但是注意目前只有in-order流水线实现了**CustomBehaviour**类，out-order流水线将来也会支持。</span><br><span class="line"></span><br><span class="line">该类主要通过`checkCustomHazard()`函数来实现，通过当前指令和真正流水线中执行的指令，来判断当前指令需要等待几个周期才能发射。</span><br><span class="line"></span><br><span class="line">如果想对没有实现的目标添加**CustomBehaviour**类，可以参考已有的实现，比如在`/llvm/lib/Target/AMDGPU/MCA/`目录下。</span><br><span class="line"></span><br><span class="line">## Custom Views 自定义视图</span><br><span class="line"></span><br><span class="line">关于自定义的视图的添加路径，如果**没有输出**从未在MC layer classes (MCSubtargetInfo, MCInstrInfo, etc.)里出现过的**新后端值**，请把实现加入`/tools/llvm-mca/View/`。相反，请加入`/lib/Target/&lt;TargetName&gt;/MCA/`目录。</span><br><span class="line"></span><br><span class="line">关于Custom Views所需内容，需要写特殊的**CustomBehaviour**类来覆写`CustomBehaviour::getViews()`函数，根据位置的不同还有三种实现`getStartViews(), getPostInstrInfoViews(),getEndViews()`。</span><br><span class="line"></span><br><span class="line">## 影响准确性的因素</span><br><span class="line"></span><br><span class="line">调度模型不仅用于计算指令延迟和吞吐量，还用于了解可用的处理器资源以及如何模拟它们。</span><br><span class="line"></span><br><span class="line">llvm mca进行分析的质量不可避免地受到**llvm中调度模型质量**的影响。</span><br><span class="line"></span><br><span class="line">## 功能（能估计的值</span><br><span class="line"></span><br><span class="line">1. IPC</span><br><span class="line">2. 硬件资源压力resource-pressure</span><br><span class="line">3. 一些额外Info？</span><br><span class="line">   1.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
 register-file-stats
 -dispatch-stats
 -scheduler-stats
 -retire-stats
 -instruction-info
 instruction-tables
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">4. 吞吐量瓶颈？</span><br><span class="line"></span><br><span class="line">### 支持对特定代码块的分析</span><br><span class="line"></span><br><span class="line">1. 汇编代码，支持命名和嵌套</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ol>
<h1 id="LLVM-MCA-BEGIN-block-name"><a href="#LLVM-MCA-BEGIN-block-name" class="headerlink" title="LLVM-MCA-BEGIN block-name"></a>LLVM-MCA-BEGIN block-name</h1><p> add %eax, %eax</p>
<h1 id="LLVM-MCA-END"><a href="#LLVM-MCA-END" class="headerlink" title="LLVM-MCA-END"></a>LLVM-MCA-END</h1> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. 高级语言，通过内联汇编实现</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p> int foo(int a, int b) {<br>     __asm volatile(“# LLVM-MCA-BEGIN foo”);<br>     a +&#x3D; 42;<br>     __asm volatile(“# LLVM-MCA-END”);<br>     a *&#x3D; b;<br>     return a;<br> }</p>
<pre><code>
但是，这会干扰循环矢量化等优化，并可能对生成的代码产生影响。具体影响请对比汇编代码。
</code></pre>
</li>
</ol>
<h2 id="相关论文"><a href="#相关论文" class="headerlink" title="相关论文"></a>相关论文</h2><p>Google学术搜llvm-mca，一堆论文。但是不急着看，因为没有预备知识，没有问题的去看论文。效率和收获很低的，而且会看不懂。</p>
<h2 id="相关项目"><a href="#相关项目" class="headerlink" title="相关项目"></a>相关项目</h2><h3 id="mc-ruler"><a href="#mc-ruler" class="headerlink" title="mc-ruler"></a>mc-ruler</h3><p><a target="_blank" rel="noopener" href="https://github.com/jeremyong/mc_ruler#">mc-ruler</a>是整合了llvm-mca的cmake,可以打印指定部分的代码分析信息。如果之后要测试可能用得上。</p>
<h2 id="需要进一步的研究学习"><a href="#需要进一步的研究学习" class="headerlink" title="需要进一步的研究学习"></a>需要进一步的研究学习</h2><ol>
<li>具体功能</li>
<li>llvm如何实现的，要看代码。</li>
</ol>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><ol>
<li>(llvm-mca detects Intel syntax by the presence of an <strong>.intel_syntax</strong> directive at the beginning of the input. By default its output syntax matches that of its input.)</li>
<li>？？？的地方</li>
<li>大概看了一下功能，但是性能怎么对比呢。准确值是多少呢？<ol>
<li>arm kunpeng pmu-tools 实现</li>
</ol>
</li>
<li>每次的估计值会波动吗？</li>
</ol>
<p>如何和大神交流呢+提问的艺术</p>
<h2 id="开题缘由、总结、反思、吐槽"><a href="#开题缘由、总结、反思、吐槽" class="headerlink" title="开题缘由、总结、反思、吐槽~~"></a>开题缘由、总结、反思、吐槽~~</h2><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><div id='refer-anchor'></div>
无
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-05-30T16:00:00.000Z" title="5/30/2023, 4:00:00 PM">2023-05-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-01-28T14:04:36.264Z" title="1/28/2024, 2:04:36 PM">2024-01-28</time></span><span class="level-item"><a class="link-muted" href="/categories/Architecture/">Architecture</a></span><span class="level-item">11 minutes read (About 1699 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/30/Work/Programming/4-compile/llvmBackend/">llvm Backend</a></p><div class="content"><h2 id="llvm-后端-概述"><a href="#llvm-后端-概述" class="headerlink" title="llvm 后端 概述"></a>llvm 后端 概述</h2><ul>
<li>后端（backend）由一套<strong>分析</strong>和<strong>转换</strong>Pass组成，它们的任务是代码生成，即将LLVM中间表示（IR）变换为目标代码（或者汇编）。</li>
<li>LLVM支持广泛的目标：ARM，AArch64，Hexagon，MSP430，MIPS，Nvidia PTX，PowerPC，R600，SPARC，SystemZ，X86，和XCore。</li>
<li>所有这些后端共享一套共用的接口，它是目标无关代码生成器的一部分，以通用API的方法抽象化后端任务。每个目标必须特殊化代码生成通用类，以实现目标特定的行为。</li>
</ul>
<h3 id="后端的基本流程"><a href="#后端的基本流程" class="headerlink" title="后端的基本流程"></a>后端的基本流程</h3><ul>
<li>下图给出了将LLVM IR转换为目标汇编代码必需的步骤</li>
</ul>
<p><img src="https://pic.shaojiemike.top/img/20230523160158.png" alt="Backend"></p>
<ul>
<li>浅灰色的中间框，也叫super pass，是必需的，它们是后端的核心部分。</li>
<li>白色框所指示的，可以执行非必需的优化Pass以进一步改进翻译的质量。对于提高所生成的代码的效率更重要。<ul>
<li>比如<code>-O3</code>的优化，而且其顺序对结果也有影响。</li>
</ul>
</li>
</ul>
<p>详细解释各阶段：</p>
<ol>
<li>指令选择（Instruction Selection）：将三地址结构的LLVM IR变换为DAG（Directed Acyclic Graph）<ul>
<li>每个DAG能够表示单一基本块的计算。DAG内节点表示机器指令，边表示数据依赖关系。</li>
</ul>
</li>
<li>第1次指令调度（Instruction Scheduling），也称为前寄存器分配（RA）调度，对指令排序，同时尝试发现尽可能多的指令层次的并行。然后这些指令被变换为MachineInstr三地址表示。</li>
<li>寄存器分配（Register Allocation），它将无限的虚拟寄存器的引用转换为有限的目标特定的寄存器集，寄存器不够时挤出（spill）到内存。</li>
<li>第2次指令调度，也称为后寄存器分配（RA）调度。因为此时在这个点可获得真实的寄存器信息，某些类型寄存器存在额外的风险和延迟，它们可被用以改进指令顺序。</li>
<li>代码输出（Code Emission）阶段将指令从MachineInstr表示变换为MCInst实例。这种新的表示更适合汇编器和链接器，它有两种选择：输出汇编代码或者输出二进制块（blob）到一种特定的目标代码格式。</li>
</ol>
<h3 id="后端代码结构"><a href="#后端代码结构" class="headerlink" title="后端代码结构"></a>后端代码结构</h3><p>后端的实现分散在LLVM源代码树的不同目录中。代码生成背后的主要程序库位于lib目录和它的子文件夹CodeGen、MC、TableGen、和Target中， 具体参考<a target="_blank" rel="noopener" href="https://getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io/zh_CN/latest/ch06.html#id4">文档</a></p>
<p>Tablegen位置在类似 <code>llvm/lib/Target/X86/X86.td</code>的地方</p>
<h2 id="llvm-编译优化"><a href="#llvm-编译优化" class="headerlink" title="llvm 编译优化"></a>llvm 编译优化</h2><ul>
<li>通过llvm的分析和转换Pass相结合实现的。</li>
<li>首先，通过分析Pass获取程序的一些特性和数据流等信息，例如控制流分析、数据流分析、依赖分析等。</li>
<li>然后，根据所得到的分析信息，llvm会执行转换Pass，对程序进行一系列的重构、优化和变换，例如常量传播、死代码消除、内联函数、循环展开等。</li>
</ul>
<h3 id="举例：O3优化实现"><a href="#举例：O3优化实现" class="headerlink" title="举例：O3优化实现"></a>举例：O3优化实现</h3><p>程序优化选项 -O3 是通过启用 LLVM Pass Manager 并按照顺序执行包含多个具体优化 Pass 的过程实现的。包括：</p>
<ol>
<li>函数内部优化 Pass，如内联、函数内联、无用函数清理、控制流扁平化；</li>
<li>函数间优化 Pass，如基于静态单走边分析的间接调用目标推导、函数每次调用的参数的重复计算消除、通过符号解析执行的函数简介化等。</li>
<li>模块优化 Pass，如死代码消除、全局优化、常量传播、数值宽化和窄化、整除优化等；</li>
<li>特定于架构的优化 Pass，包括指令调度和寄存器分配等。</li>
</ol>
<p>这些 Pass 的执行范围涵盖 LLVM IR 与 LLVM 后端。</p>
<h2 id="TableGen"><a href="#TableGen" class="headerlink" title="TableGen"></a>TableGen</h2><ul>
<li>LLVM的TableGen是一种表格驱动代码生成工具，主要用于生成汇编器、反汇编器、指令选择器、调度器等代码。</li>
<li>它使用基于LLVM IR的DSL(Domain-Specific Language)来描述目标指令集的特性和规则，然后将这些信息转换为C++代码。</li>
<li>使用TableGen可以将目标指令集的实现与源代码分离，从而提高代码的可读性和可维护性。</li>
</ul>
<p>TableGen的输入文件使用扩展名“<code>.td</code>”（TableGen的缩写），它们可以描述如下内容：</p>
<ol>
<li>Instruction Set Architecture (ISA) - 描述目标机的指令集特性，例如指令集架构、寄存器、寄存器类、操作数类型、地址模型、端对齐性等。</li>
<li>Selection DAG - 描述了如何将LLVM IR节点映射到目标机指令集的指令，例如指令的操作码、操作数、调用约定、指令延迟等。</li>
<li>Pattern Matching - 对匹配到的指令模板做出生成想要的IR节点的选择。</li>
<li>Instruction Scheduling - 描述调度器行为、指令之间的时间关系，以及如何将指令插入到调度图中的规则等。</li>
</ol>
<ul>
<li>TableGen自动化了目标机指令集的大部分工作，同时也使得自定义目标机变得相对容易。</li>
<li>该工具支持针对多种平台和编译器的后端代码生成。</li>
<li>对于嵌入式系统和非标准指令集架构等领域，TableGen有着广泛的应用。</li>
</ul>
<h3 id="相关的概念"><a href="#相关的概念" class="headerlink" title="相关的概念"></a>相关的概念</h3><ul>
<li>目标描述语言（Target Description Language，TDL）来定义目标架构特定的指令和寄存器。其中，TDL可用于目标架构中指令定义和寄存器定义的映射关系和动态生成机器指令的规则。</li>
</ul>
<h2 id="实践：llvm-IR-后端"><a href="#实践：llvm-IR-后端" class="headerlink" title="实践：llvm IR 后端"></a>实践：llvm IR 后端</h2><p>实现一个简单的LLVM IR后端，将LLVM IR转换为x86汇编代码，能line by line的输出。</p>
<p>参考LLVM官方文档中的“Writing an LLVM Backend”以及“TableGen Backends”</p>
<!-- 下面回答部分**来自ChatGPT-3.5**，暂时没有校验其可靠性(看上去貌似说得通)。 -->

<h2 id="需要进一步的研究学习"><a href="#需要进一步的研究学习" class="headerlink" title="需要进一步的研究学习"></a>需要进一步的研究学习</h2><p>暂无</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>暂无</p>
<h2 id="开题缘由、总结、反思、吐槽"><a href="#开题缘由、总结、反思、吐槽" class="headerlink" title="开题缘由、总结、反思、吐槽~~"></a>开题缘由、总结、反思、吐槽~~</h2><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a target="_blank" rel="noopener" href="https://getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io/zh_CN/latest/ch06.html#id2">https://getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io/zh_CN/latest/ch06.html#id2</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-05-22T16:00:00.000Z" title="5/22/2023, 4:00:00 PM">2023-05-22</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-01-28T14:04:36.264Z" title="1/28/2024, 2:04:36 PM">2024-01-28</time></span><span class="level-item"><a class="link-muted" href="/categories/Architecture/">Architecture</a></span><span class="level-item">11 minutes read (About 1584 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/22/Work/Programming/4-compile/llvmPass/">llvm Pass</a></p><div class="content"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li>Pass就是“遍历一遍IR，可以同时对它做一些操作”的意思。翻译成中文应该叫“传递”。</li>
<li>在实现上，LLVM的核心库中会给你一些 Pass类 去继承。你需要实现它的一些方法。<ul>
<li>ModulePass , CallGraphSCCPass, FunctionPass , or LoopPass, or RegionPass</li>
</ul>
</li>
<li>最后使用LLVM的编译器会把它翻译得到的IR传入Pass里，给你遍历和修改。</li>
</ul>
<h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><ol>
<li>插桩： 在Pass遍历LLVM IR的同时，自然就可以往里面插入新的代码。</li>
<li>机器无关的代码优化：编译原理一课说：IR在被翻译成机器码前会做一些机器无关的优化。 但是不同的优化方法之间需要解耦，所以自然要各自遍历一遍IR，实现成了一个个LLVM Pass。 最终，基于LLVM的编译器会在前端生成LLVM IR后调用一些LLVM Pass做机器无关优化， 然后再调用LLVM后端生成目标平台代码。</li>
<li>静态分析： 像VSCode的C&#x2F;C++插件就会用LLVM Pass来分析代码，提示可能的错误 (无用的变量、无法到达的代码等等)。</li>
</ol>
<h2 id="理解-llvm-Pass"><a href="#理解-llvm-Pass" class="headerlink" title="理解 llvm Pass"></a>理解 llvm Pass</h2><h3 id="理解Pass-API"><a href="#理解Pass-API" class="headerlink" title="理解Pass API"></a>理解Pass API</h3><p>　　Pass类是实现优化的主要资源。然而，我们从不直接使用它，而是通过清楚的子类使用它。当实现一个Pass时，你应该选择适合你的Pass的最佳粒度，适合此粒度的最佳子类，例如基于函数、模块、循环、强联通区域，等等。常见的这些子类如下：</p>
<ul>
<li><code>ModulePass</code>：这是最通用的Pass；它一次分析整个模块，函数的次序不确定。它不限定使用者的行为，允许删除函数和其它修改。为了使用它，你需要写一个类继承ModulePass，并重载runOnModule()方法。</li>
<li><code>FunctionPass</code>：这个子类允许一次处理一个函数，处理函数的次序不确定。这是应用最多的Pass类型。它禁止修改外部函数、删除函数、删除全局变量。为了使用它，需要写一个它的子类，重载runOnFunction()方法。</li>
<li><code>BasicBlockPass</code>：这个类的粒度是基本块。FunctionPass类禁止的修改在这里也是禁止的。它还禁止修改或者删除外部基本块。使用者需要写一个类继承BasicBlockPass，并重载它的runOnBasicBlock()方法。</li>
</ul>
<p>　　被重载的入口函数runOnModule()、runOnFunction()、runOnBasicBlock()返回布尔值false，如果被分析的单元（模块、函数和基本块）保持不变，否则返回布尔值true。</p>
<h3 id="Pass的执行顺序-依赖"><a href="#Pass的执行顺序-依赖" class="headerlink" title="Pass的执行顺序&#x2F;依赖"></a>Pass的执行顺序&#x2F;依赖</h3><ul>
<li>ChatGPT说默认顺序是：FunctionPass -&gt; Module Pass -&gt; LoopPass ?</li>
<li>当然我们是可以修改插入Pass的执行顺序的。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> PIMProf::AnnotationInjection::ID = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 注册 llvm pass</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterPass&lt;PIMProf::AnnotationInjection&gt; <span class="title">RegisterMyPass</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;AnnotationInjection&quot;</span>, <span class="string">&quot;Inject annotators to uniquely identify each basic block.&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">loadPass</span><span class="params">(<span class="type">const</span> PassManagerBuilder &amp;,</span></span></span><br><span class="line"><span class="params"><span class="function">                           legacy::PassManagerBase &amp;PM)</span> </span>&#123;</span><br><span class="line">    PM.<span class="built_in">add</span>(<span class="keyword">new</span> PIMProf::<span class="built_in">AnnotationInjection</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ox 的代码 llvm pass 在EP_OptimizerLast 位置load</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterStandardPasses <span class="title">clangtoolLoader_Ox</span><span class="params">(PassManagerBuilder::EP_OptimizerLast, loadPass)</span></span>;</span><br><span class="line"><span class="comment">// O0 的代码 llvm pass EP_EnabledOnOptLevel0 位置load</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterStandardPasses <span class="title">clangtoolLoader_O0</span><span class="params">(PassManagerBuilder::EP_EnabledOnOptLevel0, loadPass)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><ol>
<li>编写LLVM pass代码</li>
<li>配置编译环境(cmake or make)</li>
<li>运行(opt or clang)</li>
</ol>
<h2 id="1-代码框架"><a href="#1-代码框架" class="headerlink" title="1 代码框架"></a>1 代码框架</h2><p>最简单框架hello.cpp如下，注意<code>Important</code>一定需要：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"> <span class="comment">// Important</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">Hello</span> : <span class="keyword">public</span> FunctionPass &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">    <span class="built_in">Hello</span>() : <span class="built_in">FunctionPass</span>(ID) &#123;&#125;</span><br><span class="line"> <span class="comment">// Important</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">      <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Hello: &quot;</span>;</span><br><span class="line">      <span class="built_in">errs</span>().<span class="built_in">write_escaped</span>(F.<span class="built_in">getName</span>()) &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> Hello::ID = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Important:Register for opt</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterPass&lt;Hello&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;Hello World Pass&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Important:Register for clang</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterStandardPasses <span class="title">Y</span><span class="params">(PassManagerBuilder::EP_EarlyAsPossible,</span></span></span><br><span class="line"><span class="params"><span class="function">  [](<span class="type">const</span> PassManagerBuilder &amp;Builder, legacy::PassManagerBase &amp;PM) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    PM.add(<span class="keyword">new</span> Hello());</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125;)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="2-编译动态库"><a href="#2-编译动态库" class="headerlink" title="2 编译动态库"></a>2 编译动态库</h2><h3 id="使用cmake"><a href="#使用cmake" class="headerlink" title="使用cmake"></a>使用cmake</h3><p>参考<a target="_blank" rel="noopener" href="https://llvm.org/docs/CMake.html#cmake-out-of-source-pass">官方文档</a>。</p>
<p>An example of a project layout is provided below.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;project <span class="built_in">dir</span>&gt;/</span><br><span class="line">    |</span><br><span class="line">    CMakeLists.txt</span><br><span class="line">    &lt;pass name&gt;/</span><br><span class="line">        |</span><br><span class="line">        CMakeLists.txt</span><br><span class="line">        Pass.cpp</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>Contents of <code>&lt;project dir&gt;/CMakeLists.txt</code>:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(LLVM REQUIRED CONFIG)</span><br><span class="line"></span><br><span class="line"><span class="keyword">separate_arguments</span>(LLVM_DEFINITIONS_LIST NATIVE_COMMAND <span class="variable">$&#123;LLVM_DEFINITIONS&#125;</span>)</span><br><span class="line"><span class="keyword">add_definitions</span>(<span class="variable">$&#123;LLVM_DEFINITIONS_LIST&#125;</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;LLVM_INCLUDE_DIRS&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span>(&lt;pass name&gt;)</span><br></pre></td></tr></table></figure>

<p>Contents of <code>&lt;project dir&gt;/&lt;pass name&gt;/CMakeLists.txt</code>:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_library</span>(LLVMPassname MODULE Pass.cpp)</span><br></pre></td></tr></table></figure>

<p>运行cmake编译。产生<code>LLVMPassname.so</code>文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">cmake .. &amp;&amp; make</span><br></pre></td></tr></table></figure>

<!-- 下面回答部分**来自ChatGPT-3.5**，暂时没有校验其可靠性(看上去貌似说得通)。 -->

<h3 id="使用命令行"><a href="#使用命令行" class="headerlink" title="使用命令行"></a>使用命令行</h3><p>请阅读<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/122522485">知乎的文章</a></p>
<h2 id="3-使用"><a href="#3-使用" class="headerlink" title="3 使用"></a>3 使用</h2><h3 id="opt加载Pass"><a href="#opt加载Pass" class="headerlink" title="opt加载Pass"></a>opt加载Pass</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clang -c -emit-llvm main.c -o main.bc <span class="comment"># 随意写一个C代码并编译到bc格式</span></span><br><span class="line">opt -load path/to/LLVMHello.so -hello main.bc -o /dev/null</span><br></pre></td></tr></table></figure>

<p>把源代码编译成IR代码，然后用opt运行Pass实在麻烦且无趣。</p>
<h3 id="clang加载Pass"><a href="#clang加载Pass" class="headerlink" title="clang加载Pass"></a>clang加载Pass</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clang -Xclang -load -Xclang path/to/LLVMHello.so main.c -o main</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">clang++ -Xclang -load -Xclang ./build/hello/libLLVMPassname.so test.cpp -o main</span><br></pre></td></tr></table></figure>

<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="插入代码"><a href="#插入代码" class="headerlink" title="插入代码"></a>插入代码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">InjectSimMagic2</span><span class="params">(Module &amp;M, Instruction *insertPt, <span class="type">uint64_t</span> arg0, <span class="type">uint64_t</span> arg1, <span class="type">uint64_t</span> arg2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LLVMContext &amp;ctx = M.<span class="built_in">getContext</span>();</span><br><span class="line">    std::vector&lt;Type *&gt; argtype &#123;</span><br><span class="line">        Type::<span class="built_in">getInt64Ty</span>(ctx), Type::<span class="built_in">getInt64Ty</span>(ctx), Type::<span class="built_in">getInt64Ty</span>(ctx)</span><br><span class="line">    &#125;;</span><br><span class="line">    FunctionType *ty = FunctionType::<span class="built_in">get</span>(</span><br><span class="line">        Type::<span class="built_in">getVoidTy</span>(ctx), argtype, <span class="literal">false</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// template of Sniper&#x27;s SimMagic0</span></span><br><span class="line">    InlineAsm *ia = InlineAsm::<span class="built_in">get</span>(</span><br><span class="line">        ty,</span><br><span class="line">        <span class="string">&quot;\tmov $0, %rax \n&quot;</span></span><br><span class="line">        <span class="string">&quot;\tmov $1, %rbx \n&quot;</span></span><br><span class="line">        <span class="string">&quot;\tmov $2, %rcx \n&quot;</span></span><br><span class="line">        <span class="string">&quot;\txchg %bx, %bx\n&quot;</span>,</span><br><span class="line">        <span class="string">&quot;imr,imr,imr,~&#123;rax&#125;,~&#123;rbx&#125;,~&#123;rcx&#125;,~&#123;dirflag&#125;,~&#123;fpsr&#125;,~&#123;flags&#125;&quot;</span>,</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">    );</span><br><span class="line">    Value *val0 = ConstantInt::<span class="built_in">get</span>(IntegerType::<span class="built_in">get</span>(ctx, <span class="number">64</span>), arg0);</span><br><span class="line">    Value *val1 = ConstantInt::<span class="built_in">get</span>(IntegerType::<span class="built_in">get</span>(ctx, <span class="number">64</span>), arg1);</span><br><span class="line">    Value *val2 = ConstantInt::<span class="built_in">get</span>(IntegerType::<span class="built_in">get</span>(ctx, <span class="number">64</span>), arg2);</span><br><span class="line">    std::vector&lt;Value *&gt; arglist &#123;val0, val1, val2&#125;;</span><br><span class="line">    CallInst::<span class="built_in">Create</span>(</span><br><span class="line">            ia, arglist, <span class="string">&quot;&quot;</span>, insertPt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码使用内联汇编嵌入到 LLVM IR 中，指令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov $0, %rax</span><br><span class="line">mov $1, %rbx</span><br><span class="line">mov $2, %rcx</span><br><span class="line">xchg %bx, %bx</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li>mov $0, %rax 将立即数 arg0 装载到通用寄存器 %rax 中。</li>
<li>mov $1, %rbx 将立即数 arg1 装载到通用寄存器 %rbx 中。</li>
<li>mov $2, %rcx 将立即数 arg2 装载到通用寄存器 %rcx 中。</li>
<li>xchg %bx, %bx 是一条无操作指令，用于保证该汇编代码的原子性。</li>
</ul>
<h3 id="打印每个BBL内的汇编指令"><a href="#打印每个BBL内的汇编指令" class="headerlink" title="打印每个BBL内的汇编指令"></a>打印每个BBL内的汇编指令</h3><p>由于直接打印的是llvm IR的表示，想要打印特定架构比如x86的汇编代码，其实需要进行llvm后端的转换。（取巧，可执行文件反汇编，然后根据插入的汇编桩划分）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="需要进一步的研究学习"><a href="#需要进一步的研究学习" class="headerlink" title="需要进一步的研究学习"></a>需要进一步的研究学习</h2><p>暂无</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>暂无</p>
<h2 id="开题缘由、总结、反思、吐槽"><a href="#开题缘由、总结、反思、吐槽" class="headerlink" title="开题缘由、总结、反思、吐槽~~"></a>开题缘由、总结、反思、吐槽~~</h2><p>复现PIMProf论文时，用到了使用 llvm pass来插入特殊汇编</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a target="_blank" rel="noopener" href="https://www.llvm.org/docs/WritingAnLLVMPass.html">https://www.llvm.org/docs/WritingAnLLVMPass.html</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/122522485">https://zhuanlan.zhihu.com/p/122522485</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-10-20T16:00:00.000Z" title="10/20/2021, 4:00:00 PM">2021-10-20</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-01-28T14:04:36.260Z" title="1/28/2024, 2:04:36 PM">2024-01-28</time></span><span class="level-item"><a class="link-muted" href="/categories/Tutorials/">Tutorials</a></span><span class="level-item">4 minutes read (About 563 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/10/20/Work/HPC/llvm-mca/LLVM-mca3/">LLVM Mca : huawei HiSilicon&#039;s TSV110 work</a></p><div class="content"><h2 id="几个对比图"><a href="#几个对比图" class="headerlink" title="几个对比图"></a>几个对比图</h2><p><img src="https://pic.shaojiemike.top/img/20210918160557.png"></p>
<p>x轴的含义是改变port值的意思，比如<code>tsv110alu2</code>是在<code>tsv110</code>的基础上将alu的值改成2</p>
<h2 id="相关的-git-commit"><a href="#相关的-git-commit" class="headerlink" title="相关的 git commit"></a>相关的 git commit</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">commit c9ca3a3c66a493d72cf7afc7ee975e2de399f2e5</span><br><span class="line">Author: Elvina Yakubova &lt;elvina.yakubova@huawei.com&gt;</span><br><span class="line">Date:   Sat Nov 7 01:50:43 2020 +0300</span><br><span class="line"></span><br><span class="line">    [AArch64] Add driver tests for HiSilicon&#x27;s TSV110</span><br><span class="line"></span><br><span class="line">commit 93b99728b1676d23ab5dabc606344230d25e7f4b</span><br><span class="line">Author: Elvina Yakubova &lt;elvina.yakubova@huawei.com&gt;</span><br><span class="line">Date:   Sat Nov 7 01:22:35 2020 +0300</span><br><span class="line"></span><br><span class="line">    [AArch64] Add pipeline model for HiSilicon&#x27;s TSV110</span><br><span class="line"></span><br><span class="line">    This patch adds the scheduling and cost model for TSV110.</span><br><span class="line"></span><br><span class="line">    Reviewed by: SjoerdMeijer, bryanpkc</span><br><span class="line"></span><br><span class="line">    Differential Revision: https://reviews.llvm.org/D89972</span><br><span class="line"></span><br><span class="line">commit 123553921f86ac0fad7b742740aa45e8d380be02</span><br><span class="line">Author: Bryan Chan &lt;bryan.chan@huawei.com&gt;</span><br><span class="line">Date:   Fri Nov 9 19:32:08 2018 +0000</span><br><span class="line"></span><br><span class="line">    [AArch64] Support HiSilicon&#x27;s TSV110 processor</span><br><span class="line"></span><br><span class="line">    Reviewers: t.p.northover, SjoerdMeijer, kristof.beyls</span><br><span class="line"></span><br><span class="line">    Reviewed By: kristof.beyls</span><br><span class="line"></span><br><span class="line">    Subscribers: olista01, javed.absar, kristof.beyls, kristina, llvm-commits</span><br><span class="line"></span><br><span class="line">    Differential Revision: https://reviews.llvm.org/D53908</span><br><span class="line"></span><br><span class="line">    llvm-svn: 346546	</span><br></pre></td></tr></table></figure>
<p>只有3个，感觉和2个功能很相关。</p>
<h2 id="最近-Driver-commit"><a href="#最近-Driver-commit" class="headerlink" title="最近 Driver commit"></a>最近 Driver commit</h2><p><a target="_blank" rel="noopener" href="https://shaojiemike.notion.site/Huawei-work-on-llvm-mca-recur-e338f3133a10416ebdaa596e27e5c5b7">类似的llvm check的设置</a></p>
<h2 id="复现上面的图"><a href="#复现上面的图" class="headerlink" title="复现上面的图"></a>复现上面的图</h2><h3 id="要改的地方"><a href="#要改的地方" class="headerlink" title="要改的地方"></a>要改的地方</h3><p>应该每次都要重新编译安装<br><img src="https://pic.shaojiemike.top/img/20210923203642.png"></p>
<h3 id="测试的汇编代码"><a href="#测试的汇编代码" class="headerlink" title="测试的汇编代码"></a>测试的汇编代码</h3><ol>
<li>判断<code>llvm/test/MC/AArch64</code>下的汇编能用吗?选个最大的，neon 不支持， armv8.2也并不支持。感觉有特别要求<img src="https://pic.shaojiemike.top/img/20211021152612.png"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat neon-diagnostics.s|llvm-mca -timeline -show-encoding -all-stats -all-views</span><br></pre></td></tr></table></figure></li>
<li>选择osaca的benchmark里的add.c</li>
</ol>
<h2 id="AArch64SchedTSV110-td"><a href="#AArch64SchedTSV110-td" class="headerlink" title="AArch64SchedTSV110.td"></a>AArch64SchedTSV110.td</h2><p>locate at llvm&#x2F;lib&#x2F;Target&#x2F;AArch64&#x2F;AArch64SchedTSV110.td</p>
<h3 id="td-file"><a href="#td-file" class="headerlink" title="td file"></a>td file</h3><p>tablegen(LLVM class) definitions</p>
<h3 id="部分指令解释"><a href="#部分指令解释" class="headerlink" title="部分指令解释"></a>部分指令解释</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def : InstRW&lt;[TSV110Wr_2cyc_1MDU],   (instregex <span class="string">&quot;^(AND|BIC|EON|EOR|ORN|ORR)[WX]rs$&quot;</span>)&gt;;</span><br></pre></td></tr></table></figure>
<p>BIC (bit clear) EON (Exclusive OR) ORR (OR operations on the values in Rn and Operand2)</p>
<p>InstRW的定义</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Map a set of opcodes to a list of SchedReadWrite types. This allows</span></span><br><span class="line"><span class="comment">// the subtarget to easily override specific operations.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// SchedModel ties this opcode mapping to a processor.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InstRW</span>&lt;list&lt;SchedReadWrite&gt; rw, dag instrlist&gt; &#123;</span><br><span class="line">  list&lt;SchedReadWrite&gt; OperandReadWrites = rw;</span><br><span class="line">  dag Instrs = instrlist;</span><br><span class="line">  SchedMachineModel SchedModel = ?;</span><br><span class="line">  <span class="comment">// Allow a subtarget to mark some instructions as unsupported.</span></span><br><span class="line">  bit Unsupported = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TSV110Wr_2cyc_1MDU的定义</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def TSV110Wr_2cyc_1MDU   : SchedWriteRes&lt;[TSV110UnitMDU]&gt;   &#123; let Latency = <span class="number">2</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SchedWriteRes</span>&lt;list&lt;ProcResourceKind&gt; resources&gt; : SchedWrite,</span><br><span class="line">  ProcWriteResources&lt;resources&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义TSV110上可用的每种处理器资源和数量，</span></span><br><span class="line"><span class="comment">//它有8条pipeline管道，每个管道都有自己的队列，微操作在那里等待</span></span><br><span class="line"><span class="comment">//它们的operands和issue将无序地发送到八个执行管道之一。</span></span><br><span class="line">def TSV110UnitMDU  : ProcResource&lt;<span class="number">1</span>&gt;; <span class="comment">// Multi-Cycle</span></span><br></pre></td></tr></table></figure>
<h2 id="需要进一步的研究学习"><a href="#需要进一步的研究学习" class="headerlink" title="需要进一步的研究学习"></a>需要进一步的研究学习</h2><p>暂无</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>暂无</p>
<h2 id="开题缘由、总结、反思、吐槽"><a href="#开题缘由、总结、反思、吐槽" class="headerlink" title="开题缘由、总结、反思、吐槽~~"></a>开题缘由、总结、反思、吐槽~~</h2><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><div id='refer-anchor'></div>
无

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-10-09T16:00:00.000Z" title="10/9/2021, 4:00:00 PM">2021-10-09</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-01-28T14:04:36.260Z" title="1/28/2024, 2:04:36 PM">2024-01-28</time></span><span class="level-item"><a class="link-muted" href="/categories/Tutorials/">Tutorials</a></span><span class="level-item">28 minutes read (About 4164 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/10/09/Work/HPC/llvm-mca/LLVM-mca4/">LLVM Mca ：with BHive (2019)</a></p><div class="content"><h2 id="BHive"><a href="#BHive" class="headerlink" title="BHive"></a>BHive</h2><p>一种新的profiler，可以profile没有用户干预的内存访问的基本块。</p>
<p>基于这种profiler创建了BHive,来验证llvm-mca等模型。</p>
<p>BHive是用来评价llvm-mca这些模型的，实验基于各种收集来的<strong>一个基本块</strong>各种评价</p>
<h2 id="I-INTRODUCTION"><a href="#I-INTRODUCTION" class="headerlink" title="I. INTRODUCTION"></a>I. INTRODUCTION</h2><h3 id="Automatically-Profiling-Basic-Blocks"><a href="#Automatically-Profiling-Basic-Blocks" class="headerlink" title="Automatically Profiling Basic Blocks"></a>Automatically Profiling Basic Blocks</h3><p>困难在于现有的 没有考虑 memory crash ??? .默认命中L1 cache</p>
<p>A <strong>key technical challenge</strong> with collecting a large basic block dataset is that there is no existing approach to profile an arbitrary basic block that has been removed from its program<br>context.</p>
<p>(没懂？那为什么要removed from its program<br>context) 因为要把常用的应用拆成小例子来评判，这些模型的准确性。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>运用隐含狄利克雷分布LDA,基于cpu资源的利用率，来cluster benchmark suite里的基本块</p>
<p>通过对各种类型最基本的代码块来进行profile，从而形成针对各种performance model的数据库。</p>
<p>现在已经有超过30万的基本块分析，来源于各种方向的应用，包括数值计算OpenBLAS,数据库SQLite,机器学习TensorFlow，密码学OpenSSL。</p>
<p>这么多的数据产生了一个用于评估performance model的新benchmark。</p>
<p>作者说<strong>performance modeling 研究的未来在于与其他先进技术的大规模定量比较</strong></p>
<h3 id="内存访问的处理"><a href="#内存访问的处理" class="headerlink" title="内存访问的处理"></a>内存访问的处理</h3><p>通过把虚拟页面映射到<strong>单个</strong>物理页面，来合法内存访问同时避免cache miss</p>
<h2 id="II-背景"><a href="#II-背景" class="headerlink" title="II. 背景"></a>II. 背景</h2><h3 id="Existing-Performance-Models"><a href="#Existing-Performance-Models" class="headerlink" title="Existing Performance Models"></a>Existing Performance Models</h3><p>有两种model</p>
<ol>
<li>产生可以详细描述指令何时发射和退休的可解释执行路径的微架构模拟器，附带吞吐量预测。</li>
<li>每条指令都有延迟、吞吐量查找表，相当于一个被寄存器分配器使用的额外开销估计器</li>
</ol>
<p>各种model, 写到另一篇里了</p>
<ol>
<li>IACA</li>
<li>llvm-mca</li>
<li>OSACA</li>
<li>Ithemal</li>
</ol>
<h3 id="Machine-Code-Profilers"><a href="#Machine-Code-Profilers" class="headerlink" title="Machine Code Profilers"></a>Machine Code Profilers</h3><ol>
<li>通过 Agner Fog’s script 测量真实的，有周期，cache miss 等等。<a target="_blank" rel="noopener" href="https://www.agner.org/optimize/testp.zip">https://www.agner.org/optimize/testp.zip</a></li>
<li>nanoBench也是。<a target="_blank" rel="noopener" href="https://github.com/andreas-abel/nanoBench">https://github.com/andreas-abel/nanoBench</a> 可以指定processor?和 kernel模式。</li>
<li><strong>Unrolling</strong><ol>
<li>测量吞吐量的基本方法就是展开一个基本块的代码多次，然后测重复多次的代码。把展开的基本块latency除以<code>unroll factor</code>(典型值是100)</li>
<li>目的：<ol>
<li>边缘化前几次warm up的latency值的影响。</li>
<li>减少收起数据的开销影响</li>
</ol>
</li>
<li><code>unroll factor</code>就是循环展开次数。</li>
</ol>
</li>
<li><strong>局限性</strong>是，必须人工给代码块，不能自动profile一堆任意的基本块来系统性验证。???</li>
</ol>
<h2 id="III-PROFILING-ARBITRARY-BASIC-BLOCKS"><a href="#III-PROFILING-ARBITRARY-BASIC-BLOCKS" class="headerlink" title="III.  PROFILING ARBITRARY BASIC BLOCKS"></a>III.  PROFILING ARBITRARY BASIC BLOCKS</h2><p>目标是在<strong>不需要手动干预</strong>的情况下分析任意基本块，以便测量的<strong>吞吐量</strong>与性能模型通常假定的<strong>定义和不变量</strong>相对应。关键的挑战是使这些基本块能够在不崩溃的情况下<strong>访问任意内存地址</strong>。</p>
<p>由于基本块只是正常程序的一部分，导致根本不能单独正常运行。BHive做的事情就是，让他正常运行。</p>
<h3 id="Handling-Arbitrary-Memory-Accesses"><a href="#Handling-Arbitrary-Memory-Accesses" class="headerlink" title="Handling Arbitrary Memory Accesses"></a>Handling Arbitrary Memory Accesses</h3><p><img src="https://pic.shaojiemike.top/img/20211007210352.png"><br>这个代码块只有执行代码分配在<code>0x4110a</code>时，才能正常运行</p>
<ol>
<li>Remapping Virtual Pages.<ol>
<li>一个基本块的所有虚拟内存页重新映射到一个物理页上，所以全部数据访问都命中L1。这样就可以执行97%的基本块。</li>
<li>步骤<ol>
<li>把原本虚拟页全部unmap<ol>
<li>这会导致除了包含基本块指令的页之外的全部的连续的内存访问出问题？？？</li>
<li>在子进程里运行展开的基本块指令。<ol>
<li>这时对每个unmap的虚拟页的访问都会出错，但是主进程一种监视着。一旦中断就重新映射出错地址，然后重新开始跑。</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>Memory Initialization<ol>
<li>初始化一个中等大小0x12345600的物理页，允许都虚拟页都映射</li>
</ol>
</li>
<li>Virtual page aliasing<ol>
<li>因为不同的虚拟页映射在同一个物理页的同一项导致memory dependences，要等待</li>
<li><strong>剔除</strong>6.28%的基本块</li>
<li>可以通过增大物理页，来减小发生的概率。</li>
</ol>
</li>
</ol>
<h3 id="Overall-Profiling-Workflow"><a href="#Overall-Profiling-Workflow" class="headerlink" title="Overall Profiling Workflow"></a>Overall Profiling Workflow</h3><p>通过重复运行基本块来计算吞吐量</p>
<ol>
<li>Raw Measurement<ol>
<li>先从基本块里，产生不会memory crash的可执行部分。</li>
<li>unroll factor的选取。It uses 100 and 200 as the unroll factors for basic blocks <strong>smaller than 100 bytes</strong>; 50 and 100 for basic blocks <strong>between 100 bytes and 200 bytes</strong>; and finally 16 and 32 for basic blocks <strong>larger than 200 bytes</strong></li>
</ol>
</li>
<li>Filtering<ol>
<li>筛选执行代码满足理想化模型的执行结果，比如命中L1cache</li>
<li>L1 Cache Misses<ol>
<li>工具可以用硬件计数器监控指令和数据cache misses。拒绝所有cache miss的情况。</li>
</ol>
</li>
<li>Unaligned Loads<ol>
<li>不连续的访存会很慢，解决方法就是去除所有有不连续的访存的。大约删除了0.18%的基本块</li>
</ol>
</li>
<li>Subnormal Floating Point<ol>
<li>一些特殊的浮点数计算会比正常的浮点数计算慢20倍，去除了与MXCSR寄存器有关的0.1%的基本块。</li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/8341395/what-is-a-subnormal-floating-point-number">https://stackoverflow.com/questions/8341395/what-is-a-subnormal-floating-point-number</a></li>
</ol>
</li>
<li>Context Switches<ol>
<li>上下文切换(英语：context switch)，又称环境切换，电脑术语，是一个存储和重建CPU的状态 (内文)，因此令多个进程(process)可以分享单一CPU资源的计算过程。要切换CPU上的进程时，必需先行存储目前进程的状态，再将欲运行的进程之状态读回CPU中。</li>
</ol>
</li>
<li>可接受的评估公式 10%的误差？？？</li>
</ol>
</li>
<li>Throughput Calculation<ol>
<li>如果通过了基本块的筛选，用有记录的最小延迟计算吞吐量<img src="https://pic.shaojiemike.top/img/20210920154432.png"></li>
</ol>
</li>
<li>Environment Variance<ol>
<li>由于环境的影响，导致结果有个稳定的偏移。至少执行5次，展开16次的基本块。取最小的5次作为结果。</li>
</ol>
</li>
</ol>
<h3 id="Portability-to-Other-Architectures"><a href="#Portability-to-Other-Architectures" class="headerlink" title="Portability to Other Architectures"></a>Portability to Other Architectures</h3><p>只要架构满足以下几点要求</p>
<ol>
<li>有将多个虚拟页面映射到几个物理页面的API。map<br>multiple virtual pages to a few physical pages <ol>
<li><strong>without</strong> incurring a performance <strong>penalty</strong> due to unnecessary cache invalidation. We therefore require that the target processor has a **physically tagged data cache(VIPT)**？？？</li>
<li>we additionally require that the page size is small enough so the indexing bits are<br>not affected by address translation.</li>
</ol>
</li>
<li>detecting cache misses, </li>
<li>and detecting or disabling floating-point underflow.</li>
</ol>
<h2 id="IV-BASIC-BLOCK-DATASET"><a href="#IV-BASIC-BLOCK-DATASET" class="headerlink" title="IV. BASIC BLOCK DATASET"></a>IV. BASIC BLOCK DATASET</h2><p><img src="https://pic.shaojiemike.top/img/20210921190750.png"></p>
<p>应用的选择</p>
<ol>
<li>尽可能还原现实生活的各个方面，</li>
<li>而且是用户的典型用法。</li>
<li>Clang&#x2F;LLVM (compiler), Redis (inmemory database), SQLite (database), and Gzip 是用高级语言C或者C++编写的，算法和数据结构有复杂的设计。</li>
<li>OpenSSL (cryptography), OpenBLAS , Eigen (scientific computing),TensorFlow (machine learning) 代表的是核心循环是手动汇编优化过的高性能库。<ol>
<li>其中Embree是 用Intel ispc (a data-parallel language)编写的。</li>
</ol>
</li>
</ol>
<p>We compiled all applications with the <strong>highest optimization</strong> settings defined by their build systems. 如果可以用上了AVX2。</p>
<p>使用DynamoRIO动态分析来提炼基本块。可以实现在运行时记录每个运行的基本块。我们采用动态分析，而不是静态反汇编。因为静态反汇编无法区别padding bytes from instructions。???</p>
<p>应用的例子除了FFmpeg and Gzip都是选择的官方的benchmark。<br>Eigen 采用的是 two sparse linear algebra workloads: sparse matrix-matrix multiplication (SpMM) and sparse matrix-vector multiplication (SpMV).</p>
<h2 id="V-BASIC-BLOCK-CLUSTERING"><a href="#V-BASIC-BLOCK-CLUSTERING" class="headerlink" title="V. BASIC BLOCK CLUSTERING"></a>V. BASIC BLOCK CLUSTERING</h2><p>一些基本块比其他的更难建模，???(建什么模，VI-B说明了什么)有内存依赖的基本块预测错误率更高。</p>
<p>采用了一种技术???(是应用在提取上) 基于处理器的使用聚类基本块。<br>这个技术有助于性能模型的设计和使用者<strong>更细粒度了解</strong>performance model,让他们能集中以后新添加的资源在有困难的那一类基本块。</p>
<ol>
<li>Methodology<ol>
<li>具体方法<ol>
<li>找到每个基本块的硬件使用率的表示 port-mapping representation</li>
<li>根据其聚类</li>
</ol>
</li>
<li>对每条指令结合port使用<ol>
<li>运用 Abel and Reineke A. Abel and J. Reineke, “uops.info: Characterizing latency, throughput, and port usage of instructions on intel microarchitectures,” in ASPLOS, 2019的结果 ???</li>
<li>例如???<ol>
<li><code>xor %rax, %rbx</code> in Haswell is <code>&#123;p0156 → 1&#125;</code></li>
</ol>
</li>
</ol>
</li>
<li>使用<strong>Latent Dirichlet Allocation</strong> (LDA)来构建topic model 模型(python 训练模型)<ol>
<li>在语言处理上的应用是基于统计词频</li>
<li>在实际运用的时候，微指令操作会根据使用的port而有小不同。<ol>
<li>topics是分类的类别,6类</li>
<li>documents是基本块</li>
<li>α &#x3D; 1&#x2F;6 and β &#x3D; 1&#x2F;13.</li>
</ol>
</li>
<li>为了推断每个微指令操作所属的类别，我们使用了SciKit Learn transform对于LDA的随机变化推断的默认实现</li>
<li>计算每个基本块的最有可能的类别作为其分类结果</li>
</ol>
</li>
</ol>
</li>
<li>Results<ol>
<li>LDA将结果聚类后，根据基本块的内容，手动进行注名以及说明<img src="https://pic.shaojiemike.top/img/20211009165208.png"></li>
<li>example<img src="https://pic.shaojiemike.top/img/20211009165630.png"></li>
<li>根据运行时频率确定其权重， 基于sample-based profiler??? (A portable sampling-based profiler for java virtual machines,)确定。</li>
<li>高性能的库如预期一样，向量化的基本块占比较多。</li>
<li>其余的无向量化的较多。OpenSSL and Gzip有许多位操作的。</li>
</ol>
</li>
<li>Case Study on Data-Center Applications<ol>
<li>目的：作为测试例子，看这个聚类方法能不能找得到隐藏的热点、工作负载</li>
<li>Methodology<ol>
<li>第一步：首先将其基本块分成之前的几类，还是使用LDA</li>
<li>第二步：分类结果标注</li>
<li>第三步：比较聚类结果的perplexity值???</li>
<li>？？？有没有结合google的应用<img src="https://pic.shaojiemike.top/img/20211009173926.png"></li>
</ol>
</li>
<li>Results<ol>
<li>添加新应用后，该值只是略微增长。说明模型的代表性好。???</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="VI-PERFORMANCE-MODEL-EVALUATION"><a href="#VI-PERFORMANCE-MODEL-EVALUATION" class="headerlink" title="VI. PERFORMANCE MODEL EVALUATION"></a>VI. PERFORMANCE MODEL EVALUATION</h2><p>在3种Intel架构上验证4种已有的性能模型</p>
<ol>
<li>Methodology<ol>
<li>说明各个测试软件的版本。</li>
<li>Dataset<ol>
<li>basic block dataset discussed in Section IV</li>
</ol>
</li>
<li>Platform<ol>
<li>balabala 3种架构的 Intel cpus</li>
</ol>
</li>
<li>Evaluation Metrics<ol>
<li>测量吞吐量t和预测吞吐量t’$$err(t,t’)&#x3D;|\frac{t-t’}{t}|$$</li>
<li>不以预测精度，而是以预测结果的相对关系为评分标准。</li>
</ol>
</li>
<li>额外能评估每个模型如何保持基本块吞吐量的顺序。使用Kendall’s tau系数(越大效果越好)，而不是相对误差。测量的原因是使用者可能关心的不是绝对的数值精度，而是相对关系的准确率。比如优化软件的时候关心的不是具体耗时，而是哪个优化策略耗时更短。</li>
</ol>
</li>
<li>Results<ol>
<li><img src="https://pic.shaojiemike.top/img/20211010154102.png"></li>
<li><strong>IACA</strong> 第二好的，在向量化类模拟的最好</li>
<li><strong>llvm-mca</strong> 最差的，尤其是和loads有关时。</li>
<li><strong>Ithemal</strong>  除了向量基本块都是最好的。在memory dependence (Ld&#x2F;St)尤其好，但是向量基本块不好，可能与训练集没有向量基本块有关。</li>
<li><strong>OSACA</strong> 第三。由于还在开发中，使用还遇到5个bug。在遇到一些不认识的指令的时候，会直接按照nops空指令处理。</li>
</ol>
</li>
<li>Examples of Modeling Bugs<img src="https://pic.shaojiemike.top/img/20211010155758.png"><ol>
<li>最后一个例子是由于模型<strong>错误调度微指令</strong>导致的</li>
<li>Modeling bug due to unsigned division<ol>
<li>例子是 a 64-bit by 32-bit unsigned division.<img src="https://pic.shaojiemike.top/img/20211010162409.png"><img src="https://pic.shaojiemike.top/img/20211010163913.png"><img src="https://pic.shaojiemike.top/img/20211010164039.png"><img src="https://pic.shaojiemike.top/img/20211010164455.png"></li>
<li>???<img src="https://pic.shaojiemike.top/img/20211010164745.png"></li>
</ol>
</li>
<li>Modeling bug due to zero-idioms<ol>
<li><img src="https://pic.shaojiemike.top/img/20211010165301.png"></li>
<li>对这种结果固定的特殊指令的快速处理。</li>
</ol>
</li>
<li>Modeling bug due to mis-scheduling<ol>
<li>对于数据依赖，上下指令的寄存器有写后读。</li>
<li>Ithemal’s and OSACA忽略了该依赖</li>
<li><img src="https://pic.shaojiemike.top/img/20211010170051.png"></li>
<li>llvm-mca 没有注意到(%rcx)是memory，没有依赖可以提前发射。</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="CONCLUSION"><a href="#CONCLUSION" class="headerlink" title="CONCLUSION"></a>CONCLUSION</h2><p>现有的静态分析器对<strong>内存依赖</strong>和<strong>向量化块</strong>的建模还有困难。</p>
<h2 id="github代码说明"><a href="#github代码说明" class="headerlink" title="github代码说明"></a>github代码说明</h2><ol>
<li><code>benchmark/sources</code>下是各种软件的各个部分的16进制基本代码块和其出现概率，用csv格式(逗号分隔值 (Comma-separated values))存储</li>
<li><code>benchmark/throughput</code>是在各种架构下的各基本块的测量吞吐量，单位cycles per hundred-iterations.<br><img src="https://pic.shaojiemike.top/img/20210920151028.png"><img src="https://pic.shaojiemike.top/img/20210920154432.png"></li>
<li><code>benchmark/disasm</code>可以把16进制代码通过<code>nasm</code>变成汇编，<img src="https://pic.shaojiemike.top/img/20210920151258.png"></li>
<li><code>timing-harness</code><img src="https://pic.shaojiemike.top/img/20210920153113.png"><br><img src="https://pic.shaojiemike.top/img/20210921143255.png"><br>吞吐量的计算(猜的)Skylake microarchitecture$$\frac{6632-1030}{2333-100}*100&#x3D;250.8 (cyc&#x2F;hundred\ iters)$$</li>
</ol>
<h2 id="BHive-被质疑的局限性"><a href="#BHive-被质疑的局限性" class="headerlink" title="BHive 被质疑的局限性"></a>BHive 被质疑的局限性</h2><p>uops 的文章， Accurate Throughput Prediction of Basic Blocks on Recent Intel Microarchitectures</p>
<p>4.2 Extending BHive</p>
<h2 id="BHive-运行逻辑"><a href="#BHive-运行逻辑" class="headerlink" title="BHive 运行逻辑"></a>BHive 运行逻辑</h2><ol>
<li>读入16进制代码和循环次数</li>
<li><code>hhex2bin</code>转换为二进制</li>
<li><code>create_shm_fd</code><img src="https://pic.shaojiemike.top/img/20210922150852.png"><img src="https://pic.shaojiemike.top/img/20210922151143.png"><ol>
<li><p><code>shm_open, shm_unlink</code>creates and opens a new, or opens or unlink an existing, POSIX shared memory object. <code>O_RDWR</code> Open the object for read-write access.<code>O_CREAT</code>  the shared memory object if it does not exist. <code>777</code>是类似文件读写执行组权限的东西 On success, shm_open() <code>returns</code> a file descriptor (a nonnegative integer)</p>
</li>
<li><p><code>POSIX</code>可移植操作系统接口The Portable Operating System Interface 是IEEE为要在各种UNIX操作系统上运行软件，而定义API的一系列互相关联的标准的总称。</p>
</li>
<li><p><code>ftruncate</code> — truncate截短 a file to a specified length</p>
</li>
<li><p>#define SIZE_OF_HARNESS_MEM (4096 * 3)</p>
</li>
</ol>
</li>
<li><code>measure</code>开始测量<ol>
<li>int fds[2] ???</li>
<li><code>pipe</code>用于创建pipe,用来<strong>进程间</strong>通信的<strong>单向</strong>数据通路，传入变量用来返回引用自pipe末端的文件描述符file descriptors。<strong>第一个</strong>指向the read end of the pipe，<strong>第二个</strong>指向the write end of the pipe</li>
<li><code>mmap(void *addr, size_t length, int prot, int flags,int fd, off_t offset); munmap(void *addr, size_t length);</code>- map or unmap files or devices into memory 在调用进程的虚拟地址空间里create a new mapping.</li>
<li>fork()产生子进程<ol>
<li>fork()原理详解<ol>
<li>复制之前的一模一样。</li>
<li>fork() returns a zero to the newly created child process.</li>
<li>fork() returns a positive value, the process ID of the child process, to the parent.</li>
</ol>
</li>
<li>父进程<ol>
<li>#define OFFSET_TO_COUNTERS 32</li>
<li>为什么声明一个偏移地址指针???<ol>
<li>struct pmc_counters 由5个uint64_t组成。 uint64 will always take 8 bytes。一个结构体40bytes</li>
</ol>
</li>
<li><code>attach_to_child(pid, fds[1]);</code> pid是子进程pid<ol>
<li><code>ptrace(enum __ptrace_request request, pid_t pid,void *addr, void *data)</code> - process trace 提供一种进程tracer跟踪控制另一个进程tracee的方法，可以修改被控制者的memory and registers.<ol>
<li><code>PTRACE_SEIZE</code> Attach to the process specified in pid, making it a tracee of the calling process.  Unlike PTRACE_ATTACH, PTRACE_SEIZE does <strong>not</strong> stop the process</li>
</ol>
</li>
<li>子进程从fds[0]里读到x里，父进程把x的值写入 fds[1] ???</li>
</ol>
</li>
<li>check Performance Monitoring Counters (PMCs) supports<ol>
<li><code>rdpmc_open_attr</code> initialize a raw ring 3 ReaDable PerforMance Counter</li>
</ol>
</li>
<li>last_failing_inst 和 mapping_done</li>
<li>To kill child<ol>
<li>#define MAX_FAULTS 1024 # 子进程产生的错误需要解决？</li>
<li><code>wait</code>挂起当前线程，直到有一个children结束，返回其PID</li>
<li><code>WIFEXITED</code>Wait_IF_EXITED 判断是否正常结束<img src="https://pic.shaojiemike.top/img/20210922185030.png"></li>
<li>如果错误打印出错信号(eg.11)指令指针寄存器RIP,指针寄存器RSP<img src="https://pic.shaojiemike.top/img/20210922190632.png"><img src="https://pic.shaojiemike.top/img/20210922191039.png"><img src="https://pic.shaojiemike.top/img/20210922191252.png"></li>
<li>函数是用汇编写的就离谱<img src="https://pic.shaojiemike.top/img/20210922191507.png"><img src="https://pic.shaojiemike.top/img/20210922193149.png"><img src="https://pic.shaojiemike.top/img/20210922192559.png"><img src="https://pic.shaojiemike.top/img/20210922191801.png"><img src="https://pic.shaojiemike.top/img/20210922191931.png">what is aux mem?</li>
<li>修改出错地方的寄存器，重新运行<code>PTRACE_CONT</code> Restart the stopped tracee process</li>
<li>最多执行MAX_FAULTS次</li>
</ol>
</li>
<li>最后父进程杀死子进程</li>
</ol>
</li>
<li>子进程<ol>
<li>父进程测试是否支持PMCs,子进程使用<img src="https://pic.shaojiemike.top/img/20210922194738.png"><img src="https://pic.shaojiemike.top/img/20210922195030.png"></li>
<li>harness.c ：277</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/from-zero/p/13750852.html">https://www.cnblogs.com/from-zero/p/13750852.html</a></p>
<h2 id="需要进一步的研究学习"><a href="#需要进一步的研究学习" class="headerlink" title="需要进一步的研究学习"></a>需要进一步的研究学习</h2><p>暂无</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><ol>
<li>time 怎么算的the latency of the basic block？为什么打印15个呢？</li>
<li>还有中间的错误是怎么回事?</li>
<li>论文里的误差怎么算的？<ol>
<li>BHive整合了几个软件（整合了什么呢），应该是真实测量了得出真实吞吐量？还是也是模拟的？</li>
<li>和uops比怎么样</li>
</ol>
</li>
<li>哪个数据是准确的，是BHive模拟的，还是真实测量的。<ol>
<li>通过 Agner Fog’s script 测量真实的，有周期，cache miss 等等。<a target="_blank" rel="noopener" href="https://www.agner.org/optimize/testp.zip">https://www.agner.org/optimize/testp.zip</a></li>
<li>nanoBench也是。<a target="_blank" rel="noopener" href="https://github.com/andreas-abel/nanoBench">https://github.com/andreas-abel/nanoBench</a> 可以指定processor?和 kernel模式。</li>
<li>局限性是，必须人工给代码块，不能自动profile一堆任意的基本块来系统性验证。???</li>
</ol>
</li>
<li>BHvie的代码实现，移植到鲲鹏，然后根据PMU调准。</li>
</ol>
<p>问题是x86的二进制或者汇编不能变成aarm64的二进制或者汇编。</p>
<h2 id="开题缘由、总结、反思、吐槽"><a href="#开题缘由、总结、反思、吐槽" class="headerlink" title="开题缘由、总结、反思、吐槽~~"></a>开题缘由、总结、反思、吐槽~~</h2><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a target="_blank" rel="noopener" href="https://github.com/ithemal/bhive">https://github.com/ithemal/bhive</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-09-18T15:01:13.000Z" title="9/18/2021, 3:01:13 PM">2021-09-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-01-28T14:04:36.252Z" title="1/28/2024, 2:04:36 PM">2024-01-28</time></span><span class="level-item"><a class="link-muted" href="/categories/Architecture/">Architecture</a></span><span class="level-item">2 minutes read (About 332 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/09/18/Work/Architecture/companySpecificDesign/kunpeng/">Kunpeng</a></p><div class="content"><p><img src="https://pic.shaojiemike.top/img/20220706191616.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706191804.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706194535.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706192133.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706192208.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706192401.png"></p>
<p>多线程SMT (Simultaneous multithreading)</p>
<p><img src="https://pic.shaojiemike.top/img/20220706192649.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706192925.png"><br>统一的调度器复杂度超级高，只有Intel实现了，但是效果很好。</p>
<p><img src="https://pic.shaojiemike.top/img/20220706193012.png"></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/51354994">什么是CPU Die</a></p>
<p><img src="https://pic.shaojiemike.top/img/20220706193217.png"><br>良品率会更高</p>
<p><img src="https://pic.shaojiemike.top/img/20220706193253.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706193414.png"><br>自研OpenBLAS+ ，毕申编译器，自研MPI</p>
<p><img src="https://pic.shaojiemike.top/img/20220706193501.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706193531.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706193559.png"></p>
<p>片间一致性可以到达4P到16P？？？。Intel可以达到8P</p>
<p><img src="https://pic.shaojiemike.top/img/20220706194215.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706194305.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706194356.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706194744.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706195047.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706194818.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706194901.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706194929.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706195017.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706195134.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706195252.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706195417.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706195438.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20220706195506.png"></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ol>
<li>虽然说是保密的，但是鲲鹏930,950应该已经出来了<ol>
<li>930，950是异构的核(是大小核吗？)</li>
</ol>
</li>
</ol>
<h2 id="需要进一步的研究学习"><a href="#需要进一步的研究学习" class="headerlink" title="需要进一步的研究学习"></a>需要进一步的研究学习</h2><p>暂无</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>暂无</p>
<h2 id="开题缘由、总结、反思、吐槽"><a href="#开题缘由、总结、反思、吐槽" class="headerlink" title="开题缘由、总结、反思、吐槽~~"></a>开题缘由、总结、反思、吐槽~~</h2><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a target="_blank" rel="noopener" href="https://bbs.huaweicloud.com/blogs/268031">https://bbs.huaweicloud.com/blogs/268031</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-09-15T02:29:03.000Z" title="9/15/2021, 2:29:03 AM">2021-09-15</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-01-28T14:04:36.260Z" title="1/28/2024, 2:04:36 PM">2024-01-28</time></span><span class="level-item"><a class="link-muted" href="/categories/Tutorials/">Tutorials</a></span><span class="level-item">6 minutes read (About 895 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/09/15/Work/HPC/llvm-mca/LLVM-mca2/">LLVM-MCA: Install&amp;RunTests</a></p><div class="content"><h2 id="github"><a href="#github" class="headerlink" title="github"></a>github</h2><p><a target="_blank" rel="noopener" href="https://github.com/llvm/llvm-project/tree/main/llvm/tools/llvm-mca">https://github.com/llvm/llvm-project/tree/main/llvm/tools/llvm-mca</a></p>
<p><img src="https://pic.shaojiemike.top/img/20210910210630.png"></p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p><a target="_blank" rel="noopener" href="https://github.com/llvm/llvm-project/releases/tag/llvmorg-12.0.1">下载可执行文件</a>上传服务器，解压</p>
<h3 id="安装遇到的问题"><a href="#安装遇到的问题" class="headerlink" title="安装遇到的问题"></a>安装遇到的问题</h3><ol>
<li>cannot find libtinfo.so.5<ol>
<li>sudo apt install libncurses5</li>
<li>ln -s &#x2F;usr&#x2F;lib&#x2F;libncursesw.so.6 &#x2F;usr&#x2F;lib&#x2F;libtinfo.so.5 或者类似的 ln -s &#x2F;usr&#x2F;lib&#x2F;libncurses.so.5 &#x2F;usr&#x2F;lib&#x2F;libtinfo.so.5 </li>
<li>在&#x2F;snap&#x2F;core下找到了，但是这是什么目录？是之前Ubuntu的包管理工具，但是已经不用了。</li>
</ol>
</li>
</ol>
<h3 id="从源码安装"><a href="#从源码安装" class="headerlink" title="从源码安装"></a>从源码安装</h3><h3 id="node5"><a href="#node5" class="headerlink" title="node5"></a>node5</h3><p>由于之后要写代码的，还是从头安装更好。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd llvm-project</span><br><span class="line">mkdir build</span><br><span class="line">cmake -S llvm -B build -G &quot;Unix Makefiles&quot; -DLLVM_ENABLE_PROJECTS=&quot;clang;llvm-mca&quot; -DCMAKE_INSTALL_PREFIX=&quot;~/Install/llvm&quot; -DCMAKE_BUILD_TYPE=Debug -DLLVM_ENABLE_ASSERTIONS=On</span><br><span class="line">cd build</span><br><span class="line">make -j32</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h3 id="kunpeng"><a href="#kunpeng" class="headerlink" title="kunpeng"></a>kunpeng</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmake -S llvm -B build -G &quot;Unix Makefiles&quot; -DLLVM_ENABLE_PROJECTS=all -DCMAKE_INSTALL_PREFIX=&quot;~/Install/llvm&quot; -DCMAKE_BUILD_TYPE=Debug -DLLVM_ENABLE_ASSERTIONS=On</span><br><span class="line">#change cmake or -DLLVM_ENABLE_PROJECTS=&quot;all&quot;</span><br></pre></td></tr></table></figure>
<p>error</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">g++: error: unrecognized command line option ‘-mllvm’</span><br><span class="line">g++: error: unrecognized command line option ‘--tail-merge-threshold=0’</span><br><span class="line">g++: error: unrecognized command line option ‘-combiner-global-alias-analysis’</span><br></pre></td></tr></table></figure>
<p>change</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -S llvm -B build -G &quot;Unix Makefiles&quot; -DLLVM_ENABLE_PROJECTS=&quot;clang;llvm-mca&quot; -DCMAKE_INSTALL_PREFIX=&quot;~/Install/llvm&quot; -DLLVM_TARGETS_TO_BUILD=AArch64 -DCMAKE_BUILD_TYPE=Debug -DLLVM_ENABLE_ASSERTIONS=On</span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang foo.c -O2 -target x86_64-unknown-unknown -S -o - | llvm-mca -mcpu=btver2</span><br></pre></td></tr></table></figure>
<p>由于不是X86,<code>llc --version</code> 查看到target是 <code>aarch64-unknown-linux-gnu</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang /home/shaojiemike/Download/llvm-project-main/lldb/test/API/lang/c/forward/foo.c -O2 -target aarch64-unknown-linux-gnu -S -o -|llvm-mca -timeline -show-encoding -all-stats -all-views</span><br></pre></td></tr></table></figure>
<p>生成汇编代码，并默认管道到llvm-mca,并开启所有输出。</p>
<p>可以看出是用TSV110Unit的port,默认cpu是tsv110</p>
<h2 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h2><h3 id="ALU-BRU"><a href="#ALU-BRU" class="headerlink" title="ALU&#x2F;BRU"></a>ALU&#x2F;BRU</h3><p> 算数逻辑单元 ALU 负责处理整数运算指令. 跳转处理单元BRU 负责处理跳转指令. BRU 可以与 ALU 合并, 复用 ALU 的逻辑来计算跳转指令的条件和跳转地址, 也可以作为一个单独的功能单元接入到流水线中.</p>
<h3 id="MDU"><a href="#MDU" class="headerlink" title="MDU"></a>MDU</h3><p>乘除法单元 MDU (mult-divide unit)</p>
<h2 id="需要进一步的研究学习"><a href="#需要进一步的研究学习" class="headerlink" title="需要进一步的研究学习"></a>需要进一步的研究学习</h2><ol>
<li>llvm-mca微指令怎么实现的,怎么把汇编变成微指令</li>
<li>在view里加memory的实现</li>
<li>考虑了cache命中等影响 <a target="_blank" rel="noopener" href="https://github.com/andreas-abel/uiCA">https://github.com/andreas-abel/uiCA</a> uops</li>
<li>鲲鹏架构 <a target="_blank" rel="noopener" href="https://bbs.huaweicloud.com/community/usersnew/id_1513665626477516">https://bbs.huaweicloud.com/community/usersnew/id_1513665626477516</a></li>
</ol>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><ol>
<li><code>llvm-mca -mcpu=help</code>竟然会卡住，不知道为什么</li>
<li>所以说是华为已经写了一个叫tsv110的，实现2个功能？</li>
</ol>
<h2 id="开题缘由、总结、反思、吐槽"><a href="#开题缘由、总结、反思、吐槽" class="headerlink" title="开题缘由、总结、反思、吐槽~~"></a>开题缘由、总结、反思、吐槽~~</h2><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><div id='refer-anchor'></div>
无

<h2 id="样例输出"><a href="#样例输出" class="headerlink" title="样例输出"></a>样例输出</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">Iterations:        100</span><br><span class="line">Instructions:      200</span><br><span class="line">Total Cycles:      70</span><br><span class="line">Total uOps:        200</span><br><span class="line"></span><br><span class="line">Dispatch Width:    4</span><br><span class="line">uOps Per Cycle:    2.86</span><br><span class="line">IPC:               2.86</span><br><span class="line">Block RThroughput: 0.5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">No resource or data dependency bottlenecks discovered.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Instruction Info:</span><br><span class="line">[1]: #uOps</span><br><span class="line">[2]: Latency</span><br><span class="line">[3]: RThroughput</span><br><span class="line">[4]: MayLoad</span><br><span class="line">[5]: MayStore</span><br><span class="line">[6]: HasSideEffects (U)</span><br><span class="line">[7]: Encoding Size</span><br><span class="line"></span><br><span class="line">[1]    [2]    [3]    [4]    [5]    [6]    [7]    Encodings:                    Instructions:</span><br><span class="line"> 1      1     0.33                         4     20 00 80 52                   mov	w0, #1</span><br><span class="line"> 1      1     0.50                  U      4     c0 03 5f d6                   ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Dynamic Dispatch Stall Cycles:</span><br><span class="line">RAT     - Register unavailable:                      0</span><br><span class="line">RCU     - Retire tokens unavailable:                 0</span><br><span class="line">SCHEDQ  - Scheduler full:                            0</span><br><span class="line">LQ      - Load queue full:                           0</span><br><span class="line">SQ      - Store queue full:                          0</span><br><span class="line">GROUP   - Static restrictions on the dispatch group: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Dispatch Logic - number of cycles where we saw N micro opcodes dispatched:</span><br><span class="line">[# dispatched], [# cycles]</span><br><span class="line"> 0,              20  (28.6%)</span><br><span class="line"> 4,              50  (71.4%)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Schedulers - number of cycles where we saw N micro opcodes issued:</span><br><span class="line">[# issued], [# cycles]</span><br><span class="line"> 0,          3  (4.3%)</span><br><span class="line"> 2,          1  (1.4%)</span><br><span class="line"> 3,          66  (94.3%)</span><br><span class="line"></span><br><span class="line">Scheduler&#x27;s queue usage:</span><br><span class="line">No scheduler resources used.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Retire Control Unit - number of cycles where we saw N instructions retired:</span><br><span class="line">[# retired], [# cycles]</span><br><span class="line"> 0,           3  (4.3%)</span><br><span class="line"> 2,           1  (1.4%)</span><br><span class="line"> 3,           66  (94.3%)</span><br><span class="line"></span><br><span class="line">Total ROB Entries:                128</span><br><span class="line">Max Used ROB Entries:             59  ( 46.1% )</span><br><span class="line">Average Used ROB Entries per cy:  32  ( 25.0% )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Register File statistics:</span><br><span class="line">Total number of mappings created:    100</span><br><span class="line">Max number of mappings used:         29</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Resources:</span><br><span class="line">[0.0] - TSV110UnitAB</span><br><span class="line">[0.1] - TSV110UnitAB</span><br><span class="line">[1]   - TSV110UnitALU</span><br><span class="line">[2]   - TSV110UnitFSU1</span><br><span class="line">[3]   - TSV110UnitFSU2</span><br><span class="line">[4.0] - TSV110UnitLdSt</span><br><span class="line">[4.1] - TSV110UnitLdSt</span><br><span class="line">[5]   - TSV110UnitMDU</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Resource pressure per iteration:</span><br><span class="line">[0.0]  [0.1]  [1]    [2]    [3]    [4.0]  [4.1]  [5]    </span><br><span class="line">0.66   0.67   0.67    -      -      -      -      -     </span><br><span class="line"></span><br><span class="line">Resource pressure by instruction:</span><br><span class="line">[0.0]  [0.1]  [1]    [2]    [3]    [4.0]  [4.1]  [5]    Instructions:</span><br><span class="line">0.33    -     0.67    -      -      -      -      -     mov	w0, #1</span><br><span class="line">0.33   0.67    -      -      -      -      -      -     ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Timeline view:</span><br><span class="line">Index     0123456789</span><br><span class="line"></span><br><span class="line">[0,0]     DeER .   .   mov	w0, #1</span><br><span class="line">[0,1]     DeER .   .   ret</span><br><span class="line">[1,0]     DeER .   .   mov	w0, #1</span><br><span class="line">[1,1]     D=eER.   .   ret</span><br><span class="line">[2,0]     .DeER.   .   mov	w0, #1</span><br><span class="line">[2,1]     .DeER.   .   ret</span><br><span class="line">[3,0]     .D=eER   .   mov	w0, #1</span><br><span class="line">[3,1]     .D=eER   .   ret</span><br><span class="line">[4,0]     . DeER   .   mov	w0, #1</span><br><span class="line">[4,1]     . D=eER  .   ret</span><br><span class="line">[5,0]     . D=eER  .   mov	w0, #1</span><br><span class="line">[5,1]     . D=eER  .   ret</span><br><span class="line">[6,0]     .  D=eER .   mov	w0, #1</span><br><span class="line">[6,1]     .  D=eER .   ret</span><br><span class="line">[7,0]     .  D=eER .   mov	w0, #1</span><br><span class="line">[7,1]     .  D==eER.   ret</span><br><span class="line">[8,0]     .   D=eER.   mov	w0, #1</span><br><span class="line">[8,1]     .   D=eER.   ret</span><br><span class="line">[9,0]     .   D==eER   mov	w0, #1</span><br><span class="line">[9,1]     .   D==eER   ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Average Wait times (based on the timeline view):</span><br><span class="line">[0]: Executions</span><br><span class="line">[1]: Average time spent waiting in a scheduler&#x27;s queue</span><br><span class="line">[2]: Average time spent waiting in a scheduler&#x27;s queue while ready</span><br><span class="line">[3]: Average time elapsed from WB until retire stage</span><br><span class="line"></span><br><span class="line">      [0]    [1]    [2]    [3]</span><br><span class="line">0.     10    1.7    1.7    0.0       mov	w0, #1</span><br><span class="line">1.     10    2.0    2.0    0.0       ret</span><br><span class="line">       10    1.9    1.9    0.0       &lt;total&gt;</span><br></pre></td></tr></table></figure>

</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://octodex.github.com/images/hula_loop_octodex03.gif" alt="Shaojie Tan"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Shaojie Tan</p><p class="is-size-6 is-block">𝘊𝘰𝘮𝘱𝘶𝘵𝘦𝘳 𝘈𝘳𝘤𝘩𝘪𝘵𝘦𝘤𝘵𝘶𝘳𝘦 &amp; 𝘏𝘗𝘊</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Anhui, Hefei, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">388</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">31</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">487</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Kirrito-k423" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Kirrito-k423"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Algorithms/"><span class="level-start"><span class="level-item">Algorithms</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/categories/Architecture/"><span class="level-start"><span class="level-item">Architecture</span></span><span class="level-end"><span class="level-item tag">39</span></span></a></li><li><a class="level is-mobile" href="/categories/Artificial-Intelligence/"><span class="level-start"><span class="level-item">Artificial Intelligence</span></span><span class="level-end"><span class="level-item tag">19</span></span></a></li><li><a class="level is-mobile" href="/categories/Databases/"><span class="level-start"><span class="level-item">Databases</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/HPC/"><span class="level-start"><span class="level-item">HPC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Math/"><span class="level-start"><span class="level-item">Math</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Network/"><span class="level-start"><span class="level-item">Network</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/OOW/"><span class="level-start"><span class="level-item">OOW</span></span><span class="level-end"><span class="level-item tag">21</span></span></a></li><li><a class="level is-mobile" href="/categories/Operating-system/"><span class="level-start"><span class="level-item">Operating system</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/Overview/"><span class="level-start"><span class="level-item">Overview</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/"><span class="level-start"><span class="level-item">Programming</span></span><span class="level-end"><span class="level-item tag">24</span></span></a></li><li><a class="level is-mobile" href="/categories/Software/"><span class="level-start"><span class="level-item">Software</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Thinking/"><span class="level-start"><span class="level-item">Thinking</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Tips/"><span class="level-start"><span class="level-item">Tips</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Treasure/"><span class="level-start"><span class="level-item">Treasure</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Tutorials/"><span class="level-start"><span class="level-item">Tutorials</span></span><span class="level-end"><span class="level-item tag">118</span></span></a></li><li><a class="level is-mobile" href="/categories/Values/"><span class="level-start"><span class="level-item">Values</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/architecture/"><span class="level-start"><span class="level-item">architecture</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/diary/"><span class="level-start"><span class="level-item">diary</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/english/"><span class="level-start"><span class="level-item">english</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/hardware/"><span class="level-start"><span class="level-item">hardware</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/math/"><span class="level-start"><span class="level-item">math</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/network/"><span class="level-start"><span class="level-item">network</span></span><span class="level-end"><span class="level-item tag">19</span></span></a></li><li><a class="level is-mobile" href="/categories/operating-system/"><span class="level-start"><span class="level-item">operating system</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/security/"><span class="level-start"><span class="level-item">security</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/software/"><span class="level-start"><span class="level-item">software</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/thinking/"><span class="level-start"><span class="level-item">thinking</span></span><span class="level-end"><span class="level-item tag">7</span></span></a><ul><li><a class="level is-mobile" href="/categories/thinking/OOW/"><span class="level-start"><span class="level-item">OOW</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/tips/"><span class="level-start"><span class="level-item">tips</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/toLearn/"><span class="level-start"><span class="level-item">toLearn</span></span><span class="level-end"><span class="level-item tag">51</span></span></a></li><li><a class="level is-mobile" href="/categories/values/"><span class="level-start"><span class="level-item">values</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://ibug.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">ibugs</span></span><span class="level-right"><span class="level-item tag">ibug.io</span></span></a></li><li><a class="level is-mobile" href="https://jia.je/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">jiegec</span></span><span class="level-right"><span class="level-item tag">jia.je</span></span></a></li><li><a class="level is-mobile" href="https://leimao.github.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">leimao</span></span><span class="level-right"><span class="level-item tag">leimao.github.io</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-27T08:35:33.000Z">2024-01-27</time></p><p class="title"><a href="/2024/01/27/Work/Artificial%20Intelligence/Basic/AIComputeMachine/">AI Compute Machine</a></p><p class="categories"><a href="/categories/Artificial-Intelligence/">Artificial Intelligence</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-25T03:20:42.000Z">2024-01-25</time></p><p class="title"><a href="/2024/01/25/OutOfWork/5-VideoEntertainment/AnimeSuperResolutionFrame/">Anime Super Resolution to 4K &amp; Interpolation to 120 fps</a></p><p class="categories"><a href="/categories/OOW/">OOW</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-13T14:32:40.000Z">2024-01-13</time></p><p class="title"><a href="/2024/01/13/Thinking/2-courage2move/SocialScience/">Social Science</a></p><p class="categories"><a href="/categories/Thinking/">Thinking</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-13T12:15:22.000Z">2024-01-13</time></p><p class="title"><a href="/2024/01/13/Work/Architecture/FPGA/">FPGA</a></p><p class="categories"><a href="/categories/toLearn/">toLearn</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-13T08:02:52.000Z">2024-01-13</time></p><p class="title"><a href="/2024/01/13/Work/Architecture/workloadPriority/">Workload Characterization &amp; Priority &amp; Scheduler to CPU/GPU/PIM</a></p><p class="categories"><a href="/categories/Architecture/">Architecture</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/"><span class="level-start"><span class="level-item">2024</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">235</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">67</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/"><span class="level-start"><span class="level-item">2021</span></span><span class="level-end"><span class="level-item tag">72</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/5G/"><span class="tag">5G</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/64bits-vs-32bits/"><span class="tag">64bits vs 32bits</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AI/"><span class="tag">AI</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AMAT/"><span class="tag">AMAT</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AMD/"><span class="tag">AMD</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ASPLOS/"><span class="tag">ASPLOS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ATI/"><span class="tag">ATI</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AVX/"><span class="tag">AVX</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Algorithm/"><span class="tag">Algorithm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Alpha/"><span class="tag">Alpha</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Analysis/"><span class="tag">Analysis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Apt/"><span class="tag">Apt</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Assembly/"><span class="tag">Assembly</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BFS/"><span class="tag">BFS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BHive/"><span class="tag">BHive</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BT/"><span class="tag">BT</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BTL/"><span class="tag">BTL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Baka-Mitai/"><span class="tag">Baka Mitai</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Bash/"><span class="tag">Bash</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Big-Endian/"><span class="tag">Big-Endian</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="SHAOJIE&#039;S BOOK" height="28"></a><p class="is-size-7"><span>&copy; 2024 Shaojie Tan</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Kirrito-k423/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>