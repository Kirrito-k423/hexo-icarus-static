<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>SHAOJIE&#039;S BOOK</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="SHAOJIE&#039;S BOOK"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="SHAOJIE&#039;S BOOK"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="SHAOJIE&#039;S BOOK"><meta property="og:url" content="http://icarus.shaojiemike.top/"><meta property="og:site_name" content="SHAOJIE&#039;S BOOK"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://icarus.shaojiemike.top/img/og_image.png"><meta property="article:author" content="Shaojie Tan"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://icarus.shaojiemike.top/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://icarus.shaojiemike.top"},"headline":"SHAOJIE'S BOOK","image":["http://icarus.shaojiemike.top/img/og_image.png"],"author":{"@type":"Person","name":"Shaojie Tan"},"publisher":{"@type":"Organization","name":"SHAOJIE'S BOOK","logo":{"@type":"ImageObject","url":"http://icarus.shaojiemike.top/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="SHAOJIE&#039;S BOOK" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Kirrito-k423/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-05-30T16:00:00.000Z" title="5/30/2023, 4:00:00 PM">2023-05-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-10-18T08:11:50.969Z" title="10/18/2024, 8:11:50 AM">2024-10-18</time></span><span class="level-item"><a class="link-muted" href="/categories/Architecture/">Architecture</a></span><span class="level-item">11 minutes read (About 1699 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/30/Work/Programming/4-compile/llvmBackend/">llvm Backend</a></p><div class="content"><h2 id="llvm-后端-概述"><a href="#llvm-后端-概述" class="headerlink" title="llvm 后端 概述"></a>llvm 后端 概述</h2><ul>
<li>后端（backend）由一套<strong>分析</strong>和<strong>转换</strong>Pass组成，它们的任务是代码生成，即将LLVM中间表示（IR）变换为目标代码（或者汇编）。</li>
<li>LLVM支持广泛的目标：ARM，AArch64，Hexagon，MSP430，MIPS，Nvidia PTX，PowerPC，R600，SPARC，SystemZ，X86，和XCore。</li>
<li>所有这些后端共享一套共用的接口，它是目标无关代码生成器的一部分，以通用API的方法抽象化后端任务。每个目标必须特殊化代码生成通用类，以实现目标特定的行为。</li>
</ul>
<h3 id="后端的基本流程"><a href="#后端的基本流程" class="headerlink" title="后端的基本流程"></a>后端的基本流程</h3><ul>
<li>下图给出了将LLVM IR转换为目标汇编代码必需的步骤</li>
</ul>
<p><img src="https://pic.shaojiemike.top/img/20230523160158.png" alt="Backend"></p>
<ul>
<li>浅灰色的中间框，也叫super pass，是必需的，它们是后端的核心部分。</li>
<li>白色框所指示的，可以执行非必需的优化Pass以进一步改进翻译的质量。对于提高所生成的代码的效率更重要。<ul>
<li>比如<code>-O3</code>的优化，而且其顺序对结果也有影响。</li>
</ul>
</li>
</ul>
<p>详细解释各阶段：</p>
<ol>
<li>指令选择（Instruction Selection）：将三地址结构的LLVM IR变换为DAG（Directed Acyclic Graph）<ul>
<li>每个DAG能够表示单一基本块的计算。DAG内节点表示机器指令，边表示数据依赖关系。</li>
</ul>
</li>
<li>第1次指令调度（Instruction Scheduling），也称为前寄存器分配（RA）调度，对指令排序，同时尝试发现尽可能多的指令层次的并行。然后这些指令被变换为MachineInstr三地址表示。</li>
<li>寄存器分配（Register Allocation），它将无限的虚拟寄存器的引用转换为有限的目标特定的寄存器集，寄存器不够时挤出（spill）到内存。</li>
<li>第2次指令调度，也称为后寄存器分配（RA）调度。因为此时在这个点可获得真实的寄存器信息，某些类型寄存器存在额外的风险和延迟，它们可被用以改进指令顺序。</li>
<li>代码输出（Code Emission）阶段将指令从MachineInstr表示变换为MCInst实例。这种新的表示更适合汇编器和链接器，它有两种选择：输出汇编代码或者输出二进制块（blob）到一种特定的目标代码格式。</li>
</ol>
<h3 id="后端代码结构"><a href="#后端代码结构" class="headerlink" title="后端代码结构"></a>后端代码结构</h3><p>后端的实现分散在LLVM源代码树的不同目录中。代码生成背后的主要程序库位于lib目录和它的子文件夹CodeGen、MC、TableGen、和Target中， 具体参考<a target="_blank" rel="noopener" href="https://getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io/zh_CN/latest/ch06.html#id4">文档</a></p>
<p>Tablegen位置在类似 <code>llvm/lib/Target/X86/X86.td</code>的地方</p>
<h2 id="llvm-编译优化"><a href="#llvm-编译优化" class="headerlink" title="llvm 编译优化"></a>llvm 编译优化</h2><ul>
<li>通过llvm的分析和转换Pass相结合实现的。</li>
<li>首先，通过分析Pass获取程序的一些特性和数据流等信息，例如控制流分析、数据流分析、依赖分析等。</li>
<li>然后，根据所得到的分析信息，llvm会执行转换Pass，对程序进行一系列的重构、优化和变换，例如常量传播、死代码消除、内联函数、循环展开等。</li>
</ul>
<h3 id="举例：O3优化实现"><a href="#举例：O3优化实现" class="headerlink" title="举例：O3优化实现"></a>举例：O3优化实现</h3><p>程序优化选项 -O3 是通过启用 LLVM Pass Manager 并按照顺序执行包含多个具体优化 Pass 的过程实现的。包括：</p>
<ol>
<li>函数内部优化 Pass，如内联、函数内联、无用函数清理、控制流扁平化；</li>
<li>函数间优化 Pass，如基于静态单走边分析的间接调用目标推导、函数每次调用的参数的重复计算消除、通过符号解析执行的函数简介化等。</li>
<li>模块优化 Pass，如死代码消除、全局优化、常量传播、数值宽化和窄化、整除优化等；</li>
<li>特定于架构的优化 Pass，包括指令调度和寄存器分配等。</li>
</ol>
<p>这些 Pass 的执行范围涵盖 LLVM IR 与 LLVM 后端。</p>
<h2 id="TableGen"><a href="#TableGen" class="headerlink" title="TableGen"></a>TableGen</h2><ul>
<li>LLVM的TableGen是一种表格驱动代码生成工具，主要用于生成汇编器、反汇编器、指令选择器、调度器等代码。</li>
<li>它使用基于LLVM IR的DSL(Domain-Specific Language)来描述目标指令集的特性和规则，然后将这些信息转换为C++代码。</li>
<li>使用TableGen可以将目标指令集的实现与源代码分离，从而提高代码的可读性和可维护性。</li>
</ul>
<p>TableGen的输入文件使用扩展名“<code>.td</code>”（TableGen的缩写），它们可以描述如下内容：</p>
<ol>
<li>Instruction Set Architecture (ISA) - 描述目标机的指令集特性，例如指令集架构、寄存器、寄存器类、操作数类型、地址模型、端对齐性等。</li>
<li>Selection DAG - 描述了如何将LLVM IR节点映射到目标机指令集的指令，例如指令的操作码、操作数、调用约定、指令延迟等。</li>
<li>Pattern Matching - 对匹配到的指令模板做出生成想要的IR节点的选择。</li>
<li>Instruction Scheduling - 描述调度器行为、指令之间的时间关系，以及如何将指令插入到调度图中的规则等。</li>
</ol>
<ul>
<li>TableGen自动化了目标机指令集的大部分工作，同时也使得自定义目标机变得相对容易。</li>
<li>该工具支持针对多种平台和编译器的后端代码生成。</li>
<li>对于嵌入式系统和非标准指令集架构等领域，TableGen有着广泛的应用。</li>
</ul>
<h3 id="相关的概念"><a href="#相关的概念" class="headerlink" title="相关的概念"></a>相关的概念</h3><ul>
<li>目标描述语言（Target Description Language，TDL）来定义目标架构特定的指令和寄存器。其中，TDL可用于目标架构中指令定义和寄存器定义的映射关系和动态生成机器指令的规则。</li>
</ul>
<h2 id="实践：llvm-IR-后端"><a href="#实践：llvm-IR-后端" class="headerlink" title="实践：llvm IR 后端"></a>实践：llvm IR 后端</h2><p>实现一个简单的LLVM IR后端，将LLVM IR转换为x86汇编代码，能line by line的输出。</p>
<p>参考LLVM官方文档中的“Writing an LLVM Backend”以及“TableGen Backends”</p>
<!-- 下面回答部分**来自ChatGPT-3.5**，暂时没有校验其可靠性(看上去貌似说得通)。 -->

<h2 id="需要进一步的研究学习"><a href="#需要进一步的研究学习" class="headerlink" title="需要进一步的研究学习"></a>需要进一步的研究学习</h2><p>暂无</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>暂无</p>
<h2 id="开题缘由、总结、反思、吐槽"><a href="#开题缘由、总结、反思、吐槽" class="headerlink" title="开题缘由、总结、反思、吐槽~~"></a>开题缘由、总结、反思、吐槽~~</h2><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a target="_blank" rel="noopener" href="https://getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io/zh_CN/latest/ch06.html#id2">https://getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io/zh_CN/latest/ch06.html#id2</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-05-25T09:42:44.000Z" title="5/25/2023, 9:42:44 AM">2023-05-25</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-10-18T08:11:50.889Z" title="10/18/2024, 8:11:50 AM">2024-10-18</time></span><span class="level-item"><a class="link-muted" href="/categories/Thinking/">Thinking</a></span><span class="level-item">8 minutes read (About 1173 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/25/Thinking/2-courage2move/PIM/OOTD/">OOTD: outfit of the day</a></p><div class="content"><article class="message is-info">
        <div class="message-header"><p><i class="fa-solid fa-clipboard mr-2"></i>导言</p>
</div>
        <div class="message-body">
            <p>个人形象管理的第一部分，也是最简单的部分，外貌部分的穿搭。</p>

        </div>
    </article></div><a class="article-more button is-small is-size-7" href="/2023/05/25/Thinking/2-courage2move/PIM/OOTD/#more">Read more</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-05-22T16:00:00.000Z" title="5/22/2023, 4:00:00 PM">2023-05-22</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-10-18T08:11:50.969Z" title="10/18/2024, 8:11:50 AM">2024-10-18</time></span><span class="level-item"><a class="link-muted" href="/categories/Architecture/">Architecture</a></span><span class="level-item">11 minutes read (About 1584 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/22/Work/Programming/4-compile/llvmPass/">llvm Pass</a></p><div class="content"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li>Pass就是“遍历一遍IR，可以同时对它做一些操作”的意思。翻译成中文应该叫“传递”。</li>
<li>在实现上，LLVM的核心库中会给你一些 Pass类 去继承。你需要实现它的一些方法。<ul>
<li>ModulePass , CallGraphSCCPass, FunctionPass , or LoopPass, or RegionPass</li>
</ul>
</li>
<li>最后使用LLVM的编译器会把它翻译得到的IR传入Pass里，给你遍历和修改。</li>
</ul>
<h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><ol>
<li>插桩： 在Pass遍历LLVM IR的同时，自然就可以往里面插入新的代码。</li>
<li>机器无关的代码优化：编译原理一课说：IR在被翻译成机器码前会做一些机器无关的优化。 但是不同的优化方法之间需要解耦，所以自然要各自遍历一遍IR，实现成了一个个LLVM Pass。 最终，基于LLVM的编译器会在前端生成LLVM IR后调用一些LLVM Pass做机器无关优化， 然后再调用LLVM后端生成目标平台代码。</li>
<li>静态分析： 像VSCode的C&#x2F;C++插件就会用LLVM Pass来分析代码，提示可能的错误 (无用的变量、无法到达的代码等等)。</li>
</ol>
<h2 id="理解-llvm-Pass"><a href="#理解-llvm-Pass" class="headerlink" title="理解 llvm Pass"></a>理解 llvm Pass</h2><h3 id="理解Pass-API"><a href="#理解Pass-API" class="headerlink" title="理解Pass API"></a>理解Pass API</h3><p>　　Pass类是实现优化的主要资源。然而，我们从不直接使用它，而是通过清楚的子类使用它。当实现一个Pass时，你应该选择适合你的Pass的最佳粒度，适合此粒度的最佳子类，例如基于函数、模块、循环、强联通区域，等等。常见的这些子类如下：</p>
<ul>
<li><code>ModulePass</code>：这是最通用的Pass；它一次分析整个模块，函数的次序不确定。它不限定使用者的行为，允许删除函数和其它修改。为了使用它，你需要写一个类继承ModulePass，并重载runOnModule()方法。</li>
<li><code>FunctionPass</code>：这个子类允许一次处理一个函数，处理函数的次序不确定。这是应用最多的Pass类型。它禁止修改外部函数、删除函数、删除全局变量。为了使用它，需要写一个它的子类，重载runOnFunction()方法。</li>
<li><code>BasicBlockPass</code>：这个类的粒度是基本块。FunctionPass类禁止的修改在这里也是禁止的。它还禁止修改或者删除外部基本块。使用者需要写一个类继承BasicBlockPass，并重载它的runOnBasicBlock()方法。</li>
</ul>
<p>　　被重载的入口函数runOnModule()、runOnFunction()、runOnBasicBlock()返回布尔值false，如果被分析的单元（模块、函数和基本块）保持不变，否则返回布尔值true。</p>
<h3 id="Pass的执行顺序-依赖"><a href="#Pass的执行顺序-依赖" class="headerlink" title="Pass的执行顺序&#x2F;依赖"></a>Pass的执行顺序&#x2F;依赖</h3><ul>
<li>ChatGPT说默认顺序是：FunctionPass -&gt; Module Pass -&gt; LoopPass ?</li>
<li>当然我们是可以修改插入Pass的执行顺序的。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> PIMProf::AnnotationInjection::ID = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 注册 llvm pass</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterPass&lt;PIMProf::AnnotationInjection&gt; <span class="title">RegisterMyPass</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;AnnotationInjection&quot;</span>, <span class="string">&quot;Inject annotators to uniquely identify each basic block.&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">loadPass</span><span class="params">(<span class="type">const</span> PassManagerBuilder &amp;,</span></span></span><br><span class="line"><span class="params"><span class="function">                           legacy::PassManagerBase &amp;PM)</span> </span>&#123;</span><br><span class="line">    PM.<span class="built_in">add</span>(<span class="keyword">new</span> PIMProf::<span class="built_in">AnnotationInjection</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ox 的代码 llvm pass 在EP_OptimizerLast 位置load</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterStandardPasses <span class="title">clangtoolLoader_Ox</span><span class="params">(PassManagerBuilder::EP_OptimizerLast, loadPass)</span></span>;</span><br><span class="line"><span class="comment">// O0 的代码 llvm pass EP_EnabledOnOptLevel0 位置load</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterStandardPasses <span class="title">clangtoolLoader_O0</span><span class="params">(PassManagerBuilder::EP_EnabledOnOptLevel0, loadPass)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><ol>
<li>编写LLVM pass代码</li>
<li>配置编译环境(cmake or make)</li>
<li>运行(opt or clang)</li>
</ol>
<h2 id="1-代码框架"><a href="#1-代码框架" class="headerlink" title="1 代码框架"></a>1 代码框架</h2><p>最简单框架hello.cpp如下，注意<code>Important</code>一定需要：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"> <span class="comment">// Important</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">Hello</span> : <span class="keyword">public</span> FunctionPass &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">    <span class="built_in">Hello</span>() : <span class="built_in">FunctionPass</span>(ID) &#123;&#125;</span><br><span class="line"> <span class="comment">// Important</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">      <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Hello: &quot;</span>;</span><br><span class="line">      <span class="built_in">errs</span>().<span class="built_in">write_escaped</span>(F.<span class="built_in">getName</span>()) &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> Hello::ID = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Important:Register for opt</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterPass&lt;Hello&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;Hello World Pass&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Important:Register for clang</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterStandardPasses <span class="title">Y</span><span class="params">(PassManagerBuilder::EP_EarlyAsPossible,</span></span></span><br><span class="line"><span class="params"><span class="function">  [](<span class="type">const</span> PassManagerBuilder &amp;Builder, legacy::PassManagerBase &amp;PM) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    PM.add(<span class="keyword">new</span> Hello());</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125;)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="2-编译动态库"><a href="#2-编译动态库" class="headerlink" title="2 编译动态库"></a>2 编译动态库</h2><h3 id="使用cmake"><a href="#使用cmake" class="headerlink" title="使用cmake"></a>使用cmake</h3><p>参考<a target="_blank" rel="noopener" href="https://llvm.org/docs/CMake.html#cmake-out-of-source-pass">官方文档</a>。</p>
<p>An example of a project layout is provided below.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;project <span class="built_in">dir</span>&gt;/</span><br><span class="line">    |</span><br><span class="line">    CMakeLists.txt</span><br><span class="line">    &lt;pass name&gt;/</span><br><span class="line">        |</span><br><span class="line">        CMakeLists.txt</span><br><span class="line">        Pass.cpp</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>Contents of <code>&lt;project dir&gt;/CMakeLists.txt</code>:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(LLVM REQUIRED CONFIG)</span><br><span class="line"></span><br><span class="line"><span class="keyword">separate_arguments</span>(LLVM_DEFINITIONS_LIST NATIVE_COMMAND <span class="variable">$&#123;LLVM_DEFINITIONS&#125;</span>)</span><br><span class="line"><span class="keyword">add_definitions</span>(<span class="variable">$&#123;LLVM_DEFINITIONS_LIST&#125;</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;LLVM_INCLUDE_DIRS&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span>(&lt;pass name&gt;)</span><br></pre></td></tr></table></figure>

<p>Contents of <code>&lt;project dir&gt;/&lt;pass name&gt;/CMakeLists.txt</code>:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_library</span>(LLVMPassname MODULE Pass.cpp)</span><br></pre></td></tr></table></figure>

<p>运行cmake编译。产生<code>LLVMPassname.so</code>文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">cmake .. &amp;&amp; make</span><br></pre></td></tr></table></figure>

<!-- 下面回答部分**来自ChatGPT-3.5**，暂时没有校验其可靠性(看上去貌似说得通)。 -->

<h3 id="使用命令行"><a href="#使用命令行" class="headerlink" title="使用命令行"></a>使用命令行</h3><p>请阅读<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/122522485">知乎的文章</a></p>
<h2 id="3-使用"><a href="#3-使用" class="headerlink" title="3 使用"></a>3 使用</h2><h3 id="opt加载Pass"><a href="#opt加载Pass" class="headerlink" title="opt加载Pass"></a>opt加载Pass</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clang -c -emit-llvm main.c -o main.bc <span class="comment"># 随意写一个C代码并编译到bc格式</span></span><br><span class="line">opt -load path/to/LLVMHello.so -hello main.bc -o /dev/null</span><br></pre></td></tr></table></figure>

<p>把源代码编译成IR代码，然后用opt运行Pass实在麻烦且无趣。</p>
<h3 id="clang加载Pass"><a href="#clang加载Pass" class="headerlink" title="clang加载Pass"></a>clang加载Pass</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clang -Xclang -load -Xclang path/to/LLVMHello.so main.c -o main</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">clang++ -Xclang -load -Xclang ./build/hello/libLLVMPassname.so test.cpp -o main</span><br></pre></td></tr></table></figure>

<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="插入代码"><a href="#插入代码" class="headerlink" title="插入代码"></a>插入代码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">InjectSimMagic2</span><span class="params">(Module &amp;M, Instruction *insertPt, <span class="type">uint64_t</span> arg0, <span class="type">uint64_t</span> arg1, <span class="type">uint64_t</span> arg2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LLVMContext &amp;ctx = M.<span class="built_in">getContext</span>();</span><br><span class="line">    std::vector&lt;Type *&gt; argtype &#123;</span><br><span class="line">        Type::<span class="built_in">getInt64Ty</span>(ctx), Type::<span class="built_in">getInt64Ty</span>(ctx), Type::<span class="built_in">getInt64Ty</span>(ctx)</span><br><span class="line">    &#125;;</span><br><span class="line">    FunctionType *ty = FunctionType::<span class="built_in">get</span>(</span><br><span class="line">        Type::<span class="built_in">getVoidTy</span>(ctx), argtype, <span class="literal">false</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// template of Sniper&#x27;s SimMagic0</span></span><br><span class="line">    InlineAsm *ia = InlineAsm::<span class="built_in">get</span>(</span><br><span class="line">        ty,</span><br><span class="line">        <span class="string">&quot;\tmov $0, %rax \n&quot;</span></span><br><span class="line">        <span class="string">&quot;\tmov $1, %rbx \n&quot;</span></span><br><span class="line">        <span class="string">&quot;\tmov $2, %rcx \n&quot;</span></span><br><span class="line">        <span class="string">&quot;\txchg %bx, %bx\n&quot;</span>,</span><br><span class="line">        <span class="string">&quot;imr,imr,imr,~&#123;rax&#125;,~&#123;rbx&#125;,~&#123;rcx&#125;,~&#123;dirflag&#125;,~&#123;fpsr&#125;,~&#123;flags&#125;&quot;</span>,</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">    );</span><br><span class="line">    Value *val0 = ConstantInt::<span class="built_in">get</span>(IntegerType::<span class="built_in">get</span>(ctx, <span class="number">64</span>), arg0);</span><br><span class="line">    Value *val1 = ConstantInt::<span class="built_in">get</span>(IntegerType::<span class="built_in">get</span>(ctx, <span class="number">64</span>), arg1);</span><br><span class="line">    Value *val2 = ConstantInt::<span class="built_in">get</span>(IntegerType::<span class="built_in">get</span>(ctx, <span class="number">64</span>), arg2);</span><br><span class="line">    std::vector&lt;Value *&gt; arglist &#123;val0, val1, val2&#125;;</span><br><span class="line">    CallInst::<span class="built_in">Create</span>(</span><br><span class="line">            ia, arglist, <span class="string">&quot;&quot;</span>, insertPt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码使用内联汇编嵌入到 LLVM IR 中，指令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov $0, %rax</span><br><span class="line">mov $1, %rbx</span><br><span class="line">mov $2, %rcx</span><br><span class="line">xchg %bx, %bx</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li>mov $0, %rax 将立即数 arg0 装载到通用寄存器 %rax 中。</li>
<li>mov $1, %rbx 将立即数 arg1 装载到通用寄存器 %rbx 中。</li>
<li>mov $2, %rcx 将立即数 arg2 装载到通用寄存器 %rcx 中。</li>
<li>xchg %bx, %bx 是一条无操作指令，用于保证该汇编代码的原子性。</li>
</ul>
<h3 id="打印每个BBL内的汇编指令"><a href="#打印每个BBL内的汇编指令" class="headerlink" title="打印每个BBL内的汇编指令"></a>打印每个BBL内的汇编指令</h3><p>由于直接打印的是llvm IR的表示，想要打印特定架构比如x86的汇编代码，其实需要进行llvm后端的转换。（取巧，可执行文件反汇编，然后根据插入的汇编桩划分）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="需要进一步的研究学习"><a href="#需要进一步的研究学习" class="headerlink" title="需要进一步的研究学习"></a>需要进一步的研究学习</h2><p>暂无</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>暂无</p>
<h2 id="开题缘由、总结、反思、吐槽"><a href="#开题缘由、总结、反思、吐槽" class="headerlink" title="开题缘由、总结、反思、吐槽~~"></a>开题缘由、总结、反思、吐槽~~</h2><p>复现PIMProf论文时，用到了使用 llvm pass来插入特殊汇编</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a target="_blank" rel="noopener" href="https://www.llvm.org/docs/WritingAnLLVMPass.html">https://www.llvm.org/docs/WritingAnLLVMPass.html</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/122522485">https://zhuanlan.zhihu.com/p/122522485</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-05-20T16:00:00.000Z" title="5/20/2023, 4:00:00 PM">2023-05-20</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-10-18T08:11:50.969Z" title="10/18/2024, 8:11:50 AM">2024-10-18</time></span><span class="level-item"><a class="link-muted" href="/categories/Architecture/">Architecture</a></span><span class="level-item">18 minutes read (About 2675 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/20/Work/Programming/2.1-Assembly/assemblyGNUFile/">GNU Assembly File</a></p><div class="content"><h2 id="GNU汇编语法"><a href="#GNU汇编语法" class="headerlink" title="GNU汇编语法"></a>GNU汇编语法</h2><h3 id="伪指令"><a href="#伪指令" class="headerlink" title="伪指令"></a>伪指令</h3><ul>
<li><strong>指示（Directives）</strong>: 以点号开始，用来指示对编译器，连接器，调试器有用的结构信息。指示本身不是汇编指令。</li>
</ul>
<table>
<thead>
<tr>
<th align="center">伪指令</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">.file</td>
<td align="center">指定由哪个源文件生成的汇编代码。</td>
</tr>
<tr>
<td align="center">.data</td>
<td align="center">表示数据段(section)的开始地址</td>
</tr>
<tr>
<td align="center">.text</td>
<td align="center">指定下面的指令属于代码段。</td>
</tr>
<tr>
<td align="center">.string</td>
<td align="center">表示数据段中的字符串常量。</td>
</tr>
<tr>
<td align="center">.globl main</td>
<td align="center">指明标签main是一个可以在其它模块的代码中被访问的全局符号 。</td>
</tr>
<tr>
<td align="center">.align</td>
<td align="center">数据对齐指令</td>
</tr>
<tr>
<td align="center">.section</td>
<td align="center">段标记</td>
</tr>
<tr>
<td align="center">.type</td>
<td align="center">设置一个符号的属性值</td>
</tr>
</tbody></table>
<ul>
<li>语法：<code>.type name , description</code><ul>
<li>description取值如下：<ul>
<li><code>%function</code> 表示该符号用来表示一个函数名</li>
<li><code>%object</code> 表示该符号用来表示一个数据对象</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>至于其它的指示你可以忽略。</p>
<h2 id="实践：阅读汇编文件"><a href="#实践：阅读汇编文件" class="headerlink" title="实践：阅读汇编文件"></a>实践：阅读汇编文件</h2><p>从最简单的C文件入手</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行<code>gcc -S -O3 main.c -o main.s</code>，得到<code>main.s</code>文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> .file &quot;simple.cpp&quot;</span><br><span class="line"> .text</span><br><span class="line"> .section .text.startup,&quot;ax&quot;,@progbits</span><br><span class="line"> .p2align 4</span><br><span class="line"> .globl main</span><br><span class="line"> .type main, @function</span><br><span class="line">main:</span><br><span class="line">.LFB0:</span><br><span class="line"> .cfi_startproc</span><br><span class="line"> endbr64</span><br><span class="line"> xorl %eax, %eax</span><br><span class="line"> ret</span><br><span class="line"> .cfi_endproc</span><br><span class="line">.LFE0:</span><br><span class="line"> .size main, .-main</span><br><span class="line"> .ident &quot;GCC: (Ubuntu 9.4.0-1ubuntu1~20.04.1) 9.4.0&quot;</span><br><span class="line"> .section .note.GNU-stack,&quot;&quot;,@progbits</span><br><span class="line"> .section .note.gnu.property,&quot;a&quot;</span><br><span class="line"> .align 8</span><br><span class="line"> .long  1f - 0f</span><br><span class="line"> .long  4f - 1f</span><br><span class="line"> .long  5</span><br><span class="line">0:</span><br><span class="line"> .string  &quot;GNU&quot;</span><br><span class="line">1:</span><br><span class="line"> .align 8</span><br><span class="line"> .long  0xc0000002</span><br><span class="line"> .long  3f - 2f</span><br><span class="line">2:</span><br><span class="line"> .long  0x3</span><br><span class="line">3:</span><br><span class="line"> .align 8</span><br><span class="line">4:</span><br></pre></td></tr></table></figure>

<ul>
<li>下面回答<strong>来自ChatGPT-3.5</strong>，暂时没有校验其可靠性(看上去貌似说得通)。</li>
</ul>
<h3 id="section"><a href="#section" class="headerlink" title="section"></a>section</h3><ul>
<li><code>.section .rodata.str1.1,&quot;aMS&quot;,@progbits,1</code><ul>
<li><code>rodata.str1.1</code>是一个标号（label）, 意思是只读数据段的字符串常量</li>
<li><code>aMS</code>是一个属性值：<ul>
<li>可分配的（allocatable），即程序运行时需要动态分配空间才能分配该代码段，</li>
<li>不可执行 （M），</li>
<li>数据的类型为串（S）</li>
<li>其余属性值：对齐方式的通常为 b（byte对齐），w（word对齐），或者其他更大的对齐单位，例如 d（double word对齐）。</li>
</ul>
</li>
<li><code>@progbits</code>: 表示该段的类型是程序数据段（PROGBITS），这种类型的段包含程序的代码和数据。</li>
<li><code>1</code>: 表示该段的对齐方式是2^1 &#x3D; 2个字节（按字节对齐）。如果不写这个数字，默认对齐到当前机器的字长。</li>
</ul>
</li>
<li><code>.section .text.startup,&quot;ax&quot;,@progbits</code> 其中<code>ax</code>表示该段是可分配的（allocatable）和可执行的（executable）。</li>
<li>“<code>.section .note.GNU-stack</code>“指令用于告诉链接器是否允许在堆栈上执行代码。</li>
<li>“<code>.section .note.gnu.property</code>“指令用于指定一些属性，这里是一个GNU特性标记。</li>
</ul>
<h3 id="汇编的入口"><a href="#汇编的入口" class="headerlink" title="汇编的入口"></a>汇编的入口</h3><ul>
<li>汇编的执行流程：入口函数在哪里</li>
<li>入口函数在该文件中的名称为“main”，定义于“<code>.text.startup” section</code>，其首地址为“<code>.globl main</code>”。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.section .text.startup,&quot;ax&quot;,@progbits</span><br><span class="line">.p2align 4</span><br><span class="line">.globl main</span><br><span class="line">.type main, @function</span><br></pre></td></tr></table></figure>

<h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><p><img src="https://pic.shaojiemike.top/img/20230521194515.png"></p>
<ul>
<li>为了确保这些初始化操作可以在程序启动时正确执行，编译器将把这些构造函数和析构函数的调用代码打包成若干个函数，统一放在名字为“<code>_GLOBAL__sub_I_xxx</code>”的section中。<ul>
<li>因为在C++程序编译后的二进制文件中，全局变量、静态变量和全局对象等信息都需要进行初始化操作，包括构造函数（初始化对象）和析构函数（清理对象）。</li>
<li>在这段汇编代码中，也就是那个”_GLOBAL__sub_I_main”函数，它是C++全局变量和静态变量的构造函数，它调用了预初始化函数 “<code>ios_base::Init()</code>“，并注册了一个在程序退出时调用的析构函数 “<code>__cxa_atexit</code>“。</li>
</ul>
</li>
<li>在”<code>.init_array</code>“ section中，定义了一个”_GLOBAL__sub_I_main”的地址，这是在程序启动时需要调用的所有C++全局和静态对象的初始化函数列表，编译器链接这个列表并在程序启动时依次调用这些初始化函数。</li>
<li>总之，这两个section的存在是为了保证C++全局变量和静态变量的正确初始化。</li>
</ul>
<p>其中四条指令都定义了一些符号或变量，并分配了一些内存空间，这些在程序里的意义如下：</p>
<ol>
<li>“<code>.quad _GLOBAL__sub_I_main</code>“:</li>
</ol>
<p>在程序启动时，将调用所有全局静态对象的构造函数。这些构造函数被放在一个名为”_GLOBAL__sub_I_xxx”的section中，而每个section都是由一个指向该section所有对象的地址列表所引用。这里的”.quad _GLOBAL__sub_I_main”是为了将”_GLOBAL__sub_I_main”函数的地址添加到该列表中。</p>
<ol start="2">
<li>“<code>.local _ZStL8__ioinit</code>“:</li>
</ol>
<p>这条指令定义了一个本地符号”_ZStL8__ioinit”，它表示C++标准输入输出的初始化过程。由于该符号是一个本地符号，所以只能在编辑该文件的当前单元中使用该符号。</p>
<ol start="3">
<li>“<code>.comm _ZStL8__ioinit,1,1</code>“:</li>
</ol>
<p>这条指令定义了一个名为”_ZStL8__ioinit”的未初始化的弱符号，并为该符号分配了1个大小的字节空间。这个弱符号定义了一个C++标准输入输出部分的全局状态对象。在全用动态库时，不同的动态库可能有自己的IO状态，所以为了确保C++输入输出的状态正确，需要为其指定一个单独的段来存储这些状态数据。在这里，”.comm _ZStL8__ioinit,1,1”将会为”_ZStL8__ioinit”符号分配一个字节大小的空间。</p>
<ol start="4">
<li>“<code>.hidden __dso_handle</code>“:</li>
</ol>
<p>这条指令定义了一个隐藏的符号 “__dso_handle”。这个符号是一个链接器生成的隐式变量，其定义了一个指向被当前动态库使用的全局数据对象的一个指针。该符号在被链接进来的库中是隐藏的，不会被其他库或者main函数本身调用，但是在main返回后，可以用来检查库是否已经被卸载。</p>
<h3 id="末尾的元数据"><a href="#末尾的元数据" class="headerlink" title="末尾的元数据"></a>末尾的元数据</h3><p><img src="https://pic.shaojiemike.top/img/20230521191453.png"></p>
<p>这段代码是一些特殊的指令和数据，主要是用于向可执行文件添加一些元数据（metadata）。这些元数据可能包含各种信息，如调试信息、特定平台的指令集支持等等。</p>
<p>具体来说：</p>
<ul>
<li>“.long”指令用于定义一个长整型数值，这里用来计算地址之间的差值。<ul>
<li>例如，第一行”<code>.long 1f - 0f</code>“建立了一个长整型数值，表示”1:”标签相对于当前指令地址（即0f）的偏移量。偏移量可以用来计算标签对应的指令地址，从而可用于跳转或计算指针偏移量。</li>
<li>“<code>4f - 1f</code>“，即”4:”标签相对于”1:”标签的偏移量；</li>
</ul>
</li>
<li>“<code>.long 0xc0000002</code>“表示这是一个特殊的属性标记，标识这个文件可以在Linux平台上执行。它是用来告诉操作系统这个程序是用特定指令集编译的。</li>
<li>“<code>.long 0x3</code>“表示另一个属性标记，表示这个文件可以加载到任意地址。</li>
</ul>
<p>总之，这些元数据可能对程序运行起到关键作用，但在大多数情况下可能都没有明显的作用，因此看起来没有用。</p>
<h2 id="比较汇编的debugging-symbols"><a href="#比较汇编的debugging-symbols" class="headerlink" title="比较汇编的debugging symbols"></a>比较汇编的debugging symbols</h2><p>执行<code>gcc -S -g testBigExe.cpp -o testDebug.s</code>，对比之前的汇编文件，由72行变成9760行。</p>
<ul>
<li><img src="https://pic.shaojiemike.top/img/20230521195333.png" alt="-g前后"></li>
</ul>
<h3 id="loc"><a href="#loc" class="headerlink" title=".loc"></a>.loc</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.LBE32:</span><br><span class="line"> .file 3 &quot;/usr/include/c++/9/bits/char_traits.h&quot;</span><br><span class="line"> .loc 3 342 2 is_stmt 1 view .LVU4</span><br><span class="line"> .loc 1 5 11 is_stmt 0 view .LVU5</span><br></pre></td></tr></table></figure>

<ul>
<li>第一行：<code>.loc 3 342 2</code> 表示当前指令对应的源代码文件ID为3，在第342行，第2列（其中第1列是行号，第2列是第几个字符），同时<code>is_stmt</code>为1表示这条指令是语句的起始位置。</li>
<li>第二行：<code>.loc 1 5 11</code> 表示当前指令对应的源代码文件ID为1，在第5行，第11列，同时<code>is_stmt</code>为0表示这条指令不是语句的起始位置。</li>
<li><code>view .LVU4</code> 表示当前指令所处的作用域（scope）是.LVU4。作用域是指该指令所在的函数、代码块等一段范围内的所有变量和对象的可见性。在这个例子中，.LVU4 是一个局部变量作用域，因为它是位于一个C++标准库头文件中的一个函数的起始位置。</li>
</ul>
<h3 id="debug-section"><a href="#debug-section" class="headerlink" title="debug section"></a>debug section</h3><p>新增的这些 section 存储了 DWARF 调试信息。DWARF（Debugging With Attributed Record Formats）是一种调试信息的标准格式，包括代码中的变量、类型、函数、源文件的映射关系，以及代码的编译相关信息等等。</p>
<p>具体来说，这些 section 存储的内容如下：</p>
<ul>
<li><code>.debug_info</code>：包含程序的调试信息，包括编译单元、类型信息、函数和变量信息等。</li>
<li><code>.debug_abbrev</code>：包含了 .debug_info 中使用到的所有缩写名称及其对应的含义，用于压缩格式和提高效率。</li>
<li><code>.debug_loc</code>：存储每个程序变量或表达式的地址范围及其地址寄存器、表达式规则等信息。在调试时用来确定变量或表达式的值和范围。</li>
<li><code>.debug_aranges</code>：存储简化版本的地址范围描述，允许调试器加速地定位代码和数据的位置。</li>
<li><code>.debug_ranges</code>：存储每个编译单元（CU）的地址范围，每个范围都是一个有限开区间。</li>
<li><code>.debug_line</code>：存储源代码行号信息，包括每行的文件、行号、是否为语句起始位置等信息。</li>
<li><code>.debug_str</code>：包含了所有字符串，如文件名、函数名等，由于每个调试信息的数据都是字符串，因此这是所有调试信息的基础。</li>
</ul>
<p>需要注意的是，这些 section 中的信息是根据编译器的配置和选项生成的，因此不同编译器可能会生成略有不同的调试信息。</p>
<h2 id="需要进一步的研究学习"><a href="#需要进一步的研究学习" class="headerlink" title="需要进一步的研究学习"></a>需要进一步的研究学习</h2><ul>
<li>在编译的过程中，哪个阶段 label会变成真实执行地址</li>
</ul>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>暂无</p>
<h2 id="开题缘由、总结、反思、吐槽"><a href="#开题缘由、总结、反思、吐槽" class="headerlink" title="开题缘由、总结、反思、吐槽~~"></a>开题缘由、总结、反思、吐槽~~</h2><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zuofaqi/articles/12853734.html">https://www.cnblogs.com/zuofaqi/articles/12853734.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zuofaqi/articles/12853734.html">https://www.cnblogs.com/zuofaqi/articles/12853734.html</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-05-14T16:00:00.000Z" title="5/14/2023, 4:00:00 PM">2023-05-14</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-10-18T08:11:50.849Z" title="10/18/2024, 8:11:50 AM">2024-10-18</time></span><span class="level-item"><a class="link-muted" href="/categories/Network/">Network</a></span><span class="level-item">14 minutes read (About 2035 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/14/OutOfWork/3-homepage/background/PersonalWebsiteBeginners/">Web Server: Nginx V.S. Apache2</a></p><div class="content"><h2 id="常见的web服务器"><a href="#常见的web服务器" class="headerlink" title="常见的web服务器"></a>常见的web服务器</h2><p>常见的web服务器有Apache、nginx、IIS</p>
<ol>
<li>Apache<ol>
<li>Apache音译为阿帕奇, 是全世界最受欢迎的web服务器，因其快速、可靠并且可通过简单的API扩充，能将Python\Perl等解释器部署在其上面等优势，受到广泛的关注与使用。</li>
<li>但是现在用的人少了，而且性能没nginx好</li>
</ol>
</li>
<li><strong>nginx</strong><ol>
<li>Apache的致命缺陷就是在同时处理大量的（一万个以上）请求时，显得有些吃力，所以“战斗民族”的人设计的一款轻量级的web服务器——nginx, 在高并发下nginx 能保持比Apache低资源低消耗高性能 ，</li>
</ol>
</li>
<li>IIS<ol>
<li>iis是Internet Information Services的缩写，意为互联网信息服务，是由微软公司提供的基于运行Microsoft Windows的互联网基本服务,</li>
</ol>
</li>
</ol></div><a class="article-more button is-small is-size-7" href="/2023/05/14/OutOfWork/3-homepage/background/PersonalWebsiteBeginners/#more">Read more</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-05-12T16:00:00.000Z" title="5/12/2023, 4:00:00 PM">2023-05-12</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-10-18T08:11:50.857Z" title="10/18/2024, 8:11:50 AM">2024-10-18</time></span><span class="level-item"><a class="link-muted" href="/categories/Tutorials/">Tutorials</a></span><span class="level-item">9 minutes read (About 1382 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/12/OutOfWork/6-games/6-SWITCH/">Switch emulator on PC</a></p><div class="content"><h2 id="合法使用"><a href="#合法使用" class="headerlink" title="合法使用"></a>合法使用</h2><p>虽然 Ryujinx 模拟器项目本身是开源免费且合法的，但它默认情况下并不能直接运行市面上发行的各种商业游戏，因为它并<strong>不包含 Switch 系统固件</strong>，也<strong>没有游戏 ROM</strong>。</p>
<p>而按照国外的法规，如果你用户购买了主机和游戏，将其内容 DUMP (提取) 出来自己使用是合法的。</p>
<p>所以，无论是 Ryujinx 还是 Yuzu 等模拟器，想要开玩都需要先完成</p>
<ul>
<li>安装系统固件和 </li>
<li>prod.keys 密钥等步骤。<ul>
<li>如果游戏要求最新的key和firmware你需要去更新</li>
</ul>
</li>
</ul>
<h3 id="基本流程"><a href="#基本流程" class="headerlink" title="基本流程"></a>基本流程</h3><ol>
<li>下载 Ryujinx 模拟器主程序</li>
<li>下载 <code>prod.keys</code> 密钥文件以及 Switch 的系统固件 (Firmware)</li>
<li>自行网上搜索下载你喜欢的任天堂游戏文件，支持 <code>.NSP</code> 或者 <code>.XCI</code> 格式</li>
</ol>
<h2 id="密钥文件以及-Switch-的系统固件"><a href="#密钥文件以及-Switch-的系统固件" class="headerlink" title="密钥文件以及 Switch 的系统固件"></a>密钥文件以及 Switch 的系统固件</h2><ul>
<li>通过<a target="_blank" rel="noopener" href="https://www.base64decode.org/">decode</a> 知道 <a target="_blank" rel="noopener" href="https://rentry.org/128bbkeys">网站中编码</a>的下载地址<ul>
<li>为<a target="_blank" rel="noopener" href="https://drive.google.com/drive/folders/10c755wcDVn3sBb5LkxwWk-lIkZsnv40X">key</a></li>
</ul>
</li>
</ul>
<h2 id="Ryujinx-龙神-模拟器"><a href="#Ryujinx-龙神-模拟器" class="headerlink" title="Ryujinx (龙神)模拟器"></a>Ryujinx (龙神)模拟器</h2><p>率先支持了ARM和苹果 M 系列芯片</p>
<h3 id="简易步骤教程："><a href="#简易步骤教程：" class="headerlink" title="简易步骤教程："></a>简易步骤教程：</h3><ol>
<li>下载<a target="_blank" rel="noopener" href="https://ryujinx.org/download">模拟器</a>对应<a target="_blank" rel="noopener" href="https://github.com/Ryujinx/Ryujinx">github</a></li>
<li>将 Ryujinx 模拟器主程序解压到「不包含中文的路径」下。</li>
<li>首次启动 Ryujinx 模拟器后，会提示找不到 key 文件的错误<ol>
<li>点击菜单 文件 (File) → 打开 Ryujinx 文件夹 (Open Ryujinx Folder)，会弹出模拟器数据所在的目录。</li>
<li>将 <code>prod.keys</code> 文件放进到 Ryujinx 目录中的 <code>system</code> 文件夹里，重启模拟器</li>
</ol>
</li>
<li>放置好 keys 文件之后就开始安装固件 (Firmware) 了，<ol>
<li>点击菜单 工具 (Tools)→安装固件 (Install Firmware)→从 XCI 或 ZIP 安装固件 (Install a firmware from XCI or ZIP)，选择你下载到的 Firmware 压缩包(不需解压)，</li>
<li>模拟器就会开始安装，直到显示安装完成即可。</li>
</ol>
</li>
<li>此时已经可以运行 Switch 游戏了，<ol>
<li>点击菜单 选项 (Options) → 设置 (Settings)，在 用户界面 (General) → 游戏目录 (Game Directories) 下点击 添加 (Add) 来「添加一个游戏 ROM 文件存放目录」。</li>
<li>此后，模拟器会自动加载出存放在这些文件夹里的游戏列表。</li>
</ol>
</li>
</ol>
<h3 id="安装nsp-DLC文件"><a href="#安装nsp-DLC文件" class="headerlink" title="安装nsp DLC文件"></a>安装nsp DLC文件</h3><p>不是<br><img src="https://pic.shaojiemike.top/img/20221209151137.png"></p>
<p>而是<br><img src="https://pic.shaojiemike.top/img/20221209151349.png"></p>
<h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><p><img src="https://pic.shaojiemike.top/img/20221209154239.png"></p>
<p><img src="https://pic.shaojiemike.top/img/20221209154454.png"></p>
<h2 id="YUZU-柚子-模拟器"><a href="#YUZU-柚子-模拟器" class="headerlink" title="YUZU(柚子)模拟器"></a>YUZU(柚子)模拟器</h2><p><a target="_blank" rel="noopener" href="https://github.com/yuzu-emu/yuzu-mainline">yuzu</a>，奶刃2好像都是用这个</p>
<h3 id="密钥缺失"><a href="#密钥缺失" class="headerlink" title="密钥缺失"></a>密钥缺失</h3><p>将你原来的User文件夹和ROM文件夹拖到新版模拟器文件夹的根目录即可。</p>
<p>将 <code>prod.keys</code> 文件放在<code>Yuzu\user\keys</code></p>
<h3 id="更新密钥和固件"><a href="#更新密钥和固件" class="headerlink" title="更新密钥和固件"></a>更新密钥和固件</h3><ul>
<li>下面两个目录的内容都可以删除，然后解压</li>
<li>keys解压到<code>Yuzu\user\keys</code></li>
<li>固件解压到<code>Yuzu\user\nand\system\Contents\registered</code></li>
</ul>
<h3 id="YUZU模拟器使用教程"><a href="#YUZU模拟器使用教程" class="headerlink" title="YUZU模拟器使用教程"></a>YUZU模拟器使用教程</h3><p><a target="_blank" rel="noopener" href="https://www.playdanji.com/yuzu">https://www.playdanji.com/yuzu</a></p>
<h3 id="YUZU金手指"><a href="#YUZU金手指" class="headerlink" title="YUZU金手指"></a>YUZU金手指</h3><p><a target="_blank" rel="noopener" href="https://www.playdanji.com/yuzujinshouzhi">https://www.playdanji.com/yuzujinshouzhi</a></p>
<h3 id="YUZU软件升级方法"><a href="#YUZU软件升级方法" class="headerlink" title="YUZU软件升级方法"></a>YUZU软件升级方法</h3><p>Early Access版本是需要花钱订阅才能下载的。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yuzu-emu/yuzu-mainline">github</a>的release直接下载zip后解压替换即可。</p>
<h3 id="YUZU存档位置"><a href="#YUZU存档位置" class="headerlink" title="YUZU存档位置"></a>YUZU存档位置</h3><p>游戏右键，打开存档位置。</p>
<h3 id="退出全屏"><a href="#退出全屏" class="headerlink" title="退出全屏"></a>退出全屏</h3><p>F11</p>
<h3 id="YUZU-安装-nsp和xci文件"><a href="#YUZU-安装-nsp和xci文件" class="headerlink" title="YUZU 安装 nsp和xci文件"></a>YUZU 安装 nsp和xci文件</h3><p>key和中文的问题，建议用之前好的文件</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/406048136">https://zhuanlan.zhihu.com/p/406048136</a></p>
<h3 id="安装升级补丁nsp文件和DLC"><a href="#安装升级补丁nsp文件和DLC" class="headerlink" title="安装升级补丁nsp文件和DLC"></a>安装升级补丁nsp文件和DLC</h3><p><a target="_blank" rel="noopener" href="https://jingyan.baidu.com/article/39810a23e2ce82f737fda63d.html">导入NAND文件即可</a></p>
<h2 id="异度之刃2"><a href="#异度之刃2" class="headerlink" title="异度之刃2"></a>异度之刃2</h2><h3 id="打包本体1"><a href="#打包本体1" class="headerlink" title="打包本体1"></a>打包本体1</h3><p>30帧720P</p>
<p><a target="_blank" rel="noopener" href="https://switch520.com/23050.html">https://switch520.com/23050.html</a></p>
<h3 id="推荐OpenGL模式"><a href="#推荐OpenGL模式" class="headerlink" title="推荐OpenGL模式"></a>推荐OpenGL模式</h3><p>v模式，暗场景会过曝。</p>
<h3 id="画质补丁"><a href="#画质补丁" class="headerlink" title="画质补丁"></a>画质补丁</h3><p><a target="_blank" rel="noopener" href="https://tieba.baidu.com/p/6733982266">贴吧老哥的</a>放入目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\gamePojie\NaiRen2\A3285 v2.0.2_yuzuEA2077\user\sdmc\atmosphere\contents</span><br></pre></td></tr></table></figure>

<p>但是没什么用。</p>
<p>ini配置原理是，如下图<strong>对应</strong>配置目录<br><img src="https://pic.shaojiemike.top/img/20220620165029.png"></p>
<p>放入如下修改的ini文件来修改画质</p>
<p><img src="https://pic.shaojiemike.top/img/20220620165155.png"></p>
<p>如下图成功</p>
<p><img src="https://pic.shaojiemike.top/img/20220620165322.png"></p>
<p><a target="_blank" rel="noopener" href="https://tieba.baidu.com/p/7459891171">贴吧10楼</a>：刚试了下，我把属性的mod选项关掉，然后把0100F3400332C000的画质mod删掉，效果一样有，所以效果应该只能在0100F3400332D001\画质mod\romfs\monolib\shader下的lib_nx.ini里改，其他的都没用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">red_sclX=2.0</span><br><span class="line">red_sclY=2.0</span><br><span class="line">red_hdsclX=2.0</span><br><span class="line">red_hdsclY=2.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">red_Auto=on</span><br><span class="line">red_AtMaxX=2.0</span><br><span class="line">red_AtMaxY=2.0</span><br><span class="line">red_AtMinX=2.0</span><br><span class="line">red_AtMinY=2.0</span><br><span class="line">red_AtRate=100.0</span><br></pre></td></tr></table></figure>

<p>2.0就是1440p，1.0就是原版720p。你们可以试试改其他的</p>
<h3 id="帧数补丁"><a href="#帧数补丁" class="headerlink" title="帧数补丁"></a>帧数补丁</h3><p>60帧补丁实际效果远没有60帧而且一堆副作用，不用浪费时间了</p>
<h3 id="bug花屏"><a href="#bug花屏" class="headerlink" title="bug花屏"></a>bug花屏</h3><p>按照<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1h3411L7ay?spm_id_from=333.851.header_right.fav_list.click&vd_source=5bbdecb1838c6f684e0b823d0d4f6db3">B站设置</a>，主要改了GLSL</p>
<p><img src="https://pic.shaojiemike.top/img/20220622072520.png"></p>
<h2 id="塞尔达-旷野之息"><a href="#塞尔达-旷野之息" class="headerlink" title="塞尔达-旷野之息"></a>塞尔达-旷野之息</h2><p>游侠论坛的cemu模拟的效果就不错</p>
<h2 id="塞尔达-王国之泪"><a href="#塞尔达-王国之泪" class="headerlink" title="塞尔达-王国之泪"></a>塞尔达-王国之泪</h2><ul>
<li>yuzu 1414以上</li>
<li>keys firmware 16.0.2以上</li>
</ul>
<p>龙神模拟器，会经常闪退，暂时不知道解决办法(Cache PPTC rebuild?)。yuzu没有闪退的问题<br><img src="https://pic.shaojiemike.top/img/20230512210628.png"></p>
<h2 id="需要进一步的研究学习"><a href="#需要进一步的研究学习" class="headerlink" title="需要进一步的研究学习"></a>需要进一步的研究学习</h2><p>暂无</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>暂无</p>
<h2 id="开题缘由、总结、反思、吐槽"><a href="#开题缘由、总结、反思、吐槽" class="headerlink" title="开题缘由、总结、反思、吐槽~~"></a>开题缘由、总结、反思、吐槽~~</h2><p>之前买了正版的switch，游戏也入了两三千。旷&#x2F;荒野之息，奥德赛，奶刃2都通关了。可惜被妈妈没收了~</p>
<p>想研究一下，PC模拟，记录踩坑过程</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><div id='refer-anchor'></div>
无
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-05-11T16:00:00.000Z" title="5/11/2023, 4:00:00 PM">2023-05-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-10-18T08:11:50.981Z" title="10/18/2024, 8:11:50 AM">2024-10-18</time></span><span class="level-item"><a class="link-muted" href="/categories/toLearn/">toLearn</a></span><span class="level-item">23 minutes read (About 3410 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/11/Work/network/Protocol/BT/">BitTorrent</a></p><div class="content"><h2 id="BT简述"><a href="#BT简述" class="headerlink" title="BT简述"></a>BT简述</h2><p>BitTorrent (简称 BT) 协议是和点对点（point-to-point）的协议程序不同，它是用户群对用户群（peer-to-peer, 或简写为 P2P) 传输协议, 它被设计用来高效地分发文件 (尤其是对于大文件、多人同时下载时效率非常高)。该协议基于HTTP协议，属于TCP&#x2F;IP应用层。</p>
<p>将文件划分成多块(默认256Kb一块)，每块可以从网络中不同的用户的BT客户端处并行下载。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BT 下载的文件都是别人上传给你的。</span><br><span class="line">BT 下载速度均来自其他下载同一资源的用户上传速度。</span><br><span class="line">上传的用户越多，你的下载速度越快，相反没用户上传你就没有下载速度。</span><br></pre></td></tr></table></figure>

<p>比特彗星，包括其他 BT 软件（迅雷除外，迅雷不是会员会限速，高速通道下载提高的速度一部分就是接触限速后获得的）都不会限制下载速度。</p>
<h3 id="BT分享规则"><a href="#BT分享规则" class="headerlink" title="BT分享规则"></a>BT分享规则</h3><p>与迅雷不同，BT旨在“人人为我，我为人人”。用户和用户之间对等交换自己手中已有的资源。如果任何一方试图白嫖另外一方的资源，而自己不愿意上传自己的资源，那么那方就会被人视作吸血者而被踢出这个交换，下场是没有人会愿意和你交换数据，你的下载速度也就归零。</p>
<p>如果把上传速度限制为了10KB&#x2F;s，10KB&#x2F;s是BitComet上传最低限速，很大时候就这10KB会被包含DHT查询、向Tracker服务器注册，连接用户所产生的上传全部占满。在下载种子的时候，其他用户连上你是只能拿到1～2KB&#x2F;s甚至一点都没有的。</p>
<p>现在的BT下载客户端都可以做到智能反吸血，所以基本想和交换数据的用户都把你当作Leecher（吸血鬼）Ban（封禁）处理了，故没有下载速度不足为奇。</p>
<p>一般来说，只要预留50KB&#x2F;s的上传给其他网页浏览、聊天就可以了，在下载时应该尽量把上传留给那些和你交换资源的用户，这样才不会被他们视作你在吸血进而屏蔽你。</p>
<p>如果上传不足，就应该主动限制自己的下载速度，否则单位时间下载量远超过上传量反而会遭来更多的屏蔽，对下载速度提升更加不利。</p>
<h3 id="BT基本流程"><a href="#BT基本流程" class="headerlink" title="BT基本流程"></a>BT基本流程</h3><p><code>.torrent</code> 种子文件本质上是文本文件，包含Tracker信息和文件信息两部分。Tracker信息主要是BT下载中需要用到的Tracker服务器的地址和针对Tracker服务器的设置。</p>
<ol>
<li>下载时，BT客户端首先解析种子文件得到Tracker地址，然后连接Tracker服务器。</li>
<li>Tracker服务器回应下载者的请求，提供下载者其他下载者（包括发布者）的IP。</li>
<li>下载者再连接其他下载者，根据种子文件，两者分别告知对方自己已经有的块，然后交换对方所没有的数据。<ol>
<li>此时不需要其他服务器参与，分散了单个线路上的数据流量，因此减轻了服务器负担。</li>
</ol>
</li>
<li>下载者每得到一个块，需要算出下载块的Hash验证码与种子文件中的对比，如果一样则说明块正确，不一样则需要重新下载这个块。这种规定是为了解决下载内容准确性的问题。</li>
</ol>
<h2 id="常规部署"><a href="#常规部署" class="headerlink" title="常规部署"></a>常规部署</h2><ul>
<li>安装<a target="_blank" rel="noopener" href="https://manpages.ubuntu.com/manpages/jammy/man1/qbittorrent-nox.1.html">qBittorrent-nox</a>, tmux下运行，在8080端口挂载WebUI</li>
<li>安装qbittorrent, 用户运行qbittorrent, x11弹出应用窗口<ul>
<li>问题：<ul>
<li>怎么维持窗口？<code>sudo XAUTHORITY=/home/qcjiang/.Xauthority qbittorrent</code></li>
<li>关于写文件权限，如何写网络硬盘</li>
<li>node5 上传很快, 网络原因？种子原因？(不是，是因为网络硬盘，所以下载多少要占用多少上传)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="docker部署"><a href="#docker部署" class="headerlink" title="docker部署"></a>docker部署</h2><p>以qBit的docker为例，参考<a target="_blank" rel="noopener" href="https://hub.docker.com/r/linuxserver/qbittorrent/#!">linuxsever</a>的docker-compose如下：(qBit相对于Transmission有多线程IO的优势) 也可以使用<a target="_blank" rel="noopener" href="https://github.com/SuperNG6/Docker-qBittorrent">其余docker镜像</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">version: &quot;2.1&quot;</span><br><span class="line">services:</span><br><span class="line">  qbittorrent:</span><br><span class="line">    image: lscr.io/linuxserver/qbittorrent:latest</span><br><span class="line">    container_name: qbittorrent</span><br><span class="line">    environment:</span><br><span class="line">      - PUID=0 # 这里是root 如果想以其他用戶A修改文件，可以改成其他用户的UID。通過id A 查看</span><br><span class="line">      - PGID=0</span><br><span class="line">      - TZ=Etc/UTC</span><br><span class="line">      - WEBUI_PORT=8080</span><br><span class="line">    volumes:</span><br><span class="line">      - /addDisk/DiskNo4/qBit:/config</span><br><span class="line">      - /addDisk/DiskNo4/bt:/downloads</span><br><span class="line"></span><br><span class="line">    network_mode: host</span><br><span class="line">    restart: unless-stopped</span><br></pre></td></tr></table></figure>

<p>默认账号 <code>admin</code> 默认密码 <code>adminadmin</code><br>然后通过webUI <code>http://222.195.72.218:8080/</code>管理。</p>
<article class="message is-success">
        <div class="message-header"><p><i class="fa-brands fa-gripfire mr-2"></i>忘记密码处理</p>
</div>
        <div class="message-body">
            <p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/374538088">修改对应配置文件，</a></p>

        </div>
    </article>

<p>如果不想网络通过wireguard，而是本地可以如下设置</p>
<p><img src="https://pic.shaojiemike.top/img/20230314193709.png"></p>
<h3 id="同一台机器实现两个账号做种"><a href="#同一台机器实现两个账号做种" class="headerlink" title="同一台机器实现两个账号做种"></a>同一台机器实现两个账号做种</h3><ul>
<li>思路：两个docker，同一个网络出口</li>
<li>問題：<ul>
<li>qBit要有权限写文件</li>
<li>两个docker兼容性：<ul>
<li>WebUI有bug，不一定会显示。重启刷新即可</li>
<li>其次有一个docker会没有网络。<ul>
<li>这是由于端口随机错误导致的，会导致下面连接状态显示火焰。换端口刷新即可解决。</li>
<li><img src="https://pic.shaojiemike.top/img/20230512090749.png"></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>关于封号<ul>
<li>由于国内环境下载一般都是大内网。同一个网络出去应该没有问题。</li>
<li>大多数做种是通过ipv6，会被检测出同一个机器多个账户做种，导致封号</li>
<li>还有关于盒子刷上传，一方面通过速度，另一方面由于盒子的ip是固定的，所以会被检测出重复导致封号。</li>
</ul>
</li>
</ul>
<h2 id="测速"><a href="#测速" class="headerlink" title="测速"></a>测速</h2><ol>
<li>先用 <a target="_blank" rel="noopener" href="https://www.speedtest.net/">https://www.speedtest.net</a> 测速<ol>
<li><img src="https://pic.shaojiemike.top/img/20221117082208.png"></li>
</ol>
</li>
<li>考虑热门种子测试 <a target="_blank" rel="noopener" href="http://releases.ubuntu.com/19.10/ubuntu-19.10-desktop-amd64.iso.torrent">http://releases.ubuntu.com/19.10/ubuntu-19.10-desktop-amd64.iso.torrent</a><ol>
<li><img src="https://pic.shaojiemike.top/img/20221117084350.png"></li>
<li>没通过代理能找到的用户变少，速度也变慢了。</li>
</ol>
</li>
<li>如果跑不到网络上限，可能和<a target="_blank" rel="noopener" href="https://www.cometbbs.com/t/%E8%A2%AB%E9%99%90%E9%80%9F%E5%9C%A8109mbs/34309/13">软件设置有关</a></li>
</ol>
<h2 id="上传速度"><a href="#上传速度" class="headerlink" title="上传速度"></a>上传速度</h2><p>m站刷上传的时候，发现基本都是对方基本都是通过ipv6下载<br><img src="https://pic.shaojiemike.top/img/Snipaste_2023-03-06_18-17-07.png"><br>uTP是一种基于UDP的协议，它可以根据网络拥塞情况自动调节传输速度，从而减少对其他网络应用的影响。</p>
<p>BT连接是一种基于TCP的协议，它可以保证数据的完整性和可靠性，但是可能会占用较多的网络带宽和资源。</p>
<p>在qBittorrent中，标志U K E P分别表示以下含义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">U：表示你正在上传数据给对方，或者对方正在从你那里下载数据。</span><br><span class="line">K：表示对方支持uTP协议，即基于UDP的传输协议。</span><br><span class="line">E：表示对方使用了加密连接，即通过加密算法保护数据的安全性。</span><br><span class="line">P：表示对方使用了代理服务器或VPN服务，即通过第三方网络隐藏自己的真实IP地址。</span><br></pre></td></tr></table></figure>

<h2 id="PT设置"><a href="#PT设置" class="headerlink" title="PT设置"></a>PT设置</h2><ul>
<li>虽然说PT下载，客户端要关闭DHT,PeX, LSD。</li>
<li>但是其实种子是默认关闭的，无序额外设置，北洋和M站一样。</li>
<li><img src="https://pic.shaojiemike.top/img/20230512091246.png"></li>
</ul>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="Tracker"><a href="#Tracker" class="headerlink" title="Tracker"></a>Tracker</h3><p>收集下载者信息的服务器，并将此信息提供给其他下载者，使下载者们相互连接起来，传输数据。</p>
<h3 id="种子"><a href="#种子" class="headerlink" title="种子"></a>种子</h3><p>指一个下载任务中所有文件都被某下载者<strong>完整</strong>的下载，此时下载者成为一个种子。发布者本身发布的文件就是原始种子。</p>
<h3 id="做种"><a href="#做种" class="headerlink" title="做种"></a>做种</h3><p>发布者提供下载任务的<strong>全部</strong>内容的行为；下载者下载完成后继续提供给他人下载的行为。</p>
<h3 id="分享率"><a href="#分享率" class="headerlink" title="分享率"></a>分享率</h3><p>上傳資料量 &#x2F; 下傳資料量的比率,是一種BT的良心度,沒實際作用.(一般为了良心，至少大于1)</p>
<h3 id="长期种子"><a href="#长期种子" class="headerlink" title="长期种子"></a>长期种子</h3><p>BitComet的概念，相对于种子任务的上传能够控制。</p>
<p>长效种子就是你<strong>不开启</strong>任务做种，只要你启动了比特彗星，软件挂后台，当有其他用户也是用比特彗星下载你列表里的存在的文件时候就会被认为是长效种子 。</p>
<h3 id="DHT"><a href="#DHT" class="headerlink" title="DHT"></a>DHT</h3><p>.DHT全称叫分布式哈希表(Distributed Hash Table)，是一种分布式存储方法。在不需要服务器的情况下，每个客户端负责一个小范围的路由，并负责存储一小部分数据，从而实现整个DHT网络的寻址和存储。新版BitComet允许同行连接DHT网络和Tracker，也就是说在完全不连上Tracker服务器的情况下，也可以很好的下载，因为它可以在DHT网络中寻找下载同一文件的其他用户。</p>
<p>类似Tracker的根据种子特征码返回种子信息的网络。</p>
<p>在BitComet中，无须作任何设置即可自动连接并使用DHT网络，完全不需要用户干预。</p>
<h3 id="用户交换Pex"><a href="#用户交换Pex" class="headerlink" title="用户交换Pex"></a>用户交换Pex</h3><p>Peer Exchange (PEX)， 每个peer客户端的用户列表，可以互相交换通用。可以将其理解为“节点信息交换”。前面说到了 DHT 网络是没有中心服务器的，那么我们的客户端总不能满世界去喊：“我在下载这个文件，快来连我吧.”（很大声）。所以就通过各个 BT 客户端自带的节点去同步路由表实现 DHT 网络连接。</p>
<h3 id="本地用户发现"><a href="#本地用户发现" class="headerlink" title="本地用户发现"></a>本地用户发现</h3><p>LSD（LPD）就是本地网络资源，内网下载，没什么几把用的东西，可能学校等私有网络好使</p>
<h3 id="ISP"><a href="#ISP" class="headerlink" title="ISP"></a>ISP</h3><p>網絡業務提供商(Internet Service Provider，簡稱ISP)，互聯網服務提供商，即向廣大用户綜合提供互聯網接入業務、信息業務、和增值業務的電信運營商。</p>
<h2 id="反吸血机制"><a href="#反吸血机制" class="headerlink" title="反吸血机制"></a>反吸血机制</h2><h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><ol>
<li>根据<strong>流量</strong>： 默认设置为120秒，持续对某个peer产生上传，并且从该peer用户获取的下载流量没有超过1KB文件（1024字节）大小，即拉黑该peer，预警颜色为黄色，合法为绿色，红色为封禁。</li>
<li>可组合检测<strong>指定客户端</strong>进行反吸血，比如说指定屏蔽qbittorrent、utorrent等吸血客户端选择（可多选客户端，可对下载任务和做种任务生效）</li>
<li>可组合检测客户端<strong>连接端口号</strong>进行反吸血，比如说指定屏蔽15000迅雷X版本客户端等吸血端口（可多选端口号，可对下载任务和做种任务生效）</li>
<li>可组合检测客户端<strong>连接peer_id标志符</strong>进行反吸血屏蔽，例如屏蔽XL0018客户端等吸血标志符（可多选标志符，可对下载任务和做种任务生效）</li>
</ol>
<h3 id="高级设置"><a href="#高级设置" class="headerlink" title="高级设置"></a>高级设置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bittorrent.anti_leech_min_byte</span><br><span class="line">设定反吸血保护流量：要求对方在指定时间（秒）内需要上传的最少流量（byte）， 取值范围：1-10000。</span><br><span class="line"></span><br><span class="line">bittorrent.anti_leech_min_stable_sec</span><br><span class="line">设定反吸血保护时间：指定与对方连接多长时间（秒）后开始检查流量（byte），取值范围：1-10000。</span><br></pre></td></tr></table></figure>

<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="需要软件开着吗？"><a href="#需要软件开着吗？" class="headerlink" title="需要软件开着吗？"></a>需要软件开着吗？</h3><p>需要</p>
<h3 id="原文件改名或者移动，还会上传吗？"><a href="#原文件改名或者移动，还会上传吗？" class="headerlink" title="原文件改名或者移动，还会上传吗？"></a>原文件改名或者移动，还会上传吗？</h3><p>文件下载后不能移动，不能删除，不能重命名（但可以在软件内改）。 一但BT 软件找不到文件，或删除了任务，就无法做种上传了。</p>
<h3 id="晚上避免上传"><a href="#晚上避免上传" class="headerlink" title="晚上避免上传"></a>晚上避免上传</h3><p>可以在Bitcomet<strong>高级设置</strong>里设置<strong>时段限速</strong></p>
<h3 id="对硬盘损害大吗？"><a href="#对硬盘损害大吗？" class="headerlink" title="对硬盘损害大吗？"></a>对硬盘损害大吗？</h3><p>分享上传也需要频繁读取硬盘。</p>
<p>以Bitcomet为例，该软件就是通过磁盘缓存技术减小频繁随机读写对硬盘的损伤。</p>
<p>磁盘缓存就是利用物理内存作为缓冲，将下载下的数据先存放于内存中，然后定期的一次性写入硬盘，以减少对硬盘的写入操作，很大的程度上降低了磁盘碎片。</p>
<p>因为通常我们设置内存（磁盘缓存）为每任务XX兆，意味着，这个缓冲区可以存放数兆甚至几十兆的“块”，基本上可以杜绝碎片了。</p>
<p>现在BT软件都是自动设置缓存的，它是根据你物理内存的大小分配的。</p>
<h2 id="注意设置"><a href="#注意设置" class="headerlink" title="注意设置"></a>注意设置</h2><ol>
<li>设置了“反吸血”，应对迅雷</li>
<li>校园网设置9，不限制P2P<ol>
<li>国内各省份不同运营商限速策略（QOS）</li>
</ol>
</li>
</ol>
<h2 id="需要进一步的研究学习"><a href="#需要进一步的研究学习" class="headerlink" title="需要进一步的研究学习"></a>需要进一步的研究学习</h2><p>路由器下载？</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-05-11T16:00:00.000Z" title="5/11/2023, 4:00:00 PM">2023-05-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-10-18T08:11:50.981Z" title="10/18/2024, 8:11:50 AM">2024-10-18</time></span><span class="level-item"><a class="link-muted" href="/categories/toLearn/">toLearn</a></span><span class="level-item">9 minutes read (About 1300 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/11/Work/network/example/mountNetworkDisk/">Mount Network Disk</a></p><div class="content"><article class="message is-info">
        <div class="message-header"><p><i class="fa-solid fa-clipboard mr-2"></i>导言</p>
</div>
        <div class="message-body">
            <p>想将Nas上的盘挂载到常驻的Ubuntu机器上，供jellyfin读取。</p>

        </div>
    </article></div><a class="article-more button is-small is-size-7" href="/2023/05/11/Work/network/example/mountNetworkDisk/#more">Read more</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-05-11T16:00:00.000Z" title="5/11/2023, 4:00:00 PM">2023-05-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-10-18T08:11:50.981Z" title="10/18/2024, 8:11:50 AM">2024-10-18</time></span><span class="level-item"><a class="link-muted" href="/categories/network/">network</a></span><span class="level-item">8 minutes read (About 1233 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/11/Work/network/vpn/3-cloudflare/">Cloudflare warp proxy</a></p><div class="content"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li>Cloudflare 作为全球最大的网络服务提供商，全球大约有30%的网络服务由它提供。</li>
<li>WARP是Cloudflare提供的免费的，没有带宽上限或限制的VPN服务，可以让你在任何地方访问互联网，而不会受到地域限制。<ul>
<li>WARP软件是基于wireguard魔改的。</li>
<li>WARP有安卓和Windows的客户端，但是使用人数过多，体验并不好</li>
<li>Linux下通过WARP代理能实现20MB&#x2F;s的下载速度。</li>
</ul>
</li>
</ul>
<h2 id="WARP-on-Linux"><a href="#WARP-on-Linux" class="headerlink" title="WARP on Linux"></a>WARP on Linux</h2><h3 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h3><ul>
<li>缘由：WARP下的PT做种快得多。(不是，是因为网络硬盘，所以下载多少要占用多少上传)</li>
<li><a target="_blank" rel="noopener" href="https://github.com/P3TERX/warp.sh">参考教程</a>。</li>
<li>脚本和所需文件在<code>Z:\shaojiemike\Documents\文献\计算机网络</code>目录下。这里先使用fjw的脚本。</li>
</ul>
<ol>
<li>通过注册脚本<code>register.py</code>，获得私钥和分配的ip</li>
<li>配置wg。其中Endpoint端口可从官方文档中找到，默认的2408很可能被封。<a target="_blank" rel="noopener" href="https://developers.cloudflare.com/cloudflare-one/connections/connect-devices/warp/deployment/firewall/">WARP with firewall · Cloudflare Zero Trust docs</a> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Interface]</span><br><span class="line">PrivateKey = xxxx         #register.py的私钥</span><br><span class="line">Address = xxx/32,xxx/128  #register.py的ipv4和ipv6</span><br><span class="line">Table = off              # off禁止wg修改路由表</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = bmXOC+F1FxEMF9dyiK2H5/1SUtzH0JuVo51h2wPfgyo=</span><br><span class="line">AllowedIPs = 0.0.0.0/0,::/0</span><br><span class="line">Endpoint = [2606:4700:d0::a29f:c001]:500    #2408, 1701, 500, 4500</span><br><span class="line">PersistentKeepalive = 25</span><br></pre></td></tr></table></figure></li>
<li>warp使用的不是标准的wg协议，root下运行，需要通过一个nft脚本<code>main.sh</code>修改包的3个字节。<ol>
<li>安装nft <code>apt-get install nftables</code></li>
<li>需要<code>/etc/default/warp-helper</code>文件填写对应的</li>
<li>ROUTING_ID对应register.py的ROUTING_ID。注意三个数之间没空格</li>
<li>UPSTREAM对应<code>wg-conf</code>里Endpoint。比如：</li>
<li><pre><code>  ROUTING_ID=11,45,14
  UPSTREAM=[2606:4700:d0::a29f:c001]:500
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">2. 最后开启路由表,Root权限运行` ip route add default dev warp proto static scope link table default`</span><br><span class="line"></span><br><span class="line">## WARP on OpenWRT </span><br><span class="line"></span><br><span class="line">* 目的：为了防止大量流量通过WARP，导致被官方封禁，所以只在OpenWRT上配置WARP分流github的流量。</span><br><span class="line">* 实现思路：</span><br><span class="line">  * 运行python脚本，通过github的API获得所有的github域名ip，</span><br><span class="line">  * 使用iptables的warp_out表，将目的地址为github域名ip路由到WARP的虚拟网卡上。</span><br><span class="line"></span><br><span class="line">### WARP Wireguard Establishment</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line">python register.py #自动生成warp-op.conf,warp.conf和warp-helper</span><br><span class="line">mv warp-helper /etc/default</span><br><span class="line"># cat main.sh</span><br><span class="line"># cat warp-op.conf</span><br><span class="line">vim /etc/config/network #填写warp-op.conf内容，默认只转发172.16.0.0/24来测试连接</span><br><span class="line">ifup warp #启动warp, 代替wg-quick up warp.conf</span><br><span class="line">bash main.sh #启动防火墙实现报文头关键三字节修改</span><br><span class="line">nft list ruleset #查看防火墙，是否配置成功</span><br><span class="line">wg #查看warp状态，测试是否连接成果</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ol>
</li>
</ol>
<p>这时还没创建warp_out路由表，所以还不能通过WARP出数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/etc/config/network</span></span><br><span class="line">config interface <span class="string">&#x27;warp&#x27;</span></span><br><span class="line">        option proto <span class="string">&#x27;wireguard&#x27;</span></span><br><span class="line">        option private_key <span class="string">&#x27;wKpvFCOk4sf8d/RD001TF7sNQ39bWnllpqaFf8QnHG4=&#x27;</span></span><br><span class="line">        option listen_port <span class="string">&#x27;51825&#x27;</span></span><br><span class="line">        list addresses <span class="string">&#x27;172.16.0.2/32&#x27;</span></span><br><span class="line">        list addresses <span class="string">&#x27;2606:4700:110:8466:d4ea:ffb8:10da:470f/128&#x27;</span></span><br><span class="line">        <span class="comment">#option disabled &#x27;1&#x27; </span></span><br></pre></td></tr></table></figure>
<p>然后WebUI点击apply 或者命令行运行<code>ifconfig warp down &amp;&amp; ifup</code></p>
<h3 id="Network-planning-and-design"><a href="#Network-planning-and-design" class="headerlink" title="Network planning and design"></a>Network planning and design</h3><p>添加了WARP的网络出口后，路由器不在只是通过WAN出数据。防火墙需要更新：<img src="https://pic.shaojiemike.top/img/20230330200503.png"></p>
<ul>
<li>原路返回规则。<ul>
<li>针对有公网ip的接口，需要原路返回。<ul>
<li>配置来自wan和WARP的信报，使用wan和WARP的路由表，优先级3</li>
<li>来自wan的比如来自外部的ssh，为了防止失联。</li>
<li>来自WARP的比如<code>wget --bind-address=WARP_ip</code>来模拟</li>
</ul>
</li>
<li>内网地址没有必要配置，因为通过内网地址访问host，则dst必然也是内网地址。因此会匹配main中的内网地址规则。</li>
</ul>
</li>
<li>wan和WARP的路由表内各自走wan和WARP的网卡</li>
<li>为了使得原本wg正常运行，<code>10:     from all lookup main suppress_prefixlength 1</code><ul>
<li>假如warp_out是defualt规则，该项也是为了防止失联。</li>
</ul>
</li>
<li>创建warp_out的空路由表<code>1000:   from all lookup warp_out</code>,优先级1000</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@tsjOp:~/warp# ip rule</span><br><span class="line">0:      from all lookup local</span><br><span class="line">3:      from 114.214.233.141/22 iif eth1 lookup wan</span><br><span class="line">3:      from 172.16.0.2 iif warp lookup warp</span><br><span class="line">10:     from all lookup main suppress_prefixlength 1</span><br><span class="line">1000:   from all lookup warp_out</span><br><span class="line">32766:  from all lookup main</span><br><span class="line">32767:  from all lookup default</span><br></pre></td></tr></table></figure>

<h3 id="填充warp-out路由表"><a href="#填充warp-out路由表" class="headerlink" title="填充warp_out路由表"></a>填充warp_out路由表</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ip_route</span><br><span class="line"><span class="built_in">mv</span> ../github_ipv4.txt .</span><br><span class="line">python fill_ip_table.py --table warp_out --iface warp --p2p -f github_ipv4.txt</span><br></pre></td></tr></table></figure>

<p>对所有github域名的ip执行类似<code>ip ro add 192.30.252.0/22 dev warp proto static table warp_out</code>操作。</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mtr www.github.com</span><br><span class="line">ssh -vT git@github.com</span><br><span class="line">git clone https://github.com/llvm/llvm-project</span><br></pre></td></tr></table></figure>

<h3 id="添加到启动项"><a href="#添加到启动项" class="headerlink" title="添加到启动项"></a>添加到启动项</h3><p>修改<code>/etc/rc.local</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Put your custom commands here that should be executed once</span></span><br><span class="line"><span class="comment"># the system init finished. By default this file does nothing.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">sleep</span> 30 &amp;&amp; <span class="built_in">cd</span> /root/warp/ip_route &amp;&amp; python fill_ip_table.py --table warp_out --iface warp --p2p -f github_ipv4.txt</span><br><span class="line"></span><br><span class="line">/root/warp/main.sh <span class="comment">#重新添加防火墙</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<h2 id="WARP-on-Windows"><a href="#WARP-on-Windows" class="headerlink" title="WARP on Windows"></a>WARP on Windows</h2><p>基于1.1.1.1 的安装windows版本直接白嫖</p>
<h2 id="需要进一步的研究学习"><a href="#需要进一步的研究学习" class="headerlink" title="需要进一步的研究学习"></a>需要进一步的研究学习</h2><p>暂无</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>暂无</p>
<h2 id="开题缘由、总结、反思、吐槽"><a href="#开题缘由、总结、反思、吐槽" class="headerlink" title="开题缘由、总结、反思、吐槽~~"></a>开题缘由、总结、反思、吐槽~~</h2><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a target="_blank" rel="noopener" href="https://gist.github.com/iBug/3107fd4d5af6a4ea7bcea4a8090dcc7e">https://gist.github.com/iBug/3107fd4d5af6a4ea7bcea4a8090dcc7e</a></p>
<p>glados</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-05-11T16:00:00.000Z" title="5/11/2023, 4:00:00 PM">2023-05-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-10-18T08:11:50.937Z" title="10/18/2024, 8:11:50 AM">2024-10-18</time></span><span class="level-item"><a class="link-muted" href="/categories/Tutorials/">Tutorials</a></span><span class="level-item">7 minutes read (About 1110 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/11/Work/software/linux-sys/services/">Services Systemd Systemclt</a></p><div class="content"><h2 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h2><h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>历史上，Linux 的启动一直采用init进程。<br>下面的命令用来启动服务。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo /etc/init.d/apache2 start</span><br><span class="line"># 或者</span><br><span class="line">$ service apache2 start</span><br></pre></td></tr></table></figure>
<p>这种方法有两个缺点。</p>
<p>一是启动时间长。init进程是串行启动，只有前一个进程启动完，才会启动下一个进程。</p>
<p>二是启动脚本复杂。init进程只是执行启动脚本，不管其他事情。脚本需要自己处理各种情况，这往往使得脚本变得很长。</p>
<h3 id="Systemd"><a href="#Systemd" class="headerlink" title="Systemd"></a>Systemd</h3><p>Systemd 就是为了解决这些问题而诞生的。它的设计目标是，为系统的启动和管理提供一套完整的解决方案。</p>
<p>根据 Linux 惯例，字母d是守护进程（daemon）的缩写。 Systemd 这个名字的含义，就是它要守护整个系统。</p>
<p>使用了 Systemd，就不需要再用init了。Systemd 取代了initd，成为系统的第一个进程（PID 等于 1），其他进程都是它的子进程。</p>
<p>Systemd 的优点是功能强大，使用方便，缺点是体系庞大，非常复杂。事实上，现在还有很多人反对使用 Systemd，理由就是它过于复杂，与操作系统的其他部分强耦合，违反”keep simple, keep stupid”的Unix 哲学。<br><img src="https://pic.shaojiemike.top/img/20220628174222.png"></p>
<h3 id="systemctl"><a href="#systemctl" class="headerlink" title="systemctl"></a>systemctl</h3><p>systemctl是 Systemd 的主命令，用于管理系统。</p>
<p> systemctl - Control the systemd system and service manager</p>
<h3 id="systemctl常见命令"><a href="#systemctl常见命令" class="headerlink" title="systemctl常见命令"></a>systemctl常见命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">systemctl is-enabled servicename.service #查询服务是否开机启动</span><br><span class="line">systemctl enable *.service #开机运行服务</span><br><span class="line">systemctl disable *.service #取消开机运行</span><br><span class="line">systemctl start *.service #启动服务</span><br><span class="line">systemctl stop *.service #停止服务</span><br><span class="line">systemctl restart *.service #重启服务</span><br><span class="line">systemctl reload *.service #重新加载服务配置文件</span><br><span class="line">systemctl status *.service #查询服务运行状态</span><br><span class="line">systemctl --failed #显示启动失败的服务</span><br></pre></td></tr></table></figure>
<h3 id="systemctl命令实操"><a href="#systemctl命令实操" class="headerlink" title="systemctl命令实操"></a>systemctl命令实操</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 查看相关unit</span><br><span class="line">shaojiemike@tsjNas:~$ systemctl|grep wg</span><br><span class="line">  pkg-wg-quick@wg0.service</span><br><span class="line">       loaded active exited  WireGuard via wg-quick(8) for wg0</span><br><span class="line"></span><br><span class="line"># 查看已经启动的服务</span><br><span class="line">systemctl list-unit-files --state=enabled|grep wg</span><br><span class="line">pkg-wg-quick@.service                     enabled //由于我删除了wg0，所以.service前没wg0</span><br><span class="line"></span><br><span class="line"># 删除服务</span><br><span class="line">sh-4.4#  systemctl disable pkg-wg-quick@.service</span><br><span class="line">Removed symlink /etc/systemd/system/syno-low-priority-packages.target.wants/pkg-wg-quick@wg0.service.</span><br></pre></td></tr></table></figure>

<h3 id="开机启动原理"><a href="#开机启动原理" class="headerlink" title="开机启动原理"></a>开机启动原理</h3><p>Systemd 默认从目录<code>/etc/systemd/system/</code>读取配置文件。但是，里面存放的大部分文件都是符号链接，指向目录<code>/usr/lib/systemd/system/</code>，真正的配置文件存放在那个目录。</p>
<p><code>systemctl enable</code>命令用于在上面两个目录之间，建立符号链接关系。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; $ sudo systemctl enable clamd@scan.service</span><br><span class="line"># 等同于</span><br><span class="line">$ sudo ln -s &#x27;/usr/lib/systemd/system/clamd@scan.service&#x27; &#x27;/etc/systemd/system/multi-user.target.wants/clamd@scan.service&#x27;</span><br><span class="line">&gt; </span><br></pre></td></tr></table></figure>
<p>如果配置文件里面设置了开机启动，<code>systemctl enable</code>命令相当于激活开机启动。</p>
<p>与之对应的，<code>systemctl disable</code>命令用于在两个目录之间，撤销符号链接关系，相当于撤销开机启动。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; $ sudo systemctl disable clamd@scan.service</span><br><span class="line">&gt; </span><br></pre></td></tr></table></figure>
<p>配置文件的后缀名，就是该 Unit 的种类，比如<code>sshd.socket</code>。如果省略，Systemd 默认后缀名为<code>.service</code>，所以<code>sshd</code>会被理解成<code>sshd.service</code>。</p>
<h2 id="把程序设置systemctl服务-并开机启动"><a href="#把程序设置systemctl服务-并开机启动" class="headerlink" title="把程序设置systemctl服务,并开机启动"></a>把程序设置systemctl服务,并开机启动</h2><ol>
<li>Systemd 默认从目录<code>/etc/systemd/system/</code>读取配置文件。但是，里面存放的大部分文件都是符号链接，指向目录<code>/usr/lib/systemd/system/</code>，真正的配置文件存放在那个目录。</li>
<li>进入目录<code>/usr/lib/systemd/system</code>,修改<code>webhook.service</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Webhook receiver for GitHub</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/local/bin/webhook</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start nexus.service  #启动服务</span><br><span class="line">systemctl enable nexus.service #设置开机启动</span><br></pre></td></tr></table></figure>
<code>Loaded: loaded (/etc/systemd/system/webhook.service; enabled;</code>这个<code>enabled</code>就是开机启动的意思</li>
</ol>
<h2 id="查看服务的log"><a href="#查看服务的log" class="headerlink" title="查看服务的log"></a>查看服务的log</h2><p>journalctl - Query the systemd journal</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># root @ snode0 in /etc/systemd/system [17:57:48]</span><br><span class="line">$ journalctl -u webhook.service</span><br><span class="line">-- Logs begin at Mon 2022-06-06 15:54:50 CST, end at Tue 2022-06-28 17:57:50 CST. --</span><br><span class="line">Jun 28 17:30:53 snode0 systemd[1]: Started Webhook receiver for GitHub.</span><br></pre></td></tr></table></figure>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl reload webhook.service</span><br><span class="line">==== AUTHENTICATING FOR org.freedesktop.systemd1.manage-units ===</span><br><span class="line">Authentication is required to reload &#x27;webhook.service&#x27;.</span><br><span class="line">Multiple identities can be used for authentication:</span><br><span class="line"> 1.  Jun Shi (shijun)</span><br><span class="line"> 2.  Shaojie Tan (shaojiemike)</span><br><span class="line">Choose identity to authenticate as (1-2): 2</span><br><span class="line">Password:</span><br><span class="line">==== AUTHENTICATION COMPLETE ===</span><br><span class="line">Failed to reload webhook.service: Job type reload is not applicable for unit webhook.service.</span><br></pre></td></tr></table></figure>
<p>Simple 类型不能reload</p>
<h2 id="需要进一步的研究学习"><a href="#需要进一步的研究学习" class="headerlink" title="需要进一步的研究学习"></a>需要进一步的研究学习</h2><p>暂无</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>暂无</p>
<h2 id="开题缘由、总结、反思、吐槽"><a href="#开题缘由、总结、反思、吐槽" class="headerlink" title="开题缘由、总结、反思、吐槽~~"></a>开题缘由、总结、反思、吐槽~~</h2><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40741855/article/details/104984071">https://blog.csdn.net/qq_40741855/article/details/104984071</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html">https://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html</a></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/25/">Previous</a></div><div class="pagination-next"><a href="/page/27/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/25/">25</a></li><li><a class="pagination-link is-current" href="/page/26/">26</a></li><li><a class="pagination-link" href="/page/27/">27</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/43/">43</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://octodex.github.com/images/hula_loop_octodex03.gif" alt="Shaojie Tan"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Shaojie Tan</p><p class="is-size-6 is-block">𝘊𝘰𝘮𝘱𝘶𝘵𝘦𝘳 𝘈𝘳𝘤𝘩𝘪𝘵𝘦𝘤𝘵𝘶𝘳𝘦 &amp; 𝘏𝘗𝘊</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Anhui, Hefei, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">427</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">35</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">516</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Kirrito-k423" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Kirrito-k423"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Algorithms/"><span class="level-start"><span class="level-item">Algorithms</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/categories/Architecture/"><span class="level-start"><span class="level-item">Architecture</span></span><span class="level-end"><span class="level-item tag">41</span></span></a></li><li><a class="level is-mobile" href="/categories/Artificial-Intelligence/"><span class="level-start"><span class="level-item">Artificial Intelligence</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/categories/Camp/"><span class="level-start"><span class="level-item">Camp</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Databases/"><span class="level-start"><span class="level-item">Databases</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/HPC/"><span class="level-start"><span class="level-item">HPC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Math/"><span class="level-start"><span class="level-item">Math</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Network/"><span class="level-start"><span class="level-item">Network</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/OOW/"><span class="level-start"><span class="level-item">OOW</span></span><span class="level-end"><span class="level-item tag">28</span></span></a></li><li><a class="level is-mobile" href="/categories/Operating-system/"><span class="level-start"><span class="level-item">Operating system</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/Overview/"><span class="level-start"><span class="level-item">Overview</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/"><span class="level-start"><span class="level-item">Programming</span></span><span class="level-end"><span class="level-item tag">27</span></span></a></li><li><a class="level is-mobile" href="/categories/ProjectRecord/"><span class="level-start"><span class="level-item">ProjectRecord</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Software/"><span class="level-start"><span class="level-item">Software</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Thinking/"><span class="level-start"><span class="level-item">Thinking</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Tips/"><span class="level-start"><span class="level-item">Tips</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Treasure/"><span class="level-start"><span class="level-item">Treasure</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Tutorials/"><span class="level-start"><span class="level-item">Tutorials</span></span><span class="level-end"><span class="level-item tag">116</span></span></a></li><li><a class="level is-mobile" href="/categories/Values/"><span class="level-start"><span class="level-item">Values</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/architecture/"><span class="level-start"><span class="level-item">architecture</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/diary/"><span class="level-start"><span class="level-item">diary</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/english/"><span class="level-start"><span class="level-item">english</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/hardware/"><span class="level-start"><span class="level-item">hardware</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/love/"><span class="level-start"><span class="level-item">love</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/math/"><span class="level-start"><span class="level-item">math</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/network/"><span class="level-start"><span class="level-item">network</span></span><span class="level-end"><span class="level-item tag">19</span></span></a></li><li><a class="level is-mobile" href="/categories/operating-system/"><span class="level-start"><span class="level-item">operating system</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/programming/"><span class="level-start"><span class="level-item">programming</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/security/"><span class="level-start"><span class="level-item">security</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/software/"><span class="level-start"><span class="level-item">software</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li><li><a class="level is-mobile" href="/categories/thinking/"><span class="level-start"><span class="level-item">thinking</span></span><span class="level-end"><span class="level-item tag">9</span></span></a><ul><li><a class="level is-mobile" href="/categories/thinking/OOW/"><span class="level-start"><span class="level-item">OOW</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/tips/"><span class="level-start"><span class="level-item">tips</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/toLearn/"><span class="level-start"><span class="level-item">toLearn</span></span><span class="level-end"><span class="level-item tag">55</span></span></a></li><li><a class="level is-mobile" href="/categories/values/"><span class="level-start"><span class="level-item">values</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://ibug.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">ibugs</span></span><span class="level-right"><span class="level-item tag">ibug.io</span></span></a></li><li><a class="level is-mobile" href="https://jia.je/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">jiegec</span></span><span class="level-right"><span class="level-item tag">jia.je</span></span></a></li><li><a class="level is-mobile" href="https://leimao.github.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">leimao</span></span><span class="level-right"><span class="level-item tag">leimao.github.io</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-18T03:24:45.000Z">2024-10-18</time></p><p class="title"><a href="/2024/10/18/Work/software/perf/gperftools/">Gperftools</a></p><p class="categories"><a href="/categories/software/">software</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-11T03:04:55.000Z">2024-10-11</time></p><p class="title"><a href="/2024/10/11/Work/Programming/DebugProfile/DebugProfilePTA/">Debug/Profile/Devlop Tools of PTA</a></p><p class="categories"><a href="/categories/toLearn/">toLearn</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-09-22T09:19:48.000Z">2024-09-22</time></p><p class="title"><a href="/2024/09/22/Work/software/simulator/PC/VirtualBox/">VirtualBox</a></p><p class="categories"><a href="/categories/software/">software</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-09-13T07:08:55.000Z">2024-09-13</time></p><p class="title"><a href="/2024/09/13/Work/software/PC/macbook/">Macbook Config</a></p><p class="categories"><a href="/categories/software/">software</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-09-13T00:47:35.000Z">2024-09-13</time></p><p class="title"><a href="/2024/09/13/Work/Programming/2-languageGrammar/c/Types/">[C++ Basic] Types</a></p><p class="categories"><a href="/categories/toLearn/">toLearn</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/10/"><span class="level-start"><span class="level-item">October 2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/09/"><span class="level-start"><span class="level-item">September 2024</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/08/"><span class="level-start"><span class="level-item">August 2024</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/07/"><span class="level-start"><span class="level-item">July 2024</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/06/"><span class="level-start"><span class="level-item">June 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/05/"><span class="level-start"><span class="level-item">May 2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/04/"><span class="level-start"><span class="level-item">April 2024</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/03/"><span class="level-start"><span class="level-item">March 2024</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">February 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">January 2024</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/12/"><span class="level-start"><span class="level-item">December 2023</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/11/"><span class="level-start"><span class="level-item">November 2023</span></span><span class="level-end"><span class="level-item tag">33</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/10/"><span class="level-start"><span class="level-item">October 2023</span></span><span class="level-end"><span class="level-item tag">58</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/09/"><span class="level-start"><span class="level-item">September 2023</span></span><span class="level-end"><span class="level-item tag">37</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/08/"><span class="level-start"><span class="level-item">August 2023</span></span><span class="level-end"><span class="level-item tag">23</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/07/"><span class="level-start"><span class="level-item">July 2023</span></span><span class="level-end"><span class="level-item tag">24</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">June 2023</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/05/"><span class="level-start"><span class="level-item">May 2023</span></span><span class="level-end"><span class="level-item tag">19</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/04/"><span class="level-start"><span class="level-item">April 2023</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/03/"><span class="level-start"><span class="level-item">March 2023</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">February 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">January 2023</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/12/"><span class="level-start"><span class="level-item">December 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/11/"><span class="level-start"><span class="level-item">November 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">October 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/09/"><span class="level-start"><span class="level-item">September 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">August 2022</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">July 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">June 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">May 2022</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">April 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">March 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">February 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">January 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">December 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">November 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">October 2021</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">September 2021</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">August 2021</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">July 2021</span></span><span class="level-end"><span class="level-item tag">28</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/5G/"><span class="tag">5G</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/64bits-vs-32bits/"><span class="tag">64bits vs 32bits</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AI/"><span class="tag">AI</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AMAT/"><span class="tag">AMAT</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AMD/"><span class="tag">AMD</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ASPLOS/"><span class="tag">ASPLOS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ATI/"><span class="tag">ATI</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AVX/"><span class="tag">AVX</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Algorithm/"><span class="tag">Algorithm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Alpha/"><span class="tag">Alpha</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Analysis/"><span class="tag">Analysis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Apt/"><span class="tag">Apt</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Assembly/"><span class="tag">Assembly</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BFS/"><span class="tag">BFS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BHive/"><span class="tag">BHive</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BT/"><span class="tag">BT</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BTL/"><span class="tag">BTL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Baka-Mitai/"><span class="tag">Baka Mitai</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Bash/"><span class="tag">Bash</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Big-Endian/"><span class="tag">Big-Endian</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="SHAOJIE&#039;S BOOK" height="28"></a><p class="is-size-7"><span>&copy; 2024 Shaojie Tan</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Kirrito-k423/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>